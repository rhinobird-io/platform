<link rel="import" href="bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="bower_components/core-menu/core-menu.html">
<link rel="import" href="bower_components/core-list/core-list.html">
<link rel="import" href="bower_components/core-item/core-item.html">
<link rel="import" href="bower_components/core-ajax/core-ajax.html">
<link rel="import" href="bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="bower_components/core-scaffold/core-scaffold.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="bower_components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">
<link rel="import" href="elements/app-globals/app-globals.html">
<link rel="import" href="notification.html">
<link rel="import" href="elements/member-select/member-element.html">
<link rel="import" href="bower_components/core-style/core-style.html">
<link rel="import" href="bower_components/polymer-filters/polymer-filters.html">
<link rel="import" href="bower_components/paper-dropdown-menu/paper-dropdown-menu.html">

<core-style id="toolbar">
    .toolbar {
        background-color: {{g.theme.thirdBgColor}};
    }
    :host /deep/ core-toolbar {
        background-color: {{g.theme.mainBgColor}};
    }
    :host /deep/ #headerPanel {
        background-color: white;
    }
    :host /deep/ #drawer {
        z-index: 10;
    }
</core-style>
<polymer-element name="home-container" attributes="selected">
    <template>
        <core-style ref="toolbar"></core-style>
        <style>

            .content {
                padding:30px;
            }

            core-list {
                height: 200px;
            }
            .open-below {
                top: 38px;
            }
            .user-item {
                color: black;
            }
            paper-dropdown-menu /deep/ #label {
                background: transparent;
                color: white;
            }
            paper-dropdown-menu /deep/ #arrow {
                background: transparent;
                color: white;
            }
            paper-dropdown-menu {
                border-bottom: none;
            }
            .user-item /deep/ #scroller {
                max-width: none !important;
            }
            a.nostyle {
                color:inherit;
                text-decoration: none;
            }

            .title {
                position: absolute;
                top: 0;
                left: 64px;
                height: 64px;
                line-height: 64px;
            }

            .dropdown {
                right: 0px;
                bottom: 40px;
            }

            .dropdown /deep/ #scroller {
                height: auto !important;
                width: auto !important;
            }

            #userBar {
                cursor: pointer;
            }

            #userBar /deep/ span {
                font-size: 1rem !important;
            }

            #userMenu {
                position: absolute;
                right: 8px;
                top: 20px;
            }

            #sidebar {
                background-color: #FBFBFB;
            }

        </style>
        <core-scaffold responsiveWidth="1024px">
            <core-header-panel id="sidebar" navigation flex mode="seamed">
                <div vertical layout fit justified>
                    <div flex>
                        <core-toolbar class="toolbar"><paper-button on-tap="{{jumpToDashboard}}">Team Work</paper-button></core-toolbar>
                        <core-menu theme="core-light-theme" hidden?="{{$.globals.values.showSetting}}">
                            <core-item icon="dashboard" label="Dashboard" active?="{{selected == 'dashboard'}}"><a is="pushstate-anchor" href="./#/dashboard"></a></core-item>
                            <core-item icon="dashboard" label="InstantMessage" active?="{{selected == 'instantmessage'}}"><a is="pushstate-anchor" href="./#/instantmessage/channels/default"></a></core-item>
                            <core-item icon="event" label="Calendar" active?="{{selected == 'calendar'}}"><a is="pushstate-anchor" href="./#/calendar"></a></core-item>
                            <template repeat="{{plugin in $.globals.values.plugins}}">
                                <core-item icon="{{plugin.icon}}" label="{{plugin.label}}" active?="{{selected == plugin.active}}"><a is="pushstate-anchor" href="{{plugin.href}}"></a></core-item>
                            </template>
                        </core-menu>
                    </div>

                    <div>
                        <core-toolbar id="userBar" class="toolbar" on-click="{{toggleUserMenu}}">
                            <member-element userid="{{$.globals.values.currentUser.id}}" imagesize="36"></member-element>
                            <div id="userMenu">
                                <core-icon icon="expand-less" noink></core-icon>
                                <paper-dropdown id="userDropdownMenu" class="dropdown" halign="right" valign="bottom">
                                    <core-menu class="menu">
                                        <paper-item noink><a class="nostyle" href="./#/profile">Profile</a></paper-item>
                                        <paper-item noink><a class="nostyle" href="./#/team">Team</a></paper-item>
                                        <paper-item noink on-tap="{{logoutFunc}}">Logout</paper-item>
                                    </core-menu>
                                </paper-dropdown>
                            </div>
                        </core-toolbar>
                    </div>
                </div>
            </core-header-panel>
            <div tool flex horizontal layout center>
                <div flex>
                    <div class="title">
                        <content select=".title"></content>
                    </div>
                </div>
                <div horizontal end-justified layout>
                    <core-ajax
                            id="logoutAjax"
                            method="post"
                            contentType="application/json"
                            url="/platform/logout"
                            on-core-response="{{logoutCallback}}"></core-ajax>

                    <notification-element></notification-element>
                </div>
            </div>
            <content></content>
            <app-globals id="globals" on-current-user-ready="{{initCurrentUser}}"></app-globals>
        </core-scaffold>
    </template>
    <script>
        Polymer("home-container", {
            initCurrentUser : function() {
                this.userName = this.$.globals.values.currentUser.realname;
            },

            currentUserCallback: function(event, response) {
                this.$.globals.values.currentUser = JSON.parse(response.response);
                this.userName = this.$.globals.values.currentUser.realname;
            },

            logoutFunc: function() {
                this.$.logoutAjax.go();
            },

//            onUserSelect : function (event, detail, target){
//                if (detail.isSelected){
//                    this.$.globals.values.currentUser = detail.item.templateInstance.model;
//                }
//            },
//
//            onUserInfoSelect: function(event, detail, target) {
//                option = detail.item.textContent;
//
//                switch(option){
//                    case "Logout":
//                        this.$.logoutAjax.go();
//                        break;
//                    case "Profile":
//                    case "Team":
//                    case "Notification":
//                        if (!this.$.globals.values.menus) {
//                            this.buildNewSideMenu();
//                        }
//
//                        this.$.globals.values.showSetting = true;
//                        document.querySelector('app-router').go('/' + option.toLowerCase());
//                        break;
//                }
//            },

//            buildNewSideMenu: function() {
//                this.$.globals.values.menus = [];
//                this.$.globals.values.menus.push({"icon": "event", "label": "Profile", "active": "profile", "href":"/#/profile"});
//                this.$.globals.values.menus.push({"icon": "event", "label": "Team", "active": "team", "href":"/#/team"});
//            },

            logoutCallback: function() {
                window.location.href = "./login";
            },

            jumpToDashboard: function() {
                this.$.globals.values.showSetting = false;
                document.querySelector('app-router').go('/dashboard');
            },

            toggleUserMenu: function() {
                if (!this.userMenu) {
                    this.userMenu = this.shadowRoot.querySelector('#userDropdownMenu');
                }
                this.userMenu && this.userMenu.toggle();
            }
        });
    </script>
</polymer-element>
