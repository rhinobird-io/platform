<link rel="import" href="bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="bower_components/core-menu/core-menu.html">
<link rel="import" href="bower_components/core-list/core-list.html">
<link rel="import" href="bower_components/core-item/core-item.html">
<link rel="import" href="bower_components/core-ajax/core-ajax.html">
<link rel="import" href="bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="bower_components/core-scaffold/core-scaffold.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="bower_components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">
<link rel="import" href="elements/app-globals/app-globals.html">
<link rel="import" href="notification.html">

<polymer-element name="home-container" attributes="selected">
    <template>
        <style>
            .content {
                padding:30px;
            }

            core-list {
                height: 200px;
            }
            .open-below {
                top: 38px;
            }
            .user-item {
                color: black;
            }
            paper-dropdown-menu /deep/ #label {
                background: transparent;
                color: white;
            }
            paper-dropdown-menu /deep/ #arrow {
                background: transparent;
                color: white;
            }
            paper-dropdown-menu {
                border-bottom: none;
            }
            .userSignIn /deep/ .core-opened{
                left:auto !important;
                right: 0;
            }
            .user-item /deep/ #scroller {
                max-width: none !important;
            }


        </style>
        <core-scaffold>
            <core-header-panel navigation flex mode="seamed">
                <core-toolbar><core-icon icon="menu"></core-icon><paper-button on-tap="{{jumpToDashboard}}">Team Work</paper-button></core-toolbar>
                <core-menu theme="core-light-theme" hidden?="{{$.globals.values.showSetting}}">
                    <core-item icon="dashboard" label="Dashboard" active?="{{selected == 'dashboard'}}"><a is="pushstate-anchor" href="/#/dashboard"></a></core-item>
                    <core-item icon="event" label="Calendar" active?="{{selected == 'calendar'}}"><a is="pushstate-anchor" href="/#/calendar"></a></core-item>
                    <template repeat="{{plugin in $.globals.values.plugins}}">
                        <core-item icon="{{plugin.icon}}" label="{{plugin.label}}" active?="{{selected == plugin.active}}"><a is="pushstate-anchor" href="{{plugin.href}}"></a></core-item>
                    </template>
                </core-menu>
                <core-menu theme="core-light-theme" hidden?="{{!$.globals.values.showSetting}}">
                    <template repeat="{{menu in $.globals.values.menus}}">
                        <core-item icon="{{menu.icon}}" label="{{menu.label}}" active?="{{selected == menu.active}}"><a is="pushstate-anchor" href="{{menu.href}}"></a></core-item>
                    </template>
                </core-menu>
            </core-header-panel>
            <div tool>
                <content select=".title"></content>
            </div>
            <div tool horizontal layout center flex end-justified class="bottom">
                <core-ajax
                        auto='true'
                        method="GET"
                        url="/platform/users"
                        handleAs="json"
                        response="{{users}}"></core-ajax>

                <core-ajax
                        id="logoutAjax"
                        method="post"
                        contentType="application/json"
                        url="/platform/logout"
                        on-core-response="{{logoutCallback}}"></core-ajax>

                <core-ajax
                        id="currentUserAjax"
                        method="get"
                        contentType="application/json"
                        url="/platform/loggedOnUser"
                        on-core-response="{{currentUserCallback}}"
                        on-core-error="{{noUserCallback}}"></core-ajax>

                <div class="userSignIn">
                    <a href="/#/login" hidden?="{{$.globals.values.currentUser}}" style='padding-top: 20px'>Sign In</a>
                    <paper-menu-button hidden?="{{!$.globals.values.currentUser}}">
                        <label>{{$.globals.values.currentUser.name}}</label>
                        <paper-dropdown class="dropdown" halign="right" style="color:#000;" on-core-select="{{onUserInfoSelect}}">
                            <core-menu class="menu">
                                <paper-item>Profile</paper-item>
                                <paper-item>Team</paper-item>
                                <paper-item>Logout</paper-item>
                            </core-menu>
                        </paper-dropdown>
                    </paper-menu-button>
                </div>

                <notification-element></notification-element>

                <paper-menu-button>
                    <paper-icon-button icon="apps" noink></paper-icon-button>
                    <paper-dropdown class="dropdown" halign="right" style="color:#000;">
                        <core-menu class="menu">
                            <paper-input label="Search plugin"></paper-input>
                            <paper-item>Questionnaire</paper-item>
                            <paper-item>Brain Writing</paper-item>
                        </core-menu>
                    </paper-dropdown>
                </paper-menu-button>
            </div>
            <div fit class="content">
                <content></content>
            </div>
            <app-globals id="globals"></app-globals>
        </core-scaffold>
    </template>
    <script>
        Polymer("home-container", {
            ready : function() {

                if (this.$.globals.values.currentUser) {
                    this.userName = this.$.globals.values.currentUser.name;
                } else {
                    this.$.currentUserAjax.go();
                }
            },

            currentUserCallback: function(event, response) {
                this.$.globals.values.currentUser = JSON.parse(response.response);
                this.userName = this.$.globals.values.currentUser.name;
            },

            noUserCallback: function() {
                this.$.globals.values.currentUser = null;
                this.userName = "Sign In";
            },

            onUserSelect : function (event, detail, target){
                if (detail.isSelected){
                    this.$.globals.values.currentUser = detail.item.templateInstance.model;
                }
            },

            onUserInfoSelect: function(event, detail, target) {
                option = detail.item.textContent;

                switch(option){
                    case "Logout":
                        this.$.logoutAjax.go();
                        break;
                    case "Profile":
                    case "Team":
                    case "Notification":
                        if (!this.$.globals.values.menus) {
                            this.buildNewSideMenu();
                        }

                        this.$.globals.values.showSetting = true;
                        document.querySelector('app-router').go('/' + option.toLowerCase());
                        break;
                }
            },

            buildNewSideMenu: function() {
                this.$.globals.values.menus = [];
                this.$.globals.values.menus.push({"icon": "event", "label": "Profile", "active": "profile", "href":"/#/profile"});
                this.$.globals.values.menus.push({"icon": "event", "label": "Team", "active": "team", "href":"/#/team"});
            },

            logoutCallback: function() {
                document.querySelector('app-router').go('/login');
            },

            jumpToDashboard: function() {
                this.$.globals.values.showSetting = false;
                document.querySelector('app-router').go('/dashboard');
            }

//            newNotification: function() {
//                if (!Notification) {
//                    alert('Please use a modern version of Chrome');
//                    return;
//                }
//
//                if (Notification.permission !== "granted")
//                    Notification.requestPermission();
//
//                this.notificationFroms = [];
//                for (index in this.notifications) {
//                    this.notificationFroms.push(this.notifications[index].from_user_id);
//                }
//
//                this.notificationFromsJson = JSON.stringify(this.notificationFroms);
//                this.$.getGravatarForNotification.go();
//            },
//
//            avatarCallback: function() {
//                for (index in this.gravatars) {
//                    var notification = new Notification(this.gravatars[index].username, {
//                        icon: this.gravatars[index].url + "?d=identicon",
//                        body: this.notifications[index].content
//                    });
//
//                    setTimeout((function(notify) {
//                        return function() {
//                            notify.close();
//                        }
//                    })(notification), 5000);
//                }
//            }
        });
    </script>
</polymer-element>
