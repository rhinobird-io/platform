<link rel="import" href="bower_components/core-ajax/core-ajax.html">
<link rel="import" href="elements/app-globals/app-globals.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">
<link rel="import" href="bower_components/core-icons/core-icons.html">
<link rel="import" href="bower_components/paper-fab/paper-fab.html">
<link rel="import" href="bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="bower_components/core-pages/core-pages.html">
<core-style id="login">
    .container {
    padding: 1.5em;
        background-color: white;
    }
    .switch {
    color: {{g.theme.mainBgColor}};
    min-width: 0;
    margin: 0;
    }
    .bg {
        background-color: {{g.theme.thirdBgColor}};
    }
</core-style>

<polymer-element name="log-in">
    <template>
        <core-style ref="theme"></core-style>
        <core-style ref="login"></core-style>
        <style>
            #pages {
                margin-top: 150px;
                width: 400px;
                top: 0;
            }
        </style>
        <div vertical layout center fit class="bg">
            <core-ajax
                    id="getInvitationAjax"
                    method="get"
                    url="/platform/user/invitation/{{invitationId}}"
                    on-core-response="{{getInvitationResponse}}"></core-ajax>
            <div vertical layout center>
                <core-animated-pages selected="0" id="pages" transitions="hero-transition">
                    <section>
                        <core-ajax
                                id="signInAjax"
                                method="post"
                                contentType="application/json"
                                url="/platform/login"
                                body="{{userJson}}"
                                on-core-response="{{signInResponse}}"
                                on-core-error="{{showError}}"></core-ajax>
                        <paper-shadow class="container" layout vertical hero hero-id="1">
                            <h1 hero hero-id="2">Sign in</h1>
                            <paper-input-decorator id="loginEmail" label="Email" value="{{userInfo.email}}" error="Email is not an email" hero hero-id="email">
                                <input is="core-input" value="{{userInfo.email}}" pattern="^([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})$" required>
                            </paper-input-decorator>
                            <paper-input-decorator id="passwordIn" label="Password" value="{{userInfo.password}}" hero hero-id="password">
                                <input is="core-input" id="signInPassword" on-keypress="{{keyPressInPassword}}" value="{{userInfo.password}}" type="password">
                            </paper-input-decorator>
                            <div horizontal layout justified center>
                                <paper-button class="switch" on-tap="{{switch}}" hero hero-id="3">Sign Up</paper-button>
                                <div></div>
                                <paper-fab icon="done" id="signInBtn" on-tap="{{signIn}}" class="mainColor" hero
                                           hero-id="4"></paper-fab>
                            </div>
                        </paper-shadow>
                        <app-globals id="globals"></app-globals>
                        <paper-toast id="toastLoginFail" text="Login failed, please check your credential."
                                     role="status"
                                     touch-action="none" tabindex="-1" class="core-transition core-transition-bottom"
                                     style="position: fixed; outline: none; z-index: 12; box-sizing: border-box; display: none;"></paper-toast>
                    </section>
                    <section>
                        <core-ajax
                                id="signUpAjax"
                                method="post"
                                contentType="application/json"
                                body="{{userJson}}"
                                url="/platform/users"
                                on-core-response="{{signUpResponse}}"
                                on-core-error="{{signUpError}}"></core-ajax>
                        <core-ajax
                                id="validEmailAjax"
                                method="get"
                                url="/platform/user/valid_email/{{userInfo.email}}"
                                on-core-response="{{validEmailResponse}}"></core-ajax>
                        <core-ajax
                                id="validNameAjax"
                                method="get"
                                url="/platform/user/valid_name/{{userInfo.name}}"
                                on-core-response="{{validNameResponse}}"></core-ajax>
                        <paper-shadow class="container" layout vertical hero hero-id="1">
                            <h1 hero hero-id="2">Sign up</h1>
                            <paper-input-decorator id="email" label="Email" value="{{userInfo.email}}" hero hero-id="email">
                                <input is="core-input" value="{{userInfo.email}}" pattern="^([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})$" required>
                            </paper-input-decorator>
                            <paper-input-decorator id="name" label="User name" value="{{userInfo.name}}" hero hero-id="name">
                                <input is="core-input" value="{{userInfo.name}}" pattern="^[a-zA-z]\w*$" required>
                            </paper-input-decorator>
                            <paper-input id="realname" label="Real name (nick name)" value="{{userInfo.realname}}" hero
                                         hero-id="realname"></paper-input>
                            <paper-input-decorator id="password" label="Password" value="{{userInfo.password}}" hero hero-id="password">
                                <input is="core-input" value="{{userInfo.password}}" type="password">
                            </paper-input-decorator>
                            <paper-input-decorator id="confirmPassword" label="Confirm password" value="{{confirmPassword}}" error="Confirm password does not match" hero hero-id="confirmPassword">
                                <input is="core-input" id="signUpPassword" on-keypress="{{keyPressInPassword}}" value="{{confirmPassword}}" type="password">
                            </paper-input-decorator>
                            <div horizontal layout justified center>
                                <paper-button class="switch" on-tap="{{switch}}" hero hero-id="3">Sign In</paper-button>
                                <div></div>
                                <paper-fab icon="done" id="signUpBtn" on-tap="{{signUp}}" class="mainColor" hero
                                           hero-id="4"></paper-fab>
                            </div>
                        </paper-shadow>
                        <paper-toast id="toastSignUpSuccess" text="Account created." role="status" touch-action="none"
                                     tabindex="-1"
                                     class="core-transition core-transition-bottom"
                                     style="position: fixed; outline: none; z-index: 12; box-sizing: border-box; display: none;"></paper-toast>
                        <paper-toast id="toastSignUpFail" text="{{errMsg}}" duration="10000" role="status" touch-action="none"
                                     tabindex="-1"
                                     class="core-transition core-transition-bottom"
                                     style="position: fixed; outline: none; z-index: 12; box-sizing: border-box; display: none;"></paper-toast>
                    </section>
                </core-animated-pages>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            ready: function () {
                paramStr = window.location.search.substring(1);
                index = paramStr.indexOf("invitation=");

                this.userInfo = {};
                if (index == -1) {

                } else {
                    this.$.pages.selected = 1;
                    separatorIndex = paramStr.indexOf("&");
                    if (separatorIndex == -1) {
                        separatorIndex = paramStr.length - 1;
                    }
                    this.invitationId = paramStr.substr(index + 11, separatorIndex - index - 10);
                    this.$.getInvitationAjax.go();
                }

                this.emailTaken = false;
                this.nameTaken = false;
                thisElement = this;

                var emailValidateTimeout = null;
                this.$.email.addEventListener("keyup", function() {
                    that = this;
                    if (that.error == "Email address already taken") {
                        that.isInvalid = false;
                    }
                    if (emailValidateTimeout) {
                        clearTimeout(emailValidateTimeout);
                    }
                    emailValidateTimeout = setTimeout(function() {
                        that.error = "Email is not an email";
                        that.isInvalid = !that.input.checkValidity();
                        if (!that.isInvalid) {
                            thisElement.$.validEmailAjax.go();
                        }
                    }, 500);
                });

                var nameValidateTimeout = null;
                this.$.name.addEventListener("keyup", function() {
                    that = this;
                    if (that.error == "Username already taken") {
                        that.isInvalid = false;
                    }
                    if (nameValidateTimeout) {
                        clearTimeout(nameValidateTimeout);
                    }
                    nameValidateTimeout = setTimeout(function() {
                        that.error = "Name should start with a alphabet and only contain alphabet, number and underline";
                        that.isInvalid = !that.input.checkValidity();
                        if (!that.isInvalid) {
                            thisElement.$.validNameAjax.go();
                        }
                    }, 500);
                });

                var loginEmailValidateTimeout = null;
                this.$.loginEmail.addEventListener("keyup", function() {
                    that = this;
                    if (emailValidateTimeout) {
                        clearTimeout(emailValidateTimeout);
                    }
                    emailValidateTimeout = setTimeout(function() {
                        that.isInvalid = !that.input.checkValidity();
                    }, 500);
                });

                var confirmPasswordValidateTimeout = null;
                this.$.confirmPassword.addEventListener("keyup", function() {
                    that = this;
                    if (confirmPasswordValidateTimeout) {
                        clearTimeout(confirmPasswordValidateTimeout);
                    }
                    confirmPasswordValidateTimeout = setTimeout(function() {
                        that.isInvalid = that.input.value != thisElement.$.password.input.value;
                    }, 500);
                });
            },

            validEmailResponse: function(event, response) {
                  if (response.response == "inValid") {
                      this.$.email.error = "Email address already taken";
                      this.$.email.isInvalid = true;
                      this.emailTaken = true;
                  }
            },

            validNameResponse: function(event, response) {
                if (response.response == "inValid") {
                    this.$.name.error = "Username already taken";
                    this.$.name.isInvalid = true;
                    this.nameTaken = true;
                }
            },

            getInvitationResponse: function(event, response) {
                invitationData = JSON.parse(response.response);
                this.userInfo.email = invitationData.email;
                this.userInfo.initial_team_id = invitationData.initial_team_id;
            },
            keyPressInPassword: function (e) {
                if (e.keyCode == 13) {
                    if (e.target.id == "signInPassword") {
                        this.$.signInBtn.fire("tap");
                    } else {
                        this.$.signUpBtn.fire("tap");
                    }
                }
            },
            signIn: function () {
                if (this.$.loginEmail.input.checkValidity()) {
                    this.userJson = JSON.stringify(this.userInfo);
                    this.$.signInAjax.go();
                }
            }
            ,

            signInResponse: function (event, response) {
                user = JSON.parse(response.response);
                this.$.globals.values.currentUser = user;
                window.location.href = "/platform/#/";
            }
            ,

            showError: function () {
                this.$.toastLoginFail.show();
            }
            ,
            signUp: function () {

                if (!this.emailTaken && this.$.email.input.checkValidity()
                        && !this.nameTaken && this.$.name.input.checkValidity()) {
                    if (this.confirmPassword == this.userInfo.password) {
                        this.userJson = JSON.stringify(this.userInfo);
                        this.$.signUpAjax.go();
                    }
                }
            }
            ,

            signUpResponse: function () {
                this.$.toastSignUpSuccess.show();
                this.$.pages.selected = 0;
            }
            ,

            signUpError: function(event, detail) {
                this.errMsg = detail.response;
                this.$.toastSignUpFail.show();
            },
            switch: function () {
                this.$.pages.selected = this.$.pages.selected == "0" ? 1 : 0;
            }

        })
        ;
    </script>
</polymer-element>