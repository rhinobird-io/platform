<link rel="import" href="home-container.html">
<link rel="import" href="elements/app-globals/app-globals.html">
<link rel="import" href="bower_components/ajax-file-input/ajax-file-input.html">
<link rel="import" href="elements/member-select/member-select.html">

<polymer-element name="profile-page">
    <template>
        <style>
            .container {
                padding: 1em;
            }
        </style>
        <home-container selected="profile">
            <div class="title">Profile</div>
            <div class="container">
                <div vertical layout>
                    <div horizontal layout>
                        <div style="width:400px" vertical layout>
                            <core-ajax id="updateRealNameAjax"
                                       url="/platform/user/realname/{{currentUser.realname}}"
                                       method="post"></core-ajax>
                            <paper-input label="name" floatinglabel disabled value="{{currentUser.name}}"></paper-input>
                            <paper-input label="email" floatinglabel disabled value="{{currentUser.email}}"></paper-input>
                            <paper-input label="real name(nick name)" floatinglabel value="{{currentUser.realname}}"></paper-input>
                            <paper-button raised on-tap="{{changeRealName}}">Update</paper-button>
                        </div>
                        <div vertical layout style="width: 400px;margin-left: 100px">
                            <core-ajax id="inviteUserAjax"
                                       url="/platform/user/invite"
                                       method="post"
                                       contentType="application/json"
                                       body="{{newUserJson}}"></core-ajax>
                            <paper-input label="Email" floatinglabel value="{{userEmail}}"></paper-input>
                            <member-select id="initialTeam" label="Into Team" type="team" maxLen="1" ></member-select>
                            <paper-button raised on-tap="{{inviteNewMember}}">Invite New Member</paper-button>
                            <paper-toast id="toastInviteSuccess" text="Invitation has been sent to {{userEmail}}" role="status" touch-action="none"
                                         tabindex="-1"
                                         class="core-transition core-transition-bottom"
                                         style="position: fixed; outline: none; z-index: 12; box-sizing: border-box; display: none;"></paper-toast>
                        </div>
                    </div>

                    <div horizontal layout center style="margin-top: 100px">
                        <div vertical layout>
                            <label>Change Password</label>
                            <paper-input-decorator label="Password" floatinglabel value="{{originalPassword}}">
                                <input is="core-input" value="{{originalPassword}}" type="password">
                            </paper-input-decorator>
                            <paper-input-decorator label="New Password" floatinglabel value="{{newPassword}}">
                                <input is="core-input" value="{{newPassword}}" type="password">
                            </paper-input-decorator>
                            <paper-input-decorator label="Confirm New Password" floatinglabel value="{{confirmedPassword}}">
                                <input is="core-input" value="{{confirmedPassword}}" type="password">
                            </paper-input-decorator>
                            <core-ajax id="changePasswordAjax"
                                       url="/platform/user/password"
                                       method="post"
                                       contentType="application/json"
                                       body="{{newPasswordData}}"
                                       on-core-response="{{changePasswordSuccess}}"
                                       on-core-error="{{passwordErrorResponse}}"></core-ajax>
                            <paper-button raised on-tap="{{changePassword}}">Change</paper-button>
                            <paper-toast id="toastChangePassword" text="{{passwordMsg}}" role="status" touch-action="none"
                                         tabindex="-1"
                                         class="core-transition core-transition-bottom"
                                         style="position: fixed; outline: none; z-index: 12; box-sizing: border-box; display: none;"></paper-toast>
                        </div>
                        <div style="margin-left: 100px">
                            <div id="avatarAjaxDiv">
                                <template if="{{$.globals.values.currentUser}}">
                                    <core-ajax id="getGravatar"
                                               url="/platform/gravatar/id/{{$.globals.values.currentUser.id}}"
                                               handleAs="json"
                                               method="get"
                                               response="{{gravatar}}"
                                               on-core-response="{{gravatarResponse}}"></core-ajax>
                                </template>
                            </div>

                            <div horizontal layout center>
                                <template if="{{gravatar.local}}">
                                    <p>You can change your avatar here or remove the current avatar to revert to <a href="http://gravatar.com" rel="nofollow">gravatar.com</a></p>
                                </template>
                                <template if="{{!gravatar.local}}">
                                    <p>You can upload an avatar here or change it at <a href="http://gravatar.com" rel="nofollow">gravatar.com</a></p>
                                </template>
                                <ajax-file-input id="uploader" url="/platform/avatar" on-success="{{avatarUpload}}" style="margin-left: 10px"></ajax-file-input>

                            </div>
                            <div horizontal layout center>
                                <template if="{{gravatar.url}}">
                                    <img src="{{gravatar.url}}?d=identicon" style="margin: 20px" width="160" height="160"/>
                                </template>
                                <core-ajax id="removeLocalAvatarAjax"
                                           url="/platform/avatar/remove"
                                           method="post"
                                           on-core-response="{{avatarRemoved}}"></core-ajax>
                                <template if="{{gravatar.local}}">
                                    <paper-button raised on-tap="{{removeLocalAvatar}}">Remove</paper-button>
                                </template>
                            </div>

                        </div>
                    </div>

                </div>

            </div>

        </home-container>
        <app-globals id="globals"></app-globals>
    </template>
    <script>
        Polymer("profile-page", {

            ready: function() {
                this.currentUser = JSON.parse(JSON.stringify(this.$.globals.values.currentUser));

                if (!this.$.globals.values.memberCache[this.currentUser.id]) {
                    this.$.avatarAjaxDiv.querySelector("#getGravatar").go();
                } else {
                    this.gravatar = this.$.globals.values.memberCache[this.currentUser.id];
                }
            },

            changeRealName: function() {
                this.$.updateRealNameAjax.go();
                this.$.globals.values.currentUser = this.currentUser;
                this.$.globals.values.memberCache[this.currentUser.id].realname = this.currentUser.realname;
                this.$.globals.values.memberCache[this.currentUser.name].realname = this.currentUser.realname;
            },

            avatarUpload: function() {
                this.$.uploader.shadowRoot.querySelector("core-label").parentElement.parentElement.hidden = true;
                this.$.avatarAjaxDiv.querySelector("#getGravatar").go();
            },

            removeLocalAvatar: function() {
                this.$.removeLocalAvatarAjax.go();
            },

            avatarRemoved: function() {
                this.$.avatarAjaxDiv.querySelector("#getGravatar").go();
            },

            gravatarResponse: function() {
                this.$.globals.values.memberCache[this.gravatar.id] = this.gravatar;
                this.$.globals.values.memberCache[this.gravatar.name] = this.gravatar;
            },

            changePassword: function() {
                if (!this.originalPassword || !this.newPassword || !this.confirmedPassword ||
                        this.originalPassword == "" || this.newPassword == "" || this.confirmedPassword == "") {
                    this.passwordMsg = "Input password should not be null";
                    this.$.toastChangePassword.toggle();
                } else if (this.newPassword != this.confirmedPassword) {
                    this.passwordMsg = "New password and confirmed password does not match";
                    this.$.toastChangePassword.toggle();
                } else {
                    var newPasswordObj = {"password": this.originalPassword, "newPassword": this.newPassword};
                    this.newPasswordData = JSON.stringify(newPasswordObj);
                    this.$.changePasswordAjax.go();
                }
            },

            changePasswordSuccess: function() {
                this.passwordMsg = "Password successfully changed";
                this.$.toastChangePassword.toggle();
            },

            passwordErrorResponse: function() {
                this.passwordMsg = "Please input correct password for current user";
                this.$.toastChangePassword.toggle();
            },

            inviteNewMember: function() {
                this.newUser = {};
                this.newUser.email = this.userEmail;
                var selectedTeams = this.$.initialTeam.selected.teams;
                if (selectedTeams.length !== 0) {
                    this.newUser.initial_team_id = selectedTeams[0];
                }

                this.newUserJson = JSON.stringify(this.newUser);
                this.$.toastInviteSuccess.toggle();
                this.$.inviteUserAjax.go();
            }
        });
    </script>
</polymer-element>