<link rel="import" href="home-container.html">
<link rel="import" href="elements/app-globals/app-globals.html">
<link rel="import" href="bower_components/ajax-file-input/ajax-file-input.html">

<polymer-element name="profile-page">
    <template>
        <style>
            .container {
                padding: 1em;
            }
        </style>
        <home-container selected="profile">
            <div class="title">Profile</div>
            <div class="container">
                <div vertical layout>
                    <div horizontal layout center>
                        <div style="width:400px" vertical layout>
                            <paper-input label="name" floatinglabel disabled value="{{user.realname}}"></paper-input>
                            <paper-input label="email" floatinglabel disabled value="{{user.email}}"></paper-input>
                        </div>
                        <div vertical layout style="width: 400px;margin-left: 100px">
                            <core-ajax id="inviteUserAjax"
                                       url="/platform/user/invite"
                                       method="post"
                                       contentType="application/json"
                                       body="{{newUserJson}}"
                                       on-core-response="{{inviteSuccess}}"></core-ajax>
                            <paper-input label="Email" floatinglabel value="{{userEmail}}"></paper-input>
                            <paper-button raised on-tap="{{inviteNewMember}}">Invite New Member</paper-button>
                            <paper-toast id="toastInviteSuccess" text="Invitation has been sent to {{userEmail}}" role="status" touch-action="none"
                                         tabindex="-1"
                                         class="core-transition core-transition-bottom"
                                         style="position: fixed; outline: none; z-index: 12; box-sizing: border-box; display: none;"></paper-toast>
                        </div>
                    </div>

                    <div horizontal layout center style="margin-top: 100px">
                        <div>
                            <label>Change Password</label>
                            <paper-input-decorator label="Password" floatinglabel value="{{originalPassword}}">
                                <input is="core-input" value="{{originalPassword}}" type="password">
                            </paper-input-decorator>
                            <paper-input-decorator label="New Password" floatinglabel value="{{newPassword}}">
                                <input is="core-input" value="{{newPassword}}" type="password">
                            </paper-input-decorator>
                            <paper-input-decorator label="Confirm New Password" floatinglabel value="{{confirmedPassword}}">
                                <input is="core-input" value="{{confirmedPassword}}" type="password">
                            </paper-input-decorator>
                            <core-ajax id="changePasswordAjax"
                                       url="/platform/user/password"
                                       method="post"
                                       contentType="application/json"
                                       body="{{newPasswordData}}"
                                       on-core-response="{{changePasswordSuccess}}"
                                       on-core-error="{{passwordErrorResponse}}"></core-ajax>
                            <paper-button raised on-tap="{{changePassword}}">Save</paper-button>
                            <paper-toast id="toastChangePassword" text="{{passwordMsg}}" role="status" touch-action="none"
                                         tabindex="-1"
                                         class="core-transition core-transition-bottom"
                                         style="position: fixed; outline: none; z-index: 12; box-sizing: border-box; display: none;"></paper-toast>
                        </div>
                        <div style="margin-left: 100px">
                            <core-ajax id="getGravatar"
                                       auto
                                       url="/platform/gravatar/{{$.globals.values.currentUser.id}}"
                                       handleAs="json"
                                       method="get"
                                       response="{{gravatar}}"></core-ajax>
                            <div horizontal layout center>
                                <p>You can upload an avatar here or change it at <a href="http://gravatar.com" rel="nofollow">gravatar.com</a></p>
                                <ajax-file-input url="/platform/avatar" on-success="{{avatarUpload}}" style="margin-left: 10px"></ajax-file-input>
                            </div>
                            <img src="{{gravatar.url}}?d=identicon" style="margin: 20px"/>
                        </div>
                    </div>

                </div>

            </div>

        </home-container>
        <app-globals id="globals"></app-globals>
    </template>
    <script>
        Polymer("profile-page", {
            ready: function() {
                // clone the user object
                this.user = JSON.parse(JSON.stringify(this.$.globals.values.currentUser));
            },

            avatarUpload: function() {
                this.$.getGravatar.go();
            },

            changePassword: function() {
                if (!this.originalPassword || !this.newPassword || !this.confirmedPassword ||
                        this.originalPassword == "" || this.newPassword == "" || this.confirmedPassword == "") {
                    this.passwordMsg = "Input password should not be null";
                    this.$.toastChangePassword.toggle();
                } else if (this.newPassword != this.confirmedPassword) {
                    this.passwordMsg = "New password and confirmed password does not match";
                    this.$.toastChangePassword.toggle();
                } else {
                    var newPasswordObj = {"password": this.originalPassword, "newPassword": this.newPassword};
                    this.newPasswordData = JSON.stringify(newPasswordObj);
                    this.$.changePasswordAjax.go();
                }
            },

            changePasswordSuccess: function() {
                this.passwordMsg = "Password successfully changed";
                this.$.toastChangePassword.toggle();
            },

            passwordErrorResponse: function() {
                this.passwordMsg = "Please input correct password for current user";
                this.$.toastChangePassword.toggle();
            },
//            saveProfile: function() {
//                if (this.user.realname && this.user.email) {
//                    this.newUserData = JSON.stringify(this.user);
//                    this.$.updateUserAjax.go();
//                    this.$.globals.values.currentUser = this.user;
//                } else {
//                    alert("invalid input");
//                }
//            },

            inviteNewMember: function() {
                this.newUser = {};
                this.newUser.email = this.userEmail;
                this.newUserJson = JSON.stringify(this.newUser);
                console.log(this.newUserJson);
                this.$.inviteUserAjax.go();
            },

            inviteSuccess: function() {
                this.$.toastInviteSuccess.toggle();
            }
        });
    </script>
</polymer-element>