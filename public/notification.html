<link rel="import" href="bower_components/core-ajax/core-ajax.html">
<link rel="import" href="bower_components/core-ajax/core-xhr.html">
<link rel="import" href="bower_components/core-icon/core-icon.html">
<link rel="import" href="bower_components/core-icons/social-icons.html">
<link rel="import" href="bower_components/core-style/core-style.html">
<link rel="import" href="notification-record.html">

<polymer-element name="notification-element">
    <template>
        <core-style ref="theme"></core-style>
        <style>
            .count {
                position: absolute;
                border-radius: 50%;
                width: 8px;
                height: 8px;
                font-size: small;
                text-align: center;
                bottom: 40px;
                right: 26px;
            }
        </style>
        <template if="{{$.globals.values.currentUser}}">
            <core-ajax
                    auto
                    id="notificationAjax"
                    url="/platform/users/{{$.globals.values.currentUser.id}}/notifications/{{startIndex}}/{{limit}}"
                    handleAs="json"
                    response="{{moreNotifications}}"
                    on-core-response="{{moreNotificationLoaded}}"></core-ajax>
        </template>

        <paper-menu-button>
            <paper-icon-button icon="social:notifications"></paper-icon-button>
            <paper-dropdown id="notifyList" class="dropdown" halign="right" style="color:#000;width: 400px; max-height: 400px" on-core-overlay-open="{{checkNotifications}}" on-core-overlay-close-completed="{{markAsChecked}}">
                <core-menu class="menu" style="overflow-x:hidden">
                    <template repeat="{{notification in orderNotification(notifications)}}">
                        <paper-item on-tap="{{jumpToTargetUrl}}">
                            <notification-record notification="{{notification}}"></notification-record>
                        </paper-item>
                    </template>
                </core-menu>
            </paper-dropdown>
        </paper-menu-button>

        <template if="{{notifications && notifications.length != 0 && !notifications[0].checked}}">
            <div class="count accentColor"></div>
        </template>
        <app-globals id="globals"></app-globals>
    </template>
    <script>
        Polymer("notification-element", {

            created: function() {
                Document.prototype.createNotification = function(title, icon, body, url) {

                    var notification = new Notification(title, {
                        icon: icon,
                        body: body
                    });

                    notification.onclick = function() {
                        window.focus();
                        if (url) {
                            window.location.href = url;
                        }
                    };

                    setTimeout((function (notify) {
                        return function () {
                            notify.close();
                        }
                    })(notification), 5000);
                };

                var that = this;
                Document.prototype.showNotification = function(userId, body, url) {
                    if (!that.$.globals.values) {
                        console.error("app globals is not used, avatar cache can not be used");
                    } else {
                        if (that.$.globals.values.memberCache[userId]) {
                            document.createNotification(that.$.globals.values.memberCache[userId].username, that.$.globals.values.memberCache[userId].url + "?d=identicon", body, url);
                        } else {
                            xhr = new XMLHttpRequest();
                            xhr.onload = function () {
                                that.gravatars = JSON.parse(this.responseText);
                                that.$.globals.values.memberCache[userId] = that.gravatars[0];
                                document.createNotification(that.gravatars[0].username, that.gravatars[0].url + "?d=identicon", body, url);
                            };
                            xhr.open("GET", "/platform/gravatars?0=" + encodeURIComponent(that.notificationData.from_user_id), true);
                            xhr.send();
                        }
                    }
                }
            },

            ready: function () {
                this.startIndex = 0;
                this.limit = 10;
                this.nowLoading = false;
                this.notifications = [];
                if (!this.$.globals.values.websocket) {
                    this.$.globals.values.websocket = this.connect(this);
                }
            },

            domReady: function() {
                var scrollTimeout = null;
                that = this;
                this.$.notifyList.shadowRoot.querySelector("#scroller").addEventListener("scroll", function(event, detail, target) {
                    if (scrollTimeout) {
                        clearTimeout(scrollTimeout);
                    }
                    scrollTimeout = setTimeout(function(){
                        that.findLastCheckedNotification();
                    },500);

                    var scrollBottom = this.scrollTop + this.clientHeight;
                    var belowView = this.scrollHeight - scrollBottom;
                    if (belowView < this.clientHeight * 0.1 && !that.nowLoading && that.totalNotificationCount && that.startIndex + that.limit < that.totalNotificationCount) {
                        that.nowLoading = true;
                        that.startIndex += that.limit;
                    }
                });
            },

            moreNotificationLoaded: function() {
                this.totalNotificationCount = this.moreNotifications.total;
                this.notifications = this.notifications.concat(this.moreNotifications.notifications);
                this.nowLoading = false;
            },

            connect: function (that) {
                try {
                    var socket, host;
                    host = "ws://" + window.location.hostname + ":" + window.location.port + "/platform/";
                    socket = new WebSocket(host);

                    console.log("Socket State: " + socket.readyState);

                    socket.onopen = function () {
                        console.log("Socket Status: " + socket.readyState + " (open)");
                    };

                    socket.onclose = function () {
                        console.log("Socket Status: " + socket.readyState + " (closed)");
                        console.log("Reconnecting ...");
                        that.$.globals.values.websocket = that.connect(that);
                    };

                    socket.onmessage = function (msg) {
                        console.log("Received: " + msg.data);
                        that.notificationData = JSON.parse(msg.data);
                        that.handleNotification();
                    };

                    return socket;
                } catch (exception) {
                    console.log("Error: " + exception);
                }
            },

            handleNotification: function () {
                this.notifications.unshift(this.notificationData);
                document.showNotification(this.notificationData.from_user_id, this.notificationData.content);
            },

            orderNotification: function(notifications) {
                if (notifications) {
                    return notifications.sort(function(a,b) {
                        if (a.checked && !b.checked) {
                            return 1;
                        }

                        if (!a.checked && b.checked) {
                            return -1;
                        }

                        if (b.created_at > a.created_at) {
                            return 1;
                        }

                        if (b.created_at < a.created_at) {
                            return -1;
                        }

                        return 0;
                    });
                }

            },

            checkNotifications: function() {
                var that = this;
                setTimeout(function() {
                    that.notificationElements = that.$.notifyList.querySelectorAll("paper-item");
                    that.parentRect = that.$.notifyList.shadowRoot.querySelector("#scroller").getBoundingClientRect();
                    that.findLastCheckedNotification();
                }, 100);
            },

            findLastCheckedNotification: function() {
                if (!this.notifications || this.notifications[0].checked) {
                    return;
                }

                var lastNotificationIndexInView = this.findLastNotificationInView(0, this.notificationElements.length - 1);

                if (!this.maxCheckedNotificationIndex || (this.maxCheckedNotificationIndex < lastNotificationIndexInView)) {
                    this.maxCheckedNotificationIndex = lastNotificationIndexInView;
                }
            },

            markAsChecked: function() {
                if (!this.maxCheckedNotificationIndex || this.maxCheckedNotificationIndex == -1) {
                    return;
                }

                this.notificationIds = [];
                for (var index = 0; index <= this.maxCheckedNotificationIndex; index ++) {
                    var notification = this.notificationElements[index].querySelector("notification-record").notification;
                    this.notificationIds.push({"id": notification.id});
                    notification.checked = true;
                }

                this.notificationsJson = JSON.stringify(this.notificationIds);
                this.$.globals.values.websocket.send(this.notificationsJson);
                this.notifications = this.orderNotification(this.notifications);
                this.maxCheckedNotificationIndex = -1;
            },

            findLastNotificationInView: function(left, right) {

                if (left >= right) {
                    return left;
                }

                if (left + 1 == right) {
                    if (this.hasBeenScrolledToView(right)) {
                        return right;
                    } else {
                        return left;
                    }
                }

                var mid = Math.floor((left + right) / 2);

                if (this.hasBeenScrolledToView(mid)) {
                    return this.findLastNotificationInView(mid, right);
                } else {
                    return this.findLastNotificationInView(left, mid - 1);
                }
            },

            hasBeenScrolledToView: function(index) {
                var itemRect = this.notificationElements[index].querySelector("notification-record").shadowRoot.querySelector("member-element > #content").getBoundingClientRect();
                return (this.parentRect.bottom > itemRect.bottom);
            },

            jumpToTargetUrl: function(event, detail, target) {
                if (target.templateInstance.model.notification.url) {
                    window.location.href = target.templateInstance.model.notification.url;
                }
            }
        });
    </script>
</polymer-element>