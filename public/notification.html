<polymer-element name="notification-element">
    <template>
        <core-ajax
                auto
                id="notificationAjax"
                url="/platform/users/{{$.globals.values.currentUser.id}}/notifications"
                handleAs="json"
                response="{{notifications}}"
                on-core-response="{{newNotification}}"></core-ajax>

        <core-ajax id="getGravatarForNotification"
                   url="/platform/gravatar"
                   handleAs="json"
                   params="{{notificationFromsJson}}"
                   response="{{gravatars}}"
                   on-core-response="{{avatarCallback}}"></core-ajax>

        <paper-menu-button hidden?="{{!$.globals.values.currentUser}}">
            <label style="margin-left:10px;color: red">{{notifications.length}}</label>
            <paper-dropdown class="dropdown" halign="right" style="color:#000;">
                <core-menu class="menu">
                    <template repeat="{{notification in notifications}}">
                        <paper-item>
                            <div>
                                <member-element userid="{{notification.from_user_id}}"></member-element>
                                <p>{{notification.content}}</p>
                            </div>
                        </paper-item>
                    </template>
                </core-menu>
            </paper-dropdown>
        </paper-menu-button>
        <app-globals id="globals"></app-globals>
    </template>
    <script>
        Polymer("notification-element", {
            newNotification: function() {
                if (!Notification) {
                    alert('Please use a modern version of Chrome');
                    return;
                }

                if (Notification.permission !== "granted")
                    Notification.requestPermission();

                this.notificationFroms = [];
                for (index in this.notifications) {
                    this.notificationFroms.push(this.notifications[index].from_user_id);
                }

                this.notificationFromsJson = JSON.stringify(this.notificationFroms);
                this.$.getGravatarForNotification.go();
            },

            avatarCallback: function() {
                for (index in this.gravatars) {
                    var notification = new Notification(this.gravatars[index].username, {
                        icon: this.gravatars[index].url + "?d=identicon",
                        body: this.notifications[index].content
                    });

                    setTimeout((function(notify) {
                        return function() {
                            notify.close();
                        }
                    })(notification), 5000);
                }
            }
        });
    </script>
</polymer-element>