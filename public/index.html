<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <title>Team Work</title>
    <script src="bower_components/webcomponentsjs/webcomponents.min.js"></script>
    <link rel="import" href="bower_components/app-router/app-router.html">
    <link rel="import" href="bower_components/core-ajax/core-ajax.html">
    <link rel="import" href="elements/app-globals/app-globals.html">
</head>
<body unresolved>
<polymer-element name="page-ajax">
    <template>
        <app-globals id="globals"></app-globals>
        <core-ajax
                id="pageAjax"
                auto
                method="get"
                contentType="application/json"
                url="/developer/plugins"
                on-core-response="{{pageResponse}}"></core-ajax>
    </template>
    <script>
        Polymer("page-ajax", {
            pageResponse : function(event, response) {

                var plugins = JSON.parse(response.response);

                var router = document.querySelector("app-router");
                var element = document.createElement("app-route");

                this.$.globals.values.plugins = [];

                for (index in plugins) {

                    var newPlugin = {};
                    newPlugin.icon = "event";
                    newPlugin.label = plugins[index].name;
                    newPlugin.active = plugins[index].name;
                    newPlugin.href = "/#/" + plugins[index].name;
                    this.$.globals.values.plugins.push(newPlugin);

                    element = document.createElement("app-route");
                    element.setAttribute("path", "/" + plugins[index].name);
                    element.setAttribute("import", "/plugins/" + plugins[index].name + "/" + plugins[index].name + "-plugin.html");
                    console.log(router.lastElementChild);
                    router.insertBefore(element, router.lastElementChild);
                }

                element = document.createElement("app-route");
                element.setAttribute("path", "*");
                element.setAttribute("import", "/not-found.html");
                element.setAttribute("template", "");
                router.insertBefore(element, router.lastElementChild);
            }
        })
    </script>
</polymer-element>
<page-ajax></page-ajax>
<app-router>
    <app-route path="/dashboard" import="/plugins/dashboard/dashboard-plugin.html"></app-route>
    <app-route path="/calendar" import="/plugins/calendar/calendar-plugin.html"></app-route>
    <app-route path="/" redirect="/dashboard"></app-route>
</app-router>

<script>
    window.onload = function() {
        var router = document.querySelector("app-router");

        if(!router.activeRoute) {
            router.go(window.location.hash.substring(1));
        }
    }
</script>
</body>
</html>