<script src="../../bower_components/highlightjs/highlight.pack.js"></script>

<polymer-element name="smart-display" attributes="value">
    <template>
        <link rel="stylesheet" href="../../bower_components/highlightjs/styles/default.css">
        <div>
            <html-echo html="{{wrap(value)}}"></html-echo>
        </div>
    </template>
    <script>
        Polymer({
            enableAt: true,
            enableSlash: true,
            enableCode: true,
            enableLink: true,

            slashTrigger: function(text, plugin, args) {
                if (args == undefined) args = "";
                if (plugin == "vity") {
                    var link = document.createElement("a");
                    link.href = "https://46.137.243.49:5151/index.html#" + args;
                    link.target = "_blank";
                    link.innerHTML = text;
                    return link;
                } else {
                    // TODO Design the format
                    var link = document.createElement("a");
                    link.href = "/" + plugin + "/cmd/" + args.replace(",", "/");
                    link.innerHTML = text;
                    return link;
                }
            },

            wrap: function (value) {
                if (!value) return "";
                var root = document.createElement("span");
                if (this.enableCode) {
                    // Preserve and remove code blocks
                    root.innerHTML = value.replace(/```(.*)\n(((?!```\n)[\s\S])*)```/g,
                            "<pre><code class='$1'>$2</code></pre>");
                    var codeBlocks = [];
                    var list = root.querySelectorAll("pre code");
                    for (var i = 0; i < list.length; i++) {
                        codeBlocks.push(list[i].innerHTML);
                        list[i].innerHTML = "";
                    }
                    value = root.innerHTML;
                }
                if (this.enableAt) {
                    root.innerHTML = value.replace(/(^|\s)(@[\w\.-]+)/g, "$1<at>$2</at>");
                    var list = root.querySelectorAll("at");
                    for (var i = 0; i < list.length; i++) {
                        var name = list[i].innerHTML;
                        var profile = document.createElement("span");
                        profile.innerHTML =
                                "<member-profile userid=31>" +  // TODO Replace userid
                                "<a class='trigger' href='#'>" + name + "</a>" +
                                "</member-profile>";
                        root.replaceChild(profile, list[i]);
                    }
                    value = root.innerHTML;
                }
                if (this.enableSlash) {
                    var regex = /(^|\s)(\/([\w\.-]+)(:(\S+))?)/g;
                    root.innerHTML = value.replace(regex, "$1<slash>$2</slash>");
                    var list = root.querySelectorAll("slash");
                    for (var i = 0; i < list.length; i++) {
                        var text = list[i].innerHTML;
                        var res = regex.exec(text);
                        root.replaceChild(this.slashTrigger(text, res[3], res[5]), list[i]);
                        regex.lastIndex = 0;
                    }
                    value = root.innerHTML;
                }
                if (this.enableLink) {
                    // Replace links and emails
                    value = value.replace(/(^|\s)((http|ftp)s?:\/\/\S+)/gi,
                            "$1<a href='$2' target='_blank'>$2</a>");
                    value = value.replace(/((?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\]))/g,
                            "<a href='mailto:$1'>$1</a>");
                }
                if (this.enableCode) {
                    // Re-insert code blocks
                    root.innerHTML = value;
                    var list = root.querySelectorAll("pre code");
                    for (var i = 0; i < list.length; i++) {
                        var code = codeBlocks[i];
                        list[i].innerHTML = code;
				        hljs.highlightBlock(list[i]);
                    }
                    value = root.innerHTML;
                }
                return value;
            }
        });
    </script>
</polymer-element>
