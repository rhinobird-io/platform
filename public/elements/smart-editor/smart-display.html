<link rel="import" href="../app-globals/app-globals.html">
<link rel="import" href="../html-echo/html-echo.html">
<link rel="import" href="../file-display/file-display.html">

<script src="../../bower_components/highlightjs/highlight.pack.js"></script>
<script src="../../bower_components/sprintf/dist/sprintf.min.js"></script>
<script src="../../bower_components/marked/marked.min.js"></script>

<polymer-element name="smart-display" attributes="value">
    <template>
        <style>
            .container {
                white-space: pre-wrap;
                word-wrap: break-word;
            }
            .container p {
                -webkit-margin-before: 0em;
                -webkit-margin-after: 0em;
            }
            .container blockquote {
                -webkit-margin-start: 0em;
                -webkit-margin-end: 0em;
                border-left: 0.5em solid rgba(0,0,0,0.12);
                color: rgba(0,0,0,0.54);
                padding: 1em;
            }
        </style>

        <app-globals id="globals"></app-globals>
        <link rel="stylesheet" href="../../bower_components/highlightjs/styles/default.css">
        <template if="{{readyDom}}">
            <html-echo html="{{wrap(value)}}" class="container"></html-echo>
        </template>
        <template if="{{!readyDom}}">
            <div class="container">{{value}}</div>
        </template>
    </template>

    <script>
        function stripTags(value) {
            return value.replace(/&/g, "&amp;").replace(/</g, "&lt;");
        }

        Polymer('smart-display', {
            enableAt: true,
            enableSlash: true,
            enableCode: true,
            enableLink: true,

            domReady: function () {
                this.readyDom = true;
            },

            slashTrigger: function (text, plugin, args) {
                if (args == undefined) args = "";
                if (plugin.toLowerCase() == "vity") {
                    var link = document.createElement("a");
                    var user = this.$.globals.values.currentUser;
                    link.href = "https://46.137.243.49:5151/index.html#" + args + "@" + user.name;
                    link.target = "_blank";
                    link.innerHTML = text;
                    return link;
                } else if (plugin.toLowerCase() == "file") {
                    var display = document.createElement("file-display");
                    display.setAttribute("fileid", args);
                    return display;
                } else {
                    var link = document.createElement("a");
                    link.href = "/" + plugin + "/cmd/" + args;
                    link.innerHTML = text;
                    return link;
                }
            },

            wrap: function (value) {
                if (!value) return "";
                value = stripTags(value);
                var root = document.createElement("span");
                if (this.enableCode) {
                    // Preserve and remove code blocks
                    var regex = /```(.*)\n(((?!```\n)[\s\S])*)```/g;
                    var codeBlocks = value.match(regex);
                    value = value.replace(regex, "<pre><code class='$1'></code></pre>");
                }
                value = value.replace(/(<\/pre>)\n?\n/g, "$1");
                if (this.enableAt) {
                    root.innerHTML = value.replace(/(^|\s)(@\w+)/g, "$1<at>$2</at>");
                    var list = root.querySelectorAll("at");
                    for (var i = 0; i < list.length; i++) {
                        var name = list[i].innerHTML;
                        var profile = document.createElement("span");
                        var user = this.$.globals.values.memberCacheName[name.substr(1)]
                        if (user) {
                            profile.innerHTML = sprintf('<a target="_blank" href="#/member/%s">@%s</a>', user.id, user.name);
                        } else {
                            profile.innerHTML = name;
                        }
                        root.replaceChild(profile, list[i]);
                    }
                    value = root.innerHTML;
                }
                if (this.enableSlash) {
                    var regex = /(^|\s)(\/([\w\.-]+)(:(\S+))?)/g;
                    root.innerHTML = value.replace(regex, "$1<slash>$2</slash>");
                    var list = root.querySelectorAll("slash");
                    for (var i = 0; i < list.length; i++) {
                        var text = list[i].innerHTML;
                        var res = regex.exec(text);
                        root.replaceChild(this.slashTrigger(text, res[3], res[5]), list[i]);
                        regex.lastIndex = 0;
                    }
                    value = root.innerHTML;
                }
                if (this.enableCode) {
                    // Re-insert code blocks
                    root.innerHTML = value;
                    var list = root.querySelectorAll("pre code");
                    for (var i = 0; i < list.length; i++) {
                        var code = codeBlocks[i];
                        list[i].innerHTML = code.substring(code.indexOf("\n") + 1, code.length - 3);
                        hljs.highlightBlock(list[i]);
                    }
                    value = root.innerHTML;
                }
                value = this.markdown(value);
                if (this.enableLink) {
                    // Replace links and emails
                    value = value.replace(/(^|\s)((http|ftp)s?:\/\/\S+)/gi,
                            "$1<a href='$2' target='_blank'>$2</a>");
                    value = value.replace(EMAIL_REGEX, "$1<a href='mailto:$2'>$2</a>");
                }
                return value;
            },

            markdown: function(value) {
                value = value.replace(/&gt;/g, ">").replace(/\n(\n+)\n([^\n])/g, "\n\n<brs>$1</brs>\n\n$2");
                value = marked(value);
                return value.replace(/\n<brs>(\n+)<\/brs>\n\n</g, "$1\n<")
                    .replace(/\n<brs>(\n+)<\/brs>\n\n/g, "\n$1\n")
                    .replace(/\n?(<(li|ul|ol|blockquote|(h\d\ .*))>)\n?/g, "$1")
                    .replace(/\n?(<\/(li|ul|ol|blockquote)>)\n?/g, "$1");
            }
        });

        var EMAIL_REGEX = /(^|\s)((?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\]))/g;

    </script>
</polymer-element>
