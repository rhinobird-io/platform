<link rel="import" href="../app-globals/app-globals.html">
<link rel="import" href="../html-echo/html-echo.html">
<script src="../../bower_components/highlightjs/highlight.pack.js"></script>

<polymer-element name="smart-display" attributes="value">
    <template>
        <style>
            .container {
                white-space: pre-wrap;
                word-wrap: break-word;
            }
        </style>
        <app-globals id="globals"></app-globals>
        <link rel="stylesheet" href="../../bower_components/highlightjs/styles/default.css">
        <template if="{{readyDom}}">
            <div>
                <html-echo html="{{wrap(value)}}" class="container"></html-echo>
            </div>
        </template>
        <template if="{{!readyDom}}">
            <div class="container">{{value}}</div>
        </template>
    </template>

    <script>
        function stripTags(value) {
            return value.replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
        }

        Polymer('smart-display', {
            enableAt: true,
            enableSlash: true,
            enableCode: true,
            enableLink: true,

            domReady: function(){
                this.readyDom = true;
            },
            slashTrigger: function(text, plugin, args) {
                if (args == undefined) args = "";
                if (plugin.toLowerCase() == "vity") {
                    var link = document.createElement("a");
                    var user = this.$.globals.values.currentUser;
                    link.href = "https://46.137.243.49:5151/index.html#" + args + "@" + user.name;
                    link.target = "_blank";
                    link.innerHTML = text;
                    return link;
                } else {
                    // TODO Design the format
                    var link = document.createElement("a");
                    link.href = "/" + plugin + "/cmd/" + args.replace(",", "/");
                    link.innerHTML = text;
                    return link;
                }
            },

            wrap: function(value) {
                if (!value) return "";
                value = stripTags(value);
                var root = document.createElement("span");
                if (this.enableCode) {
                    // Preserve and remove code blocks
                    var regex = /```(.*)\n(((?!```\n)[\s\S])*)```/g;
                    var codeBlocks = value.match(regex);
                    value = value.replace(regex, "<pre><code class='$1'></code></pre>");
                }
                // Replace newline with <br>
                value = value.replace(/(<\/(div|pre)>)\n/g, "$1")
                    .replace(/\n/g, "\n<br>\n").replace(/(<\/(div|pre)>)/g, "$1\n");
                if (this.enableAt) {
                    root.innerHTML = value.replace(/(^|\s)(@[\w\.-]+)/g, "$1<at>$2</at>");
                    var list = root.querySelectorAll("at");
                    for (var i = 0; i < list.length; i++) {
                        var name = list[i].innerHTML;
                        var profile = document.createElement("span");
                        if (this.$.globals.values.memberCache[name.substr(1)]) {
                            profile.innerHTML =
                                "<member-profile username='" + name.substr(1) +
                                "'><a class='trigger' href='#'>" + name + "</a>" +
                                "</member-profile>";
                        } else {
                            profile.innerHTML = name;
                        }
                        root.replaceChild(profile, list[i]);
                    }
                    value = root.innerHTML;
                }
                if (this.enableSlash) {
                    var regex = /(^|\s)(\/([\w\.-]+)(:(\S+))?)/g;
                    root.innerHTML = value.replace(regex, "$1<slash>$2</slash>");
                    var list = root.querySelectorAll("slash");
                    for (var i = 0; i < list.length; i++) {
                        var text = list[i].innerHTML;
                        var res = regex.exec(text);
                        root.replaceChild(this.slashTrigger(text, res[3], res[5]), list[i]);
                        regex.lastIndex = 0;
                    }
                    value = root.innerHTML;
                }
                if (this.enableLink) {
                    // Replace links and emails
                    value = value.replace(/(^|\s)((http|ftp)s?:\/\/\S+)/gi,
                        "$1<a href='$2' target='_blank'>$2</a>");
                    value = value.replace(EMAIL_REGEX, "<a href='mailto:$1'>$1</a>");
                }
                if (this.enableCode) {
                    // Re-insert code blocks
                    root.innerHTML = value;
                    var list = root.querySelectorAll("pre code");
                    for (var i = 0; i < list.length; i++) {
                        var code = codeBlocks[i];
                        list[i].innerHTML = code.substring(code.indexOf("\n") + 1, code.length - 3);
                        hljs.highlightBlock(list[i]);
                    }
                    value = root.innerHTML;
                }
                return value;
            }
        });

        var EMAIL_REGEX = /((?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\]))/g;

    </script>
</polymer-element>
