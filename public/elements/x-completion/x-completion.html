<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../../bower_components/core-selector/core-selector.html">

<polymer-element name="x-completion" extends="core-selector" attributes="controller controllerKeydownHandler" hidden on-core-activate="{{itemSelected}}">
    <template>
        <style>
            ::content > .core-selected {
                background-color: blue;
                color: white;
            }
        </style>
        <paper-shadow z="1">
            <shadow></shadow>
        </paper-shadow>
    </template>
    <script>
        (function () {
            var self;
            var listener = function(event){
                console.log("inner");
                if (event.keyCode === 38 || event.keyCode === 40) { // up down keys
                    event.preventDefault();
                    if (event.keyCode === 38) {
                        self.selectPrevious(true);
                    } else {
                        self.selectNext(true);
                    }
                } else if (event.keyCode === 13) {
                    event.preventDefault();
                    self.fire('core-activate', {item: self.selectedItem});
                } else if (event.keyCode == 27) {   // escape key
                    event.preventDefault();
                    self.active = false;
                }
            };
            Polymer({
                selected: 0,
                active: false,
                observe: {
                    'controller': 'initialize',
                    'active': 'toggleActive'
                },
                itemSelected: function(event, detail){
                    self.active = false;
                    this.fire('select', {item: detail.item.templateInstance.model});
                },
                toggleActive: function (oldValue, newValue) {
                    if (newValue) {
                        this.removeAttribute('hidden');
                        this.controller.removeEventListener("keydown", this.controllerKeydownHandler);
                        self = this;
                        this.controller.addEventListener("keydown", listener);
                        this.controller.addEventListener("keydown", this.controllerKeydownHandler);
                    } else {
                        this.controller.removeEventListener("keydown", listener);
                        this.setAttribute('hidden', true);
                    }
                },
                initialize: function () {
                    this.controller.addEventListener("keydown", this.controllerKeydownHandler);
                }
            });
        })();
    </script>
</polymer-element>