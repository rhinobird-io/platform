<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../../bower_components/core-selector/core-selector.html">
<link rel="import" href="../../bower_components/core-style/core-style.html">

<core-style id="completion">
    ::content > .core-selected {
    background-color: {{g.theme.accentBgColor}};
    color: {{g.theme.accentColor}};
    }
    ::content > * {
    cursor: pointer;
    }
    paper-shadow {
    background-color: {{g.theme.thirdBgColor}};
    color: {{g.theme.thirdColor}};
    overflow: auto;
    }
    .container {
    margin: 0.5em;
    }
</core-style>
<polymer-element name="x-completion" extends="core-selector" attributes="controller controllerKeydownHandler" hidden
                 on-core-activate="{{itemSelected}}">
    <template>
        <core-style ref="completion">
        </core-style>
        <paper-shadow z="1">
            <div on-mouseover="{{mouseover}}" class="container">
                <shadow></shadow>
            </div>
        </paper-shadow>
    </template>
    <script>
        (function () {
            var listener = function (self) {
                return function (event) {
                    if (self.active) {
                        if (event.keyCode === 38 || event.keyCode === 40) { // up down keys
                            event.preventDefault();
                            if (event.keyCode === 38) {
                                self.selectPrevious(true);
                            } else {
                                self.selectNext(true);
                            }
                            return false;
                        } else if (event.keyCode === 13) {
                            event.preventDefault();
                            self.fire('core-activate', {item: self.selectedItem});
                            return false;
                        } else if (event.keyCode == 27) {   // escape key
                            event.preventDefault();
                            self.active = false;
                            return false;
                        }
                    }
                    if (self.controllerKeydownHandler) {
                        var root = self, host;
                        while (root.parentNode) {
                            root = root.parentNode;
                        }
                        host = root.host;
                        self.controllerKeydownHandler.call(host, event, undefined, event.target);
                    }
                }
            };

            Polymer({
                selected: 0,
                active: false,
                observe: {
                    'controller': 'initialize',
                    'active': 'toggleActive',
                    'controllerKeydownHandler': 'changeHandler'
                },
                itemSelected: function (event, detail) {
                    this.active = false;
                    this.fire('select', {item: detail.item.templateInstance.model});
                },
                toggleActive: function (oldValue, newValue) {
                    if (newValue) {
                        this.removeAttribute('hidden');
                    } else {
                        this.setAttribute('hidden', true);
                    }
                },
                initialize: function () {
                    this.setAttribute('hidden', true);
                    this.controller.addEventListener("keydown", listener(this));
                },
                mouseover: function (event) {
                    var root = this;
                    //Find the parent Shadow Root
                    while (root.parentNode) {
                        root = root.parentNode;
                    }
                    var element = root.elementFromPoint(event.clientX, event.clientY);
                    //Find the first-level child
                    while (element.parentNode != this) {
                        element = element.parentNode;
                    }
                    this.selected = this.items.indexOf(element);
                }
            });
        })();
    </script>
</polymer-element>