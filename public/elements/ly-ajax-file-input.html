<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-label/core-label.html">
<link rel="import" href="../bower_components/core-icons/core-icons.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">

<polymer-element name="ly-ajax-file-input">
  <template>
    <style type="text/css">
      paper-fab.blue {
        background: #5677fc;
      }

      ul {
        display: inline-block;
        list-style-type: none;
      }

      [invisible] {
        visibility: hidden;
      }
    </style>
    <!--noink because OS X file upload dialog animation makes ink animation stuck-->
    <paper-fab mini noink icon="file-upload" class="blue" on-click="{{onClick}}"></paper-fab>
    <ul>
      <li><core-label>{{fileName}}</core-label></li>
      <li invisible?={{progressInvisible}}><paper-progress value="{{progress}}"></paper-progress></li>
    </ul>
    <input type="file" id="fileInput" on-change="{{fileChange}}" hidden>
  </template>
  <script>
    Polymer({
      progressInvisible: true,
      onClick: function(){
        var elem = this.$.fileInput;
        if(elem && document.createEvent) { // sanity check
          var evt = document.createEvent("MouseEvents");
          evt.initEvent("click", true, false);
          elem.dispatchEvent(evt);
        }
      },
      fileChange: function(e) {
        this.progressInvisible = true;
        this.progress = undefined;
        var file = e.target.files[0];
        if(!file){
          this.fileName = "";
        } else{
          var self = this;
          this.fileName = file.name;
          var formData = new FormData();
          formData.append("file", file);

          var xhr = new XMLHttpRequest();
          xhr.upload.addEventListener('progress', function(e){
            var done = e.loaded, total = e.total;
            self.progress = Math.floor(done/total*1000)/10;
          });
          xhr.open('POST', "/upload", true);

          this.progressInvisible = false;
          xhr.send(formData);
        }
      }
    });
  </script>
</polymer-element>

