<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">

<polymer-element name="app-globals" attributes="values">
    <template>

        <core-ajax id="getGravatar"
                   url="/platform/gravatar/{{keyType}}/{{keyValue}}"
                   handleAs="json"
                   on-core-response="{{handleResponse}}"></core-ajax>

        <core-ajax id="getTeam"
                   url="/platform/teams/{{teamId}}"
                   handleAs="json"
                   on-core-response="{{handleTeamResponse}}"></core-ajax>
    </template>
    <script>
        (function() {
            var values = {};

            values["memberCacheId"] = {};
            values["memberCacheName"] = {};
            xhr = new XMLHttpRequest();
            xhr.onload = function(){
                var result = JSON.parse(this.responseText);
                for(var i=0; i<result.length; i++) {
                    values["memberCacheId"][result[i].id] = result[i];
                    values["memberCacheName"][result[i].name] = result[i];
                }
            };
            xhr.open("GET", "/platform/gravatars/all", true);
            xhr.send();

            xhr = new XMLHttpRequest();
            xhr.onload = function(){
                values["currentUser"] = JSON.parse(this.responseText);
            };
            xhr.open("GET", "/platform/loggedOnUser", true);
            xhr.send();

            values["teamCache"] = {};
            xhr = new XMLHttpRequest();
            xhr.onload = function(){
                var result = JSON.parse(this.responseText);
                for(var i=0; i<result.length; i++) {
                    values["teamCache"][result[i].id] = result[i];
                }
            };
            xhr.open("GET", "/platform/teams", true);
            xhr.send();

            Polymer({
                ready: function() {
                    this.values = values;
                    for (var i = 0; i < this.attributes.length; ++i) {
                        var attr = this.attributes[i];
                        values[attr.nodeName] = attr.value;
                    }
                },

                getGravatarById: function(userid) {
                    if (!this.values["memberCacheId"][userid]) {
                        this.keyType = "id";
                        this.keyValue = userid;
                        this.$.getGravatar.go();
                    } else {
                        this.fire("gravatar-ready");
                    }
                },

                getGravatarByName: function(username) {
                    if (!this.values["memberCacheName"][username]) {
                        this.keyType = "name";
                        this.keyValue = username;
                        this.$.getGravatar.go();
                    } else {
                        this.fire("gravatar-ready");
                    }
                },

                handleResponse: function (event, detail, target) {
                    var gravatar = detail.response;
                    this.values["memberCacheId"][gravatar.id] = gravatar;
                    this.values["memberCacheName"][gravatar.name] = gravatar;
                    this.fire("gravatar-ready");
                },

                getTeamById: function(teamid) {
                    if (!this.values["teamCache"][teamid]) {
                        this.teamId = teamid;
                        this.$.getTeam.go();
                    } else {
                        this.fire("team-ready");
                    }
                },

                handleTeamResponse: function(event, detail, target) {
                    var team = detail.response;
                    this.values["teamCache"][team.id] = team;
                    this.fire("team-ready");
                }
            });
        })();
    </script>
</polymer-element>