<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="display-default-message.html">
<link rel="import" href="event-image.html">
<link rel="import" href="event-video.html">
<polymer-element name="display-url-message" extends="display-default-message" attributes="url disableLoadedEvent">

<template>
	<style>
		.attachment_service_name {
			color: #9e9ea6;
		}
		.attachment_title {
			font-weight: bold;
			font-size: 16px;
		}
		
	</style>
<core-ajax id='getOGP'
    auto='false'
    method="GET"
    url="http://localhost:3000/api/urlMetadata"
    params="{{queryURL}}" 
    handleAs="json"
    response="{{ogp}}"
    ></core-ajax>

    <shadow></shadow>
	
	
	<div vertical layout>
		<div>
			<template if="{{urlSiteName}}">
				<span class="attachment_service_name">{{urlSiteName}}</span>
			</template>
		</div>
		<div>
			<template if="{{urlTitle}}">
				<span class="attachment_title"><a href="{{url}}" rel="noreferrer" target="{{url}}">{{urlTitle}}</a></span>
			</template>
		</div>
		<div>
			<template if="{{urlDescription}}">
				<div class="attachment_contents">{{urlDescription}}</div>
			</template>
		</div>
		<div>
			<template if="{{!videoURL && urlImage}}">
				<event-image src="{{urlImage}}" width="400px" disableLoadedEvent="{{disableLoadedEvent}}" on-loaded="{{imageLoaded}}"></event-image>
			</template>
			<template if="{{videoURL}}">
				<event-video src="{{videoURL}}" width="{{videoWidth}}" height="{{videoHeight}}" on-loaded="{{imageLoaded}}" disableLoadedEvent="{{disableLoadedEvent}}"></event-video>
			</template>
		</div>
	</div>
</template>

<script>
	Polymer({
		urlTitle: '',
		urlDescription: '', 
		urlImage: '',
		urlSiteName: '',
		videoWidth: 0,
		videoHeight: 0,
		disableLoadedEvent: false, 
		domReady: function(){
			this.queryURL = JSON.stringify({"url":this.url});
			this.$.getOGP.go();
		}, 
		ogpChanged: function(oldValue, newValue){
			if (newValue.og.description){
				this.urlDescription = newValue.og.description;
			}else if(newValue.description){
				this.urlDescription = newValue.description;
			}
			if (newValue.og.title){
				this.urlTitle = newValue.og.title;
			}
			if (newValue.og.image && newValue.og.image.url){
				this.urlImage = newValue.og.image.url;
			}
			if (newValue.og.site_name){
				this.urlSiteName = newValue.og.site_name;
			}
			if (newValue.og.video && newValue.og.video.url){
				this.videoURL = newValue.og.video.url;
			}
			if (newValue.og.video && newValue.og.video.height){
				try{
					this.videoHeight = parseInt(newValue.og.video.height);
				}catch(err){}
			}
			if (newValue.og.video && newValue.og.video.width){
				try{
					this.videoWidth = parseInt(newValue.og.video.width);
				}catch(err){}
			}
		}, 
		imageLoaded: function(event){
			if (!this.disableLoadedEvent){
				this.fire('loaded', '');
			}
		}
	});
</script>
</polymer-element>