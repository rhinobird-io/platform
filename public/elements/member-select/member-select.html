<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">

<link rel="import" href="../../bower_components/core-icon/core-icon.html">


<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-input-decorator.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../../bower_components/core-selector/core-selector.html">
<link rel="import" href="member-element.html">

<script src="../../bower_components/lodash/dist/lodash.min.js"></script>

<polymer-element name="member-select" attributes="teamsUrl selected">
    <template>
        <core-ajax url="{{teamsUrl}}" auto handleAs="json" on-core-response="{{handleTeamsResponse}}"></core-ajax>

        <style>
            #menu {
                -moz-border-radius: 5px;
                -webkit-border-radius: 5px;
                position: absolute;
                width: 300px;
                min-height: 100px;
                padding: 10px 10px 10px 10px;
                background-color: #C5CAE9;
            }

            #menu paper-item /deep/ * {
                padding: 2px 2px 2px 2px;
            }

            #menu ul {
                padding: 0px;
            }

            #menu > div {
                overflow-y: auto;
                max-height: 200px;
            }

            core-icon.small {
                height: 1em;
                width: 1em;
                cursor: pointer;
            }

            .item.core-selected {
                background-color: hotpink;
            }

            .item {
                cursor: pointer;
            }

            .item.team {
                margin-left: 18px;
            }

            .badge {
                background-color: #C5CAE9;
                padding: 2px;
                border-radius: 0.25em;
                border: 1px solid #C5CAE9;
                margin-right: 4px;
            }

            .block {
                display: block;
                font-weight: bold;
                padding: 0.5em 0;
            }
        </style>

        <div vertical layout>
            <div>
                <paper-input-decorator label="Members" floatingLabel labelVisible="{{_labelVisible}}">
                    <div horizontal layout center wrap>
                        <template repeat="{{ u in selected}}">
                            <div horizontal layout center class="badge">
                                <member-element userid="{{u.id}}"></member-element>
                                <core-icon class="small" icon="clear" on-click="{{ removeUserHandler }}"
                                           on-mousedown="{{preventFocus}}"></core-icon>
                            </div>
                        </template>
                        <input is="core-input" value="{{searchText}}" on-keydown="{{ doFilter }}"
                               on-focus="{{ showMenu }}" on-blur="{{ hideMenu }}">
                    </div>
                </paper-input-decorator>
            </div>
            <paper-shadow z="1" id="menu" hidden?="{{ !isShowMenu }}">
                <div>
                    <core-selector id="selector" selected="0" excludedLocalNames="label">
                        <label class="block">Teams</label>
                        <template repeat="{{ t in filterTeam(teams, selected, searchText, changeFlag)}}">
                            <div class="item team" on-tap="{{addTeamHandler}}">
                                {{t.name}}
                                <!--<paper-item id="team_{{t.name}}" team hidden?="{{!!teamSelectedMap[t.name]}}" on-click="{{ addTeamHandler }}">{{t.name}}</paper-item>-->
                            </div>
                        </template>

                        <label class="block">Members</label>
                        <template repeat="{{ u in filterUser(users, selected, searchText, changeFlag)}}">
                            <div on-tap="{{addUserHandler}}" class="item">
                                <!--<paper-item id="user_{{u.name}}" user hidden?="{{!!userSelectedMap[u.name]}}" on-click="{{  }}">{{ u.realname }}</paper-item>-->
                                <member-element userid="{{u.id}}"></member-element>
                            </div>
                        </template>
                    </core-selector>
                </div>
            </paper-shadow>
        </div>


    </template>
    <script>


        Polymer({
            computed: {
                _labelVisible: 'selected.length === 0 && !isShowMenu'
            },
            preventFocus: function (event) {
                event.stopPropagation();
            },
            selectedChanged: function (oldV) {
                this.changeFlag = !this.changeFlag;
            },
            filterTeam: function (teams, selected, searchText) {
                var result = [];
                if (!searchText) {
                    searchText = "";
                } else {
                    searchText = searchText.toLowerCase();
                }
                if (teams && selected) {
                    //filter selected
                    teams.forEach(function (t) {
                        var allSelected = true;
                        for (var i = 0; i < t.users.length; i++) {
                            if (selected.indexOf(t.users[i]) == -1) {
                                allSelected = false;
                                break;
                            }
                        }
                        if (!allSelected && t.name.toLowerCase().indexOf(searchText) != -1) {
                            result.push(t);
                        }
                    });
                }
                return result;
            },
            filterUser: function (users, selected, searchText) {
                var result = [];
                if (!searchText) {
                    searchText = "";
                } else {
                    searchText = searchText.toLowerCase();
                }
                if (users && selected) {
                    searchText = searchText.toLowerCase();

                    //filter selected
                    users.forEach(function (u) {
                        if (selected.indexOf(u) == -1 && (u.name.toLowerCase().indexOf(searchText) != -1 || u.realname.toLowerCase().indexOf(searchText) != -1)) {
                            result.push(u);
                        }
                    });
                }
                return result;
            },
            ready: function () {
                this.teams = this.teams || [];
                this._ = _;
                this.searchText = '';
                this.isShowMenu = false;
                this.userSelectedMap = {};
            },

            doFilter: function (event, detail, sender) {

                if (event.keyCode === 38 || event.keyCode === 40) { // up arrow

                    if (event.keyCode === 38) {
                        this.$.selector.selectPrevious(true);
                        this.fixScroll(true);
                    } else {
                        this.$.selector.selectNext(true);
                        this.fixScroll(false);
                    }


                } else if (event.keyCode === 13) {
                    if (this.$.selector.selectedModel.t) {
                        this.addOneTeam(this.$.selector.selectedModel.t);
                    } else if (this.$.selector.selectedModel.u) {
                        this.addOneUser(this.$.selector.selectedModel.u);
                    }
                } else if (event.keyCode === 8) { // backspace
                    if (this.searchText.length === 0 && this.selected.length > 0) {
                        var user = this.selected[this.selected.length - 1];
                        this.removeOneUser(user);
                    }

                }
            },

            /**
             * make the selected item can be seen
             */
            fixScroll: function (isUp) {
                var self = this;
                setTimeout(function () {
                    var selectedItem = self.$.selector.selectedItem;
                    if (selectedItem) {
                        var parent = selectedItem.parentElement.parentElement;
                        var parentRect = selectedItem.parentElement.parentElement.getBoundingClientRect();
                        var itemRect = selectedItem.getBoundingClientRect();
                        var invisible = (parentRect.top + parentRect.height) < itemRect.top + itemRect.height || (parentRect.top > itemRect.top);
                        if (invisible) {
                            selectedItem.scrollIntoView(isUp);
                        }
                    }
                }, 0);
            },

            showMenu: function () {
                this.isShowMenu = true;
            },

            hideMenu: function (event, detail, sender) {
                var self = this;
                setTimeout(function () {
                    self.isShowMenu = false;
                    self.$.selector.selected = 0;
                }, 100);
            },


            handleTeamsResponse: function (event) {
                this.teams = event.detail.response;
                // extract all users
                this.usersNameMap = {};
                this.users = [];
                this.teams.forEach(function (t) {
                    t.users.forEach(function (u, idx) {
                        if (!this.usersNameMap[u.name]) {
                            this.usersNameMap[u.name] = u;
                            this.users.push(u);
                        } else {
                            u = this.usersNameMap[u.name];
                            t.users[idx] = u;
                        }
                        u.teams = u.teams || [];
                        u.teams.push(t);

                    }, this);
                }, this);
            },

            addTeamHandler: function (event, detail, target) {
                var team = target.templateInstance.model.t;
                this.addOneTeam(team);
            },

            addOneTeam: function (team) {
                team.users.forEach(function (user) {
                    if (!this.userSelectedMap[user.name]) {
                        this.selected.push(user);
                        this.searchText = '';
                    }
                    this.userSelectedMap[user.name] = true;
                }, this);
            },

            addUserHandler: function (event, detail, sender) {
                var user = event.target.templateInstance.model.u;
                this.addOneUser(user);
            },

            addOneUser: function (user) {
                if (!this.userSelectedMap[user.name]) {
                    this.selected.push(user);
                    this.searchText = '';
                }
                this.userSelectedMap[user.name] = true;
            },

            removeUserHandler: function (event, detail, target) {
                var user = target.templateInstance.model.u;
                this.removeOneUser(user);
                event.stopPropagation();
            },

            removeOneUser: function (user) {
                this.userSelectedMap[user.name] = false;
                this.selected.splice(this.selected.indexOf(user), 1);
            },

            // public attributes
            teamsUrl: '',
            selected: []
        });
    </script>
</polymer-element>