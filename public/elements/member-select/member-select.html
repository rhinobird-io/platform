<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">

<link rel="import" href="../../bower_components/core-icon/core-icon.html">


<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-input-decorator.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../../bower_components/core-selector/core-selector.html">
<link rel="import" href="../../bower_components/core-icons/social-icons.html">
<link rel="import" href="member-element.html">
<link rel="import" href="x-select.html">

<polymer-element name="member-select" attributes="selected disabled label type maxLen adaptive width height">
    <template>
        <core-ajax url="/platform/teams_users" auto handleAs="json" on-core-response="{{handleTeamsResponse}}"></core-ajax>
        <x-select id="xSelect" selected="{{selected}}" disabled="{{disabled}}" label="{{label}}" maxLen="{{maxLen}}" adaptive="{{adaptive}}" width="{{width}}" height="{{height}}" fields="{{fields}}"></x-select>
    </template>
    <script>

        Polymer({
            typeChanged: function(oldV) {
                if (this.type == "team") {
                    this.fields = [{
                        "name": "teams",
                        "url": "/platform/teams",
                        "nameKey": "name",
                        "icon": "social:people"
                    }];
                } else if (this.type == "user") {
                    this.fields = [{
                        "name": "users",
                        "url": "/platform/users",
                        "nameKey": "realname",
                        "icon": "avatar"
                    }];
                } else {
                    this.fields = [{
                        "name": "teams",
                        "url": "/platform/teams",
                        "nameKey": "name",
                        "icon": "social:people"
                    }, {
                        "name": "users",
                        "url": "/platform/users",
                        "nameKey": "realname",
                        "icon": "avatar"
                    }];
                }
            },

            ready: function () {
                this.fields = [{
                    "name": "teams",
                    "url": "/platform/teams",
                    "nameKey": "name",
                    "icon": "social:people"
                }, {
                    "name": "users",
                    "url": "/platform/users",
                    "nameKey": "realname",
                    "icon": "avatar"
                }];
            },

            getAllUserInvolved: function() {

                var allUserInvolved = [];

                var that = this;
                if (this.selected.teams) {
                    this.selected.teams.forEach(function(tid) {
                        that.teamIdMap[tid].users.forEach(function(user) {
                            if (allUserInvolved.indexOf(user.id) == -1) {
                                allUserInvolved.push(user.id);
                            }
                        });
                    });
                }

                if (this.selected.users) {
                    this.selected.users.forEach(function(uid) {
                        if (allUserInvolved.indexOf(uid) == -1) {
                            allUserInvolved.push(uid);
                        }
                    });
                }

                return allUserInvolved;
            },

            handleTeamsResponse: function (event) {
                this.teams = event.detail.response;
                this.teamIdMap = {};

                var that = this;
                this.teams.forEach(function(t) {
                    that.teamIdMap[t.id] = t;
                }, this);
            },

            // public attributes
            selected: null
        });
    </script>
</polymer-element>