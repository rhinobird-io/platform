<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">

<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<script src="../../bower_components/lodash/dist/lodash.min.js"></script>

<polymer-element name="member-select" attributes="teamsUrl selected">
    <template>
        <core-ajax url="{{teamsUrl}}" auto on-core-response="{{handleTeamsResponse}}"></core-ajax>

        <style>
            .highlight {
                background-color: #b0ccf2;
            }

            #input-div li {
                display: inline;
            }

            #input-div paper-item {
                background-color: #87ceeb; /*This one is considerable*/
            }

            #menu {
                border-style: solid;
                border: white;
                background-color: white;
                -moz-border-radius: 5px;
                -webkit-border-radius: 5px;
                position: absolute;
                z-index: 1;
                width: 300px;
                min-height: 100px;
                max-height: 200px;
                overflow-y: auto;
                padding: 10px 10px 10px 10px;
            }

            #menu ul{
                padding: 0px;
            }

        </style>

        <div vertical layout>
            <div id="input-div">
                <ul>
                    <template repeat="{{ u in selected}}">
                        <li ><paper-item on-click="{{ removeUser }}" style="display: inline-block;">{{u.realname}}</paper-item></li>
                    </template>
                    <li>
                        <paper-input value="{{searchText}}" on-keyup="{{ doFilter }}" on-focus="{{ showMenu }}" on-blur="{{ hideMenu }}"/>
                    </li>
                </ul>
            </div>
            <div id="menu" hidden?="{{ !isShowMenu }}">
                <ul id="filteredTeams">
                    <template repeat="{{ t in filteredTeams}}">
                        <paper-item id="team_{{t.name}}" team hidden?="{{!!teamSelectedMap[t.name]}}" on-click="{{ addTeamHandler }}">{{t.name}}</paper-item>
                    </template>
                </ul>

                <ul id="filteredUsers">
                    <template repeat="{{ u in filteredUsers}}">
                        <paper-item id="user_{{u.name}}" user hidden?="{{!!userSelectedMap[u.name]}}" on-click="{{ addUserHandler }}">{{ u.realname }}</paper-item>
                    </template>
                </ul>
            </div>
        </div>


    </template>
    <script>


        Polymer({
            ready: function () {
                this.teams = this.teams || [];
                this._ = _;
                this.searchText = '';
                this.isShowMenu = false;

                this.teamSelectedMap = {};
                this.userSelectedMap = {};

                this.selectedIndex = -1;
            },

            doFilter: function (event, detail, sender) {

                // back space is not considered
                if (event.keyCode === 38 || event.keyCode === 40 ) { // up arrow

                    var paperItems = this.$.menu.querySelectorAll('paper-item:not([hidden])');

                    if (this.selectedIndex >= 0) {
                        var current = paperItems[this.selectedIndex];
                    }

                    if (event.keyCode === 38 && this.selectedIndex -1 >= 0) {
                        this.selectedIndex = this.selectedIndex - 1;
                    } else if (event.keyCode === 40 && this.selectedIndex + 1 < paperItems.length) {
                        this.selectedIndex = this.selectedIndex + 1;
                    }

                    var next = paperItems[this.selectedIndex];

                    if (!!current) {
                        current.classList.remove('highlight')
                    }

                    if (!!next) {
                        next.classList.add('highlight');
                    }

                    this.fixScroll();

                } else if (event.keyCode === 13) {
                    var selectedItems = this.$.menu.querySelectorAll('paper-item.highlight:not([hidden]');
                    var selectedItem = selectedItems[0];
                    if (selectedItem.hasAttribute('team')) {
                        this.addOneTeam(selectedItem.templateInstance.model.t);
                    } else if (selectedItem.hasAttribute('user')) {
                        this.addOneUser(selectedItem.templateInstance.model.u);
                    }

                    selectedItem.classList.remove('highlight');
                } else if (event.keyCode === 8) {

                    var user = this.selected[this.selected.length - 1];
                    this.removeOneUser(user);

                } else {
                    var self = this;
                    this.filteredUsers = this._.filter(this.users, function (user) {
                        return  self._.reduce([user.name, user.realname], function (sum, item) {
                            return sum || item.toLowerCase().indexOf(self.searchText.toLowerCase()) > -1;
                        }, false);
                    });

                    this.filteredTeams = this._.filter(this.teams, function (team) {
                        return  self._.reduce([team.name], function (sum, item) {
                            return sum || item.toLowerCase().indexOf(self.searchText.toLowerCase()) > -1;
                        }, false);
                    });
                }


            },

            /**
             * make the selected item can be seen
             */
            fixScroll : function() {
                var selectedItems = this.$.menu.querySelectorAll('paper-item.highlight:not([hidden]');
                var selectedItem = selectedItems[0];

                // whether it is visible
                var scrollTop = selectedItem.getBoundingClientRect().bottom - this.$.menu.getBoundingClientRect().bottom;
                if (scrollTop > 0) {
                    this.$.menu.scrollTop += scrollTop;
                }

                scrollTop = this.$.menu.getBoundingClientRect().top - selectedItem.getBoundingClientRect().top;
                if (scrollTop > 0) {
                    this.$.menu.scrollTop -= scrollTop;
                    if (this.$.menu.scrollTop < 0) {
                        this.$.menu.scrollTop = 0;
                    }
                }
            },

            showMenu: function () {
                this.isShowMenu = true;
                var ul = this.$['input-div'].querySelector('ul');
                var paddingLeft = window.getComputedStyle(ul)['padding-left'];
                this.$.menu.style['margin-left'] = paddingLeft;
            },

            hideMenu: function (event, detail, sender) {

                if (!(event && event.relatedTarget && event.relatedTarget.parentElement && event.relatedTarget.parentElement.parentElement && event.relatedTarget.parentElement.parentElement.id === this.$.menu.id)) {
                    this.isShowMenu = false;
                    this.selectedIndex = -1;
                }
            },


            handleTeamsResponse: function (event) {
                this.teams = event.detail.response;
                // extract all users
                this.usersNameMap = {};
                this.users = [];
                this.teams.forEach(function (t) {
                    t.users.forEach(function (u, idx) {
                        if (!this.usersNameMap[u.name]) {
                            this.usersNameMap[u.name] = u;
                            this.users.push(u);
                        } else {
                            u = this.usersNameMap[u.name];
                            t.users[idx] = u;
                        }
                        u.teams = u.teams || [];
                        u.teams.push(t);

                    }, this);
                }, this);

                this.filteredTeams = this.teams;
                this.filteredUsers = this.users;
            },

            addTeamHandler: function (event, detail, sender) {
                var team = event.target.templateInstance.model.t;
                this.addOneTeam(team);
            },

            addOneTeam: function(team) {
                this.teamSelectedMap[team.name] = true;

                // find the users
                team.users.forEach(function(user) {
                    if (!this.userSelectedMap[user.name]) {
                        this.selected.push(user);
                    }
                    this.userSelectedMap[user.name] = true;

                }, this);
            },

            addUserHandler: function (event, detail, sender) {
                var user = event.target.templateInstance.model.u;
                this.addOneUser(user);
            },

            addOneUser : function(user) {
                if (!this.userSelectedMap[user.name]) {
                    this.selected.push(user);
                }
                this.userSelectedMap[user.name] = true;
            },

            removeUserHandler : function(event, detail, sender) {
                var user = event.target.templateInstance.model.u;
                this.removeOneUser(user);
            },

            removeOneUser : function(user) {
                this.userSelectedMap[user.name] = false;
                user.teams.forEach(function(team) {
                    this.teamSelectedMap[team.name] = false;
                }, this);

                this.selected.splice(this.selected.indexOf(user), 1);
            },

            // public attributes
            teamsUrl: '',
            selected: []
        });
    </script>
</polymer-element>