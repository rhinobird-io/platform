<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">

<link rel="import" href="../../bower_components/core-icon/core-icon.html">


<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-input-decorator.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../../bower_components/core-selector/core-selector.html">
<link rel="import" href="member-element.html">

<polymer-element name="member-select" attributes="selected disabled label">
    <template>
        <core-ajax url="/platform/teams_users" auto handleAs="json" on-core-response="{{handleTeamsResponse}}"></core-ajax>
        <core-ajax url="/platform/users" auto handleAs="json" on-core-response="{{handleUsersResponse}}"></core-ajax>

        <style>
            div.wrapper {
                position: relative;
            }
            #menu {
                *-moz-border-radius: 5px;
                *-webkit-border-radius: 5px;
                position: absolute;
                padding: 0;
                width: 300px;
                z-index: 10;
                box-shadow: 0 0 6px #555;
                box-sizing: border-box;
            }

            #menu > div {
                height: 200px;
                padding: 10px 14px;
                background-color: #C5CAE9;
                overflow-y: auto;
            }

            core-icon.small {
                height: 1em;
                width: 1em;
                cursor: pointer;
            }

            .item.core-selected {
                background-color: #FF4081;
                color: white;
            }

            .item {
                cursor: pointer;
            }

            .item.team {
                margin-left: 18px;
            }

            .badge {
                background-color: #C5CAE9;
                padding: 2px;
                border-radius: 0.25em;
                border: 1px solid #C5CAE9;
                margin-right: 4px;
            }

            .block {
                display: block;
                font-weight: bold;
                padding: 0.5em 0;
            }
            input{
                min-width: 3em;
                width: 6em !important;
            }
        </style>

        <div vertical layout class="wrapper" id="wrapper">
            <div>
                <paper-input-decorator label="{{label}}" floatingLabel labelVisible="{{_labelVisible}}" disabled="{{disabled}}">
                    <div horizontal layout center wrap>
                        <template repeat="{{ tid in selectedTeam}}">
                            <div horizontal layout center class="badge">
                                <!--<member-element userid="{{uid}}"></member-element>-->
                                <div horizontal layout center style="height: 28px">
                                    <span style="margin: 5px">{{teamIdMap[tid].name}}</span>
                                </div>

                                <template if="{{!disabled}}">
                                    <core-icon class="small" icon="clear" on-click="{{ removeTeamHandler }}"
                                               on-mousedown="{{preventFocus}}"></core-icon>
                                </template>
                            </div>
                        </template>
                        <template repeat="{{ uid in selectedUser}}">
                            <div horizontal layout center class="badge">
                                <member-element userid="{{uid}}"></member-element>
                                <template if="{{!disabled}}">
                                    <core-icon class="small" icon="clear" on-click="{{ removeUserHandler }}"
                                           on-mousedown="{{preventFocus}}"></core-icon>
                                </template>
                            </div>
                        </template>
                        <input is="core-input" value="{{searchText}}" on-keydown="{{ doFilter }}"
                               on-focus="{{ showMenu }}" on-blur="{{ hideMenu }}" disabled?="{{disabled}}">
                    </div>
                </paper-input-decorator>
            </div>
            <paper-shadow z="1" id="menu" hidden?="{{ !isShowMenu }}">
                <div>
                    <core-selector id="selector" selected="0" excludedLocalNames="label">
                        <label class="block">Teams</label>
                        <template repeat="{{ t in filterTeam(teams, selected, searchText, changeFlag)}}">
                            <div class="item team" on-tap="{{addTeamHandler}}">
                                {{t.name}}
                            </div>
                        </template>

                        <label class="block">Members</label>
                        <template repeat="{{ u in filterUser(users, selected, searchText, changeFlag)}}">
                            <div on-tap="{{addUserHandler}}" class="item">
                                <member-element userid="{{u.id}}"></member-element>
                            </div>
                        </template>
                    </core-selector>
                </div>
            </paper-shadow>
        </div>


    </template>
    <script>

        function getElementLeft(element){
        　　　　var actualLeft = element.offsetLeft;
        　　　　var current = element.offsetParent;
        　　　　while (current !== null){
        　　　　　　actualLeft += current.offsetLeft;
        　　　　　　current = current.offsetParent;
        　　　　}
        　　　　return actualLeft;
    　　  }


        function getElementTop(element){
　　　　        var actualTop = element.offsetTop;
        　　　　var current = element.offsetParent;
        　　　　while (current !== null){
        　　　　　　actualTop += current.offsetTop;

        　　　　　　current = current.offsetParent;
        　　　　}
        　　　　return actualTop;
　　      }
        Polymer({
            label: "Members",
            computed: {
                _labelVisible: 'selected.length === 0 && !isShowMenu'
            },
            preventFocus: function (event) {
                event.stopPropagation();
            },
            selectedChanged: function (oldV) {
                this.changeFlag = !this.changeFlag;
            },
            filterTeam: function (teams, selected, searchText) {
                var result = [];
                if (!searchText) {
                    searchText = "";
                } else {
                    searchText = searchText.toLowerCase();
                }
                if (teams && selected) {
                    //filter selected
                    teams.forEach(function (t) {
                        var allSelected = true;
                        for (var i = 0; i < t.users.length; i++) {
                            if (selected.indexOf(t.users[i].id) == -1) {
                                allSelected = false;
                                break;
                            }
                        }
                        if (!allSelected && t.name.toLowerCase().indexOf(searchText) != -1) {
                            result.push(t);
                        }
                    });
                }
                return result;
            },
            filterUser: function (users, selected, searchText) {
                var result = [];
                if (!searchText) {
                    searchText = "";
                } else {
                    searchText = searchText.toLowerCase();
                }
                if (users && selected) {
                    searchText = searchText.toLowerCase();

                    //filter selected
                    users.forEach(function (u) {
                        if (selected.indexOf(u.id) == -1 && (u.realname.toLowerCase().indexOf(searchText) != -1)) {
                            result.push(u);
                        }
                    });
                }
                return result;
            },
            ready: function () {
                this.teams = this.teams || [];
                this.searchText = '';
                this.isShowMenu = false;
                this.selected = [];
                this.selectedTeam = [];
                this.selectedUser = [];
            },

            doFilter: function (event, detail, sender) {

                if (event.keyCode === 38 || event.keyCode === 40) { // up down keys
                    //avoid change cursor on input
                    event.preventDefault();
                    if (event.keyCode === 38) {
                        this.$.selector.selectPrevious(true);
                        this.fixScroll(true);
                    } else {
                        this.$.selector.selectNext(true);
                        this.fixScroll(false);
                    }
                } else if (event.keyCode === 13) {
                    if (this.$.selector.selectedModel.t) {
                        this.addOneTeam(this.$.selector.selectedModel.t);
                    } else if (this.$.selector.selectedModel.u) {
                        this.addOneUser(this.$.selector.selectedModel.u.id);
                    }
                } else if (event.keyCode === 8) { // backspace
                    if (this.searchText.length === 0) {
                        if (this.selectedUser.length > 0) {
                            var userid = this.selectedUser[this.selectedUser.length - 1];
                            this.removeOneUser(userid);
                        } else if (this.selectedTeam.length > 0) {
                            var teamId = this.selectedTeam[this.selectedTeam.length - 1];
                            this.removeOneTeam(teamId);
                        }
                    }
                } else {
                    this.$.selector.selected = 0;
                    this.$.selector.parentElement.scrollTop = 0;
                }
            },

            /**
             * make the selected item can be seen
             */
            fixScroll: function (isUp) {
                var self = this;
                setTimeout(function () {
                    var selectedItem = self.$.selector.selectedItem;
                    if (selectedItem) {
                        var parent = selectedItem.parentElement.parentElement;
                        var parentRect = selectedItem.parentElement.parentElement.getBoundingClientRect();
                        var itemRect = selectedItem.getBoundingClientRect();
                        var invisible = (parentRect.top + parentRect.height) < itemRect.top + itemRect.height || (parentRect.top > itemRect.top);
                        if (invisible) {
                            selectedItem.scrollIntoView(isUp);
                        }
                    }
                }, 0);
            },

            showMenu: function () {
                var clientHeight = document.documentElement.clientHeight;
                var scrollTop = this.$.wrapper.offsetParent.scrollTop;
                var parentHeight = this.$.wrapper.offsetParent.offsetHeight;
                var offsetTop = this.$.wrapper.offsetTop;
                var wrapperHeight = this.$.wrapper.offsetHeight;
                var menuHeight = 200;

                console.log(this.$.menu.offsetWidth);
                if (offsetTop - scrollTop + wrapperHeight + menuHeight <= parentHeight) {
                    // show menu at bottom
                    this.$.menu.style.bottom = '-' + menuHeight + 'px';
                } else {
                    this.$.menu.style.bottom = wrapperHeight + 'px';
                }

                this.isShowMenu = true;

            },

            hideMenu: function (event, detail, sender) {
                var self = this;
                setTimeout(function () {
                    self.isShowMenu = false;
                    self.$.selector.selected = 0;
                }, 100);
            },


            handleTeamsResponse: function (event) {
                this.teams = event.detail.response;

                this.teamIdMap = {};
                this.userTeamMap = {};

                this.teams.forEach(function(t) {
                    this.teamIdMap[t.id] = t;
                    t.users.forEach(function(u) {
                        this.userTeamMap[u.id + "_" + t.id] = true;
                    }, this);
                }, this);
            },
            handleUsersResponse: function (event) {
                this.users = event.detail.response;
                // extract all users
                this.usersNameMap = {};
                this.users.forEach(function (u) {
                        this.usersNameMap[u.realname] = u;
                }, this);
            },

            addTeamHandler: function (event, detail, target) {
                var team = target.templateInstance.model.t;
                this.addOneTeam(team);
            },

            addOneTeam: function (team) {
                team.users.forEach(function (user) {
                    if (this.selected.indexOf(user.id) == -1) {
                        this.selected.push(user.id);
                    }
                }, this);

                if (this.selectedTeam.indexOf(team.id) == -1) {
                    this.selectedTeam.push(team.id);
                    this.searchText = '';
                }
            },

            removeTeamHandler: function (event, detail, target) {
                var teamId = target.templateInstance.model.tid;
                this.removeOneTeam(teamId);
                event.stopPropagation();
            },

            removeOneTeam: function (teamId) {
                index = this.selectedTeam.indexOf(teamId);
                this.selectedTeam.splice(index, 1);

                this.teamIdMap[teamId].users.forEach(function(u) {
                    if (!this.isSelectedDuplicate(u.id)) {
                        this.selected.splice(this.selected.indexOf(u.id), 1);
                    }
                }, this);
            },

            /**
             * When removing a team, if the member of this team has been contained in another selected team or individual select,
             * then keep this member's selected state.
             */
            isSelectedDuplicate: function(uid) {
                var selected = false;

                if (this.selectedUser.indexOf(uid) != -1) {
                    selected = true;
                } else {
                    for (index in this.selectedTeam) {
                        if (this.userTeamMap[uid + "_" + this.selectedTeam[index]]) {
                            selected = true;
                            break;
                        }
                    }
                }
                return selected;
            },

            addUserHandler: function (event, detail, sender) {
                var userId = event.target.templateInstance.model.u.id;
                this.addOneUser(userId);
            },

            addOneUser: function (userId) {
                if (this.selected.indexOf(userId) == -1) {
                    this.selected.push(userId);
                    this.searchText = '';
                }

                if (this.selectedUser.indexOf(userId) == -1) {
                    this.selectedUser.push(userId);
                }
            },

            removeUserHandler: function (event, detail, target) {
                var userId = target.templateInstance.model.uid;
                this.removeOneUser(userId);
                event.stopPropagation();
            },

            removeOneUser: function (userId) {
                this.selected.splice(this.selected.indexOf(userId), 1);
                this.selectedUser.splice(this.selectedUser.indexOf(userId));
            },

            // public attributes
            teamsUrl: '',
            selected: null
        });
    </script>
</polymer-element>