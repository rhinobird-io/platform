<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/core-icon/core-icon.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-input-decorator.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../../bower_components/core-selector/core-selector.html">
<link rel="import" href="../../bower_components/core-icons/social-icons.html">
<link rel="import" href="member-element.html">
<link rel="import" href="avatar-image.html">

<polymer-element name="x-select" attributes="selected disabled label type maxLen adaptive width height fields">
    <template>
        <!--<core-ajax url="/platform/teams_users" auto handleAs="json" on-core-response="{{handleTeamsResponse}}"></core-ajax>-->
        <!--<core-ajax url="/platform/users" auto handleAs="json" on-core-response="{{handleUsersResponse}}"></core-ajax>-->

        <template repeat="{{field in fields}}">
            <template if="{{!field.data}}">
                <core-ajax url="{{field.url}}" auto handleAs="json" on-core-response="{{handleFieldResponse}}"></core-ajax>
            </template>
        </template>

        <style>
            div.wrapper {
                position: relative;
            }
            #menu {
                *-moz-border-radius: 5px;
                *-webkit-border-radius: 5px;
                position: absolute;
                padding: 0;
            width: {{widthInString}};
            z-index: 10;
            box-shadow: 0 0 6px #555;
            box-sizing: border-box;
            }

            #menu > div {
            height: {{height}}px;
            padding: 10px 14px;
            background-color: #C5CAE9;
            overflow-y: auto;
            }

            core-icon.small {
                height: 1em;
                width: 1em;
                cursor: pointer;
            }

            .item.core-selected {
                background-color: #FF4081;
                color: white;
            }

            .item {
                cursor: pointer;
                margin-left: 18px;
            }

            .badge {
                background-color: #C5CAE9;
                padding: 2px 4px;
                border-radius: 0.25em;
                border: 1px solid #C5CAE9;
                margin: 2px;
                margin-right: 4px;
            }

            .block {
                display: block;
                font-weight: bold;
                padding: 0.5em 0;
            }
            input{
                min-width: 3em;
                width: 6em !important;
            }
        </style>

        <div vertical layout class="wrapper" id="wrapper">
            <div>
                <paper-input-decorator label="{{label}}" floatingLabel labelVisible="{{_labelVisible}}" disabled="{{disabled}}">
                    <div horizontal layout center wrap>
                        <template repeat="{{ field in fields}}">
                            <template repeat="{{ selectedId in selected[field.name] }}">
                                <div horizontal layout center class="{{ {badge: maxLen != 1} | tokenList}}">
                                    <div horizontal layout center>
                                        <template if="{{field.icon == 'avatar'}}">
                                            <avatar-image userid="{{dataIdMap[field.name][selectedId].id}}" size="15"></avatar-image>
                                        </template>
                                        <template if="{{field.icon != 'avatar'}}">
                                            <core-icon icon="{{field.icon}}" style="width:15px; height:15px"></core-icon>
                                        </template>
                                        <span style="margin: 5px">{{ dataIdMap[field.name][selectedId][field.nameKey] }}</span>
                                    </div>
                                    <template if="{{!disabled}}">
                                        <core-icon class="small" icon="clear" on-click="{{ removeElementHandler }}"
                                                   on-mousedown="{{preventFocus}}"></core-icon>
                                    </template>
                                </div>
                            </template>
                        </template>
                        <input is="core-input" value="{{searchText}}" on-keydown="{{ doFilter }}"
                               on-focus="{{ showMenu }}" on-blur="{{ hideMenu }}" disabled?="{{disabled}}">
                    </div>
                </paper-input-decorator>
            </div>
            <paper-shadow z="1" id="menu" hidden?="{{ !isShowMenu }}">
                <div>
                    <core-selector id="selector" selected="0" excludedLocalNames="label">
                        <template repeat="{{ field in fields}}">
                            <label class="block">{{field.name}}</label>
                            <template repeat="{{ t in filterData(dataMap[field.name], selected[field.name], field, searchText, changeFlag)}}">
                                <div class="item" on-tap="{{addElementHandler}}">
                                    <div horizontal layout center>
                                        <template if="{{field.icon == 'avatar'}}">
                                            <avatar-image userid="{{t.id}}" size="15"></avatar-image>
                                        </template>
                                        <template if="{{field.icon != 'avatar'}}">
                                            <core-icon icon="{{field.icon}}" style="width:15px; height:15px"></core-icon>
                                        </template>
                                        <span style="margin: 5px">{{ t[field.nameKey] }}</span>
                                    </div>
                                </div>
                            </template>
                        </template>
                    </core-selector>
                </div>
            </paper-shadow>
        </div>


    </template>
    <script>

        function getElementLeft(element){
        　　　　var actualLeft = element.offsetLeft;
        　　　　var current = element.offsetParent;
        　　　　while (current !== null){
            　　　　　　actualLeft += current.offsetLeft;
        　　　　　　current = current.offsetParent;
        　　　　}
        　　　　return actualLeft;
    　　  }


        function getElementTop(element){
        　　　　        var actualTop = element.offsetTop;
        　　　　var current = element.offsetParent;
        　　　　while (current !== null){
            　　　　　　actualTop += current.offsetTop;

        　　　　　　current = current.offsetParent;
        　　　　}
        　　　　return actualTop;
　　      }
        Polymer({
            label: "Members",
            computed: {
                _labelVisible: 'selectedCount === 0 && !isShowMenu'
            },
            preventFocus: function (event) {
                event.stopPropagation();
            },
            selectedChanged: function (oldV) {
//                this.changeFlag = !this.changeFlag;
                var keys = null;
                if (this.selected != null) {
                    keys = Object.keys(this.selected);
                }

                var that = this;
                that.selectedCount = 0;

                if (keys != null) {
                    keys.forEach(function(key) {
                        that.selectedCount += that.selected[key].length;
                    });
                }
            },
            fieldsChanged: function() {
                this.fieldNameList = [];
                var that = this;
                this.fields.forEach(function(field) {
                    that.fieldNameList.push(field.name);

                    if (field.data != null) {
                        that.dataMap[field.name] = field.data;
                        that.dataIdMap[field.name] = {};

                        field.data.forEach(function(element) {
                            element.fieldName = field.name;
                            that.dataIdMap[field.name][element.id] = element;
                        });
                    }
                });
            },

            filterData: function(fieldData, selected, field, searchText) {
                var result = [];
                if (!searchText) {
                    searchText = "";
                } else {
                    searchText = searchText.toLowerCase();
                }
                if (fieldData) {
                    searchText = searchText.toLowerCase();

                    //filter selected
                    fieldData.forEach(function (element) {
                        if ((!selected || selected.indexOf(element.id) == -1) && (element[field.nameKey].toLowerCase().indexOf(searchText) != -1)) {
                            result.push(element);
                        }
                    });
                }
                return result;
            },

            ready: function () {
                this.dataMap = {};
                this.selected = {};
                this.dataIdMap = {};
                this.selectedCount = 0;

                this.searchText = '';
                this.isShowMenu = false;

                if (this.adaptive) {
                    this.widthInString = '100%';
                } else {
                    this.width = this.width || 300;
                    this.widthInString = this.width + 'px';
                }
                this.height = this.height || 200;

                this.changeFlag = true;

                this.initStatus = true;
            },

            doFilter: function (event, detail, sender) {

                if (event.keyCode === 38 || event.keyCode === 40) { // up down keys
                    //avoid change cursor on input
                    event.preventDefault();
                    if (event.keyCode === 38) {
                        this.$.selector.selectPrevious(true);
                        this.fixScroll(true);
                    } else {
                        this.$.selector.selectNext(true);
                        this.fixScroll(false);
                    }
                } else if (event.keyCode === 13 && this.$.selector.selectedModel) {
                    this.addElement(this.$.selector.selectedModel.t);
                } else if (event.keyCode === 8) { // backspace
                    if (this.searchText.length === 0) {
                        this.removeLastSelectedElement();
                    }
                } else {
                    this.$.selector.selected = 0;
                    this.$.selector.parentElement.scrollTop = 0;
                }
            },

            /**
             * make the selected item can be seen
             */
            fixScroll: function (isUp) {
                var self = this;
                setTimeout(function () {
                    var selectedItem = self.$.selector.selectedItem;
                    if (selectedItem) {
                        var parent = selectedItem.parentElement.parentElement;
                        var parentRect = selectedItem.parentElement.parentElement.getBoundingClientRect();
                        var itemRect = selectedItem.getBoundingClientRect();
                        var invisible = (parentRect.top + parentRect.height) < itemRect.top + itemRect.height || (parentRect.top > itemRect.top);
                        if (invisible) {
                            selectedItem.scrollIntoView(isUp);
                        }
                    }
                }, 0);
            },

            showMenu: function () {
                var clientHeight = document.documentElement.clientHeight;
                var scrollTop = this.$.wrapper.offsetParent.scrollTop;
                var parentHeight = this.$.wrapper.offsetParent.offsetHeight;
                var offsetTop = this.$.wrapper.offsetTop;
                var wrapperHeight = this.$.wrapper.offsetHeight;
                var menuHeight = this.height + 20;

                if (offsetTop - scrollTop + wrapperHeight + menuHeight <= parentHeight) {
                    // show menu at bottom
                    this.$.menu.style.bottom = '-' + menuHeight + 'px';
                } else {
                    this.$.menu.style.bottom = wrapperHeight + 'px';
                }

                this.isShowMenu = true;

            },

            hideMenu: function (event, detail, sender) {
                var self = this;
                setTimeout(function () {
                    self.isShowMenu = false;
                    self.$.selector.selected = 0;
                }, 100);
            },

            handleFieldResponse: function(event, detail, target) {
                var field = target.templateInstance.model.field;
                this.dataMap[field.name] = detail.response;

                if (!this.dataIdMap[field.name]) {
                    this.dataIdMap[field.name] = {};
                }

                var that = this;
                detail.response.forEach(function(element) {
                    element.fieldName = field.name;
                    that.dataIdMap[field.name][element.id] = element;
                });
            },

            addElementHandler: function(event, detail, target) {
                this.addElement(target.templateInstance.model.t);
                this.fire("element-select", target.templateInstance.model.t);
            },

            addElement: function(element) {
                if (!this.selected[element.fieldName]) {
                    this.selected[element.fieldName] = [];
                }

                if (this.selected[element.fieldName].indexOf(element.id) == -1) {
                    this.selectedCount ++;
                    if (this.selectedCount > this.maxLen) {
                        this.selected[element.fieldName].shift();
                    }
                    this.selected[element.fieldName].push(element.id);
                }

                this.changeFlag = !this.changeFlag;
                this.searchText = "";
            },

            removeElementHandler: function(event, detail, target) {
                var field = target.templateInstance.model.field;
                var selectedId = target.templateInstance.model.selectedId;
                this.removeElement(this.dataIdMap[field.name][selectedId]);
            },

            removeElement: function(element) {
                var index = this.selected[element.fieldName].indexOf(element.id);

                if (index != -1) {
                    this.selected[element.fieldName].splice(index , 1);
                }

                this.changeFlag = !this.changeFlag;
                this.searchText = "";

                this.selectedCount --;
            },

            removeLastSelectedElement: function() {
                var keyList = Object.keys(this.selected);
                if (keyList.length == 0) {
                    return;
                }

                var lastField = keyList[0];
                var that = this;
                keyList.forEach(function(key) {
                    if (that.selected[key].length > 0 && that.fieldNameList.indexOf(key) > that.fieldNameList.indexOf(lastField)) {
                        lastField = key;
                    }
                });

                this.selected[lastField].pop();
                this.changeFlag = !this.changeFlag;

                this.selectedCount --;
            },

            // public attributes
            selected: null
        });
    </script>
</polymer-element>