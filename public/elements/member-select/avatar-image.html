<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../app-globals/app-globals.html">

<polymer-element name="avatar-image" attributes="userid username size default">
    <template>
        <style>

            :host.small {
                font-size: small;
            }

            img {
                display: block;
            }
        </style>
        <core-ajax id="getGravatar"
                   url="/platform/gravatar/{{keyType}}/{{keyValue}}"
                   handleAs="json"
                   on-core-response="{{handleResponse}}"></core-ajax>
        <template if="{{userid && $.globals.values.memberCache[userid] && default && size}}">
            <img src="{{$.globals.values.memberCache[userid].url}}?d={{default}}&s={{size}}" width="{{size}}" height="{{size}}"/>
        </template>

        <template if="{{username && $.globals.values.memberCache[username] && default && size}}">
            <img src="{{$.globals.values.memberCache[username].url}}?d={{default}}&s={{size}}" width="{{size}}" height="{{size}}"/>
        </template>
        <app-globals id="globals"></app-globals>
    </template>
    <script>
        (function() {
            var memberCache = {};
            xhr = new XMLHttpRequest();
            xhr.onload = function(){
                var result = JSON.parse(this.responseText);
                for(var i=0; i<result.length; i++) {
                    memberCache[result[i].id] = result[i];
                    memberCache[result[i].name] = result[i];
                }
            };
            xhr.open("GET", "/platform/gravatars/all", true);
            xhr.send();
            Polymer({

                ready: function() {
                    if (!this.$.globals.values.memberCache) {
                        this.$.globals.values.memberCache = memberCache;
                        this.fire("avatar-ready");
                    }
                },

                domReady: function() {
                    if (!this.size) {
                        this.size = 16;
                    }

                    if (!this.default) {
                        this.default = "identicon";
                    }
                },

                useridChanged: function (oldValue, newValue) {
                    this.changeAction(oldValue, newValue);
                },

                usernameChanged: function (oldValue, newValue) {
                    this.changeAction(oldValue, newValue);
                },

                changeAction: function(oldValue, newValue) {
                    if (!newValue) {
                        this.gravatar = {};
                    } else {
                        this.gravatar = this.$.globals.values.memberCache[newValue];
                        if (!this.gravatar) {
                            if (this.userid) {
                                this.keyType = "id";
                                this.keyValue = this.userid;
                            } else if (this.username) {
                                this.keyType = "name";
                                this.keyValue = this.username;
                            }
                            this.$.getGravatar.go();
                        } else {
                            this.fire("avatar-ready");
                        }
                    }
                },

                handleResponse: function (event, detail, target) {
                    this.gravatar = detail.response;
                    this.$.globals.values.memberCache[this.gravatar.userid] = this.gravatar;
                    this.$.globals.values.memberCache[this.gravatar.username] = this.gravatar;
                    this.fire("avatar-ready");
                }
            });
        })();
    </script>
</polymer-element>