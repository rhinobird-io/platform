<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../app-globals/app-globals.html">

<polymer-element name="avatar-image" attributes="userid username size default borderRadius">
    <template>
        <style>
            :host.small {
                font-size: small;
            }

            img {
                display: block;
            }

            .borderRadius {
                -webkit-border-radius: {{borderRadius}};
                -moz-border-radius: {{borderRadius}};
                border-radius: {{borderRadius}};
            }
        </style>

        <template if="{{userid && $.globals.values.memberCacheId[userid] && default && size}}">
            <img src="{{$.globals.values.memberCacheId[userid].url}}?d={{default}}&s={{size}}" width="{{size}}" height="{{size}}"
                 class="{{borderRadius ? 'borderRadius' : ''}}"/>
        </template>

        <template if="{{username && $.globals.values.memberCacheName[username] && default && size}}">
            <img src="{{$.globals.values.memberCacheName[username].url}}?d={{default}}&s={{size}}" width="{{size}}" height="{{size}}"
                 class="{{borderRadius ? 'borderRadius' : ''}}"/>
        </template>
        <app-globals id="globals"></app-globals>
    </template>
    <script>
        (function() {

            Polymer({

                domReady: function() {
                    if (!this.size) {
                        this.size = 16;
                    }

                    if (!this.default) {
                        this.default = "identicon";
                    }
                },

                useridChanged: function (oldValue, newValue) {
                    this.changeAction(oldValue, newValue);
                },

                usernameChanged: function (oldValue, newValue) {
                    this.changeAction(oldValue, newValue);
                },

                changeAction: function(oldValue, newValue) {

                    if (!newValue) {
                        this.gravatar = {};
                    } else {
                        if (this.userid) {
                            this.gravatar = this.$.globals.values.memberCacheId[newValue];
                        } else {
                            this.gravatar = this.$.globals.values.memberCacheName[newValue];
                        }

                        if (!this.gravatar) {
                            if (this.userid) {
                                this.$.globals.getGravatarById(this.userid);
                            } else if (this.username) {
                                this.$.globals.getGravatarByName(this.username);
                            }
                        }
                    }
                }
            });
        })();
    </script>
</polymer-element>