<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">

<polymer-element name="member-element" attributes="userid menu">
    <template>
        <style>

            :host.small {
                font-size: small;
            }

            img {
                width: 1em;
                height: 1em;
            }
        </style>
        <core-ajax id="getGravatar"
                   url="/platform/gravatar/{{userid}}"
                   handleAs="json"
                   on-core-response="{{handleResponse}}"></core-ajax>
        <template if="{{menu}}">
            <div>
                <paper-menu-button>
                    <div class="element" horizontal layout center>
                        <img src="{{imageSrc}}"/> <span style="margin: 2px">{{gravatar.username}}</span>
                    </div>
                    <paper-dropdown class="dropdown" style="color:#000">
                        <core-menu class="menu">
                            <core-item>Direct Message</core-item>
                            <core-item>View Profile</core-item>
                        </core-menu>
                    </paper-dropdown>
                </paper-menu-button>
            </div>
        </template>

        <template if="{{!menu}}">
            <div class="element" horizontal layout center>
                <img src="{{imageSrc}}"/> <span style="margin: 2px">{{gravatar.username}}</span>
            </div>
        </template>
    </template>
    <script>
        (function() {
            var memberCache = {};
            xhr = new XMLHttpRequest();
            xhr.onload = function(){
                var result = JSON.parse(this.responseText);
                for(var i=0; i<result.length; i++) {
                    memberCache[result[i].id] = result[i];
                }
            }
            xhr.open("GET", "/platform/gravatars", true);
            xhr.send();
            Polymer({
                useridChanged: function (oldValue, newValue) {
                    if (!newValue) {
                        this.gravatar = {};
                    } else {
                        this.gravatar = memberCache[newValue];
                        if (!this.gravatar) {
                            this.$.getGravatar.go();
                        } else {
                            this.imageSrc = this.gravatar.url + "?d=identicon&s=20";
                        }
                    }

                },
                handleResponse: function (event, detail, target) {
                    this.gravatar = detail.response;
                    memberCache[this.user_id] = detail.response;
                    this.imageSrc = this.gravatar.url + "?d=identicon&s=20";
                }
            });
        })();
    </script>
</polymer-element>