<link rel="import" href="home-container.html">
<link rel="import" href="elements/app-globals/app-globals.html">
<link rel="import" href="elements/member-select/member-element.html">
<link rel="import" href="elements/member-select/member-select.html">
<link rel="import" href="bower_components/core-list/core-list.html">
<link rel="import" href="bower_components/core-item/core-item.html">
<link rel="import" href="bower_components/core-ajax/core-ajax.html">
<link rel="import" href="bower_components/core-collapse/core-collapse.html">
<link rel="import" href="bower_components/paper-fab/paper-fab.html">
<link rel="import" href="bower_components/paper-dialog/paper-action-dialog.html">
<link rel="import" href="bower_components/core-icons/social-icons.html">

<polymer-element name="team-element" attributes="team mode">
    <template>
        <style>
            paper-fab.blue {
                background: #5677fc;
            }

            paper-action-dialog::shadow #scroller {
                width : 800px;
                height : 600px;
            }

            core-icon.small {
                height: 1em;
                width: 1em;
                cursor: pointer;
            }

            .heading {
                padding: 10px 15px;
                background-color: #f3f3f3;
                border: 1px solid #dedede;
                border-top-left-radius: 5px;
                border-top-right-radius: 5px;
                font-size: 18px;
                cursor: pointer;
                height: 20px;
            }
        </style>
        <tempalte if="{{ mode == 'member'}}">
            <core-ajax id="getTeamUsers"
                       url="/platform/teams/{{team.id}}/users"
                       handleAs="json"
                       on-core-response="{{teamUserCallback}}"></core-ajax>
        </tempalte>

        <tempalte if="{{ mode == 'relation'}}">
            <core-ajax id="getTeamMembers"
                       url="/platform/teams/{{team.id}}/members"
                       handleAs="json"
                       on-core-response="{{teamMemberCallback}}"></core-ajax>
        </tempalte>

        <div horizontal layout center justified class="heading">
            <span on-tap="{{showTeamContent}}" flex>{{team.name}}</span>

            <core-ajax id="leaveTeamAjax"
                       url="/platform/teams/{{team.id}}/users/{{$.globals.values.currentUser.id}}/remove"
                       method="post"
                       on-core-response="{{leaveTeamResponse}}"></core-ajax>
            <paper-button on-tap="{{leaveTeam}}"><core-icon icon="delete"></core-icon>Leave Team</paper-button>
        </div>
        <div>
            <core-collapse id="teamContent" allowOverflow>
                <div class="content">
                    <div>
                        <div>
                            <core-ajax id="removeUserFromTeamAjax"
                                       url="/platform/teams/{{team.id}}/users/{{removeUserId}}/remove"
                                       method="post"></core-ajax>
                            <template repeat="{{team in teams}}">
                                <div horizontal layout center wrap>
                                    <core-icon icon="social:people" style="width:16px; height:16px"></core-icon>
                                    <span style="margin: 5px">{{$.globals.values.teamCache[team.id].name}}</span>
                                    <!--<core-icon class="small" icon="clear" on-click="{{ removeUserFromTeam }}"-->
                                    <!--on-mousedown="{{preventFocus}}"></core-icon>-->
                                </div>
                            </template>
                            <template repeat="{{user in users}}">
                                <div horizontal layout center wrap>
                                    <member-element userid="{{user.id}}"></member-element>
                                    <!--<core-icon class="small" icon="clear" on-click="{{ removeUserFromTeam }}"-->
                                               <!--on-mousedown="{{preventFocus}}"></core-icon>-->
                                </div>
                            </template>
                            <div style="width: 400px">
                                <core-ajax id="addMember"
                                           url="/platform/teams/{{team.id}}/members"
                                           method="post"
                                           contentType="application/json"
                                           body="{{newMember}}"
                                           on-core-response="{{newMemberResponse}}"></core-ajax>
                                <member-select id="memberSelectTeam" teamsUrl="/platform/teams_users"></member-select>
                                <paper-button raised on-tap="{{addMemberToTeam}}">Add to team</paper-button>
                            </div>
                        </div>
                    </div>
                </div>
            </core-collapse>
        </div>
        <app-globals id="globals"></app-globals>
    </template>
    <script>
        Polymer("team-element", {

            modeChanged: function() {
                if (this.mode == 'member') {
                    this.$.getTeamUsers.go();
                } else if (this.mode == 'relation') {
                    this.$.getTeamMembers.go();
                }
            },

            inviteNewMember: function() {
                var dialog = this.$.inviteDialog;
                if (!dialog) {
                    console.log("dialog not found");
                } else {
                    dialog.toggle();
                }
            },

            teamMemberCallback: function(event, response) {
                this.users = response.response.users;
                this.teams = response.response.teams;
            },

            teamUserCallback: function(event, response) {
                this.users = response.response;
                this.teams = [];
            },

            addMemberToTeam: function() {
                this.selected= this.$.memberSelectTeam.selected;
                this.selectedUser = this.$.memberSelectTeam.getAllUserInvolved();
                this.newMember = JSON.stringify(this.selected);
                var ajax = this.$.addMember;
                ajax.go();
            },

            newMemberResponse: function() {
                if (this.mode == "member") {
                    for (index in this.selectedUser) {
                        this.users.push({"id" : this.selectedUser[index]});
                    }
                } else {
                    for (index in this.selected.users) {
                        this.users.push({"id" : this.selected.users[index]});
                    }

                    for (index in this.selected.teams) {
                        this.teams.push({"id" : this.selected.teams[index]});
                    }
                }

            },

            deleteTeam: function() {
                this.fire('team-delete', {team: this.team});
                this.$.deleteTeam.go();
            },

            leaveTeam: function() {
                this.fire('team-leave', {team: this.team});
                this.$.leaveTeamAjax.go();
            },

            removeUserFromTeam: function (event, detail, target) {
                this.removedUser = target.templateInstance.model.user;
                this.removeUserId = this.removedUser.id;
                this.$.removeUserFromTeamAjax.go();
            },

            removeUserFromTeamResponse: function() {
                index = this.users.indexOf(this.removedUser);
                this.users.splice(index, 1);
            },

            showTeamContent: function() {
                var collapse = this.$.teamContent;
                collapse.toggle();
            },

            preventFocus: function() {
                event.stopPropagation();
            }
        });
    </script>
</polymer-element>

<polymer-element name="team-page">
    <template>
        <style type="text/css">
            paper-action-dialog::shadow #scroller {
                width : 800px;
                height : 600px;
            }

            .teamBlock {
                padding-top: 10px;
                padding-bottom: 10px;
            }
        </style>
        <home-container selected="team">
            <div class="title">Team</div>
            <template if="{{$.globals.values.currentUser}}">
                <core-ajax id="getTeams"
                           auto
                           url="/platform/users/{{$.globals.values.currentUser.id}}/teams"
                           handleAs="json"
                           response="{{teams}}"></core-ajax>
            </template>

            <div vertical layout flex>
                <div class="teamBlock">
                    <core-ajax id="addTeam"
                               url="/platform/teams/users"
                               method="post"
                               contentType="application/json"
                               body="{{newTeamJson}}"
                               on-core-response="{{newTeamResponse}}"></core-ajax>
                    <div vertical layout center>
                        <paper-input label="Team Name" floatinglabel value="{{teamName}}"></paper-input>
                        <member-select id="memberSelect" teamsUrl="/platform/teams_users"></member-select>
                        <paper-button raised on-tap="{{newTeam}}"><core-icon icon="add"></core-icon>Create Team</paper-button>
                    </div>
                </div>
                <template if="{{mode == 'member'}}">
                    <paper-button raised style="width: 200px" on-tap="{{switchRelationView}}"><core-icon icon="account-balance-wallet"></core-icon>View Relation</paper-button>
                </template>
                <template if="{{mode == 'relation'}}">
                    <paper-button raised style="width: 200px" on-tap="{{switchMemberView}}"><core-icon icon="social:group"></core-icon>View Members</paper-button>
                </template>
                <div vertical layout>
                    <template repeat="{{team in teams}}">
                        <team-element team="{{team}}" class="teamBlock" mode="{{mode}}" on-team-leave="{{teamLeaved}}"></team-element>
                    </template>
                </div>
            </div>
        </home-container>
        <app-globals id="globals"></app-globals>
    </template>
    <script>
        Polymer("team-page", {

            ready: function() {
                this.mode = "member";
            },

            switchRelationView: function() {
                this.mode = "relation";
            },

            switchMemberView: function() {
                this.mode = "member";
            },

            newTeam: function() {
                var newTeamData = {};
                newTeamData.team = {"name": this.teamName};
                newTeamData.user = JSON.parse(JSON.stringify(this.$.memberSelect.getAllUserInvolved()));
                if (newTeamData.user.indexOf(this.$.globals.values.currentUser.id) == -1) {
                    newTeamData.user.push(this.$.globals.values.currentUser.id);
                }
                this.newTeamJson = JSON.stringify(newTeamData);
                this.$.addTeam.go();
            },

            newTeamResponse: function(event, response) {
                var team = JSON.parse(response.response);
                this.teams.push(team);
            },

            teamLeaved: function(event, detail) {
                index = this.teams.indexOf(detail.team);
                this.teams.splice(index, 1);
            }
        });
    </script>
</polymer-element>