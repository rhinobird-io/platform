<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-autogrow-textarea.html">
<link rel="import" href="../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../bower_components/polymer-filters/polymer-filters.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../home-container.html">
<link rel="import" href="../../elements/member-select/member-select.html">
<link rel="import" href="../../elements/datetime-input/datetime-input.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/core-pages/core-pages.html">
<link rel="import" href="../../bower_components/core-style/core-style.html">
<link rel="import" href="../../bower_components/core-scroll-threshold/core-scroll-threshold.html">
<link rel="import" href="../../bower_components/core-animated-pages/transitions/slide-up.html">
<link rel="import" href="../../elements/smart-time-display/smart-time-display.html">
<link rel="import" href="../../bower_components/core-list/core-list.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>

<core-style id="calendar">
    paper-tabs::shadow #selectionBar{
        background-color: {{g.theme.accentBgColor}};
    }

    paper-tabs paper-tab::shadow #ink {
        color: {{g.theme.accentBgColor}};
    }

    paper-toggle-button::shadow #toggleBar[checked], paper-toggle-button::shadow paper-radio-button::shadow #onRadio {
        background-color: {{g.theme.accentBgColor}};
    }

    :host {
        background-color: white;
    }


    div.container {
        padding: 40px 0;        
        overflow-y: auto;
        overflow-x: hidden;
    }

    div.timeline {
        position: relative;
        padding: 10px 16px;
        *margin-top: 2em;
        *margin-bottom: 2em;
        height: 100%;
    }
    
    .loading {
        position: absolute;
        text-align: center;
        padding: 10px 0px;
        font-family: 'Open Sans', san-serif;
        font-size: 16px;
        color: #333;
        left: 0;
        right: 0;
    }

    .top-loading {
        top: 0;
    }

    .bottom-loading {
        bottom: 0;
    }

    core-list {
        overflow-y: visible;
    }
    
    .content {
        margin-left: 40px;
    }

    .block {
        position: relative;
        cursor: pointer;
    }

    .listitem {
        *position: relative !important;
        padding: 2em 0;
    }

    .listitem:last-child {
        margin-bottom: 40px;
    }
    

    .time {
        margin-top: 4px;
    }

    p.description {
        margin-bottom: 0;
    }

    div.detail {
        padding: 60px;
        overflow-y: auto;
    }

    .main-button {
        position: absolute;
        top: 20px;
        left: 16px;
    }

    .tabs, .pages, .fullday {
        max-width: 320px;
    }

    .fullday {
        margin: 1em 0;
    }

    .block {
        z-index: 4;
    }
    .event {    
        border-radius: 50%;
        padding:8px;
    }
    time-input.upper {
        margin-top: -35px;
    }
    date-input {
        z-index: 1;
    }
    #title {
        font-size: 25px;
    }
    .page.core-selected {
        position: relative;
        display: block;
    }
    paper-fab {
        position: absolute;
        left: 16px;
        top: -20px;
        z-index: 1000000000;
    }

    .list {
        *margin-top: 20px;
    }

    .subTitle {
        font-size: 21px;
        margin-left: 90px;
        padding-bottom: 10px;
    }

    paper-fab {
        position: absolute;
        top: 24px;
    }

    .wrapper {
        padding-bottom: 20px;
    }

    * {
        -webkit-box-sizing: border-box;
                box-sizing: border-box;
    }

    .listitem::before,
    .dayDivider::before {
        content: '';
        position: absolute;
        top: 0;
        left: 18px;
        height: 100%;
        width: 4px;
        z-index: 3;
        background-color: {{g.theme.thirdBgColor}};
    }

    .dayDivider::first-child {
        background: black;
    }

    .dayDivider {
        position: relative;
        clear: both;
        width: 100%;
        margin: 0em auto;
        margin-bottom: 2em;
        line-height: 1.2em;
    }

    .dayDivider .dayDividerLabel {
        position: relative;
        margin-left: 78px;
        display: inline-block;
    }

    .dayDivider .dayDividerLabel hr {
        position: absolute;
        *top: 2px;   
        top: 50%;
        left: -60px;
        right: 0px;
        border: 0;
        margin: 0;
        margin-top: -2px;
        border-top: 2px solid #bbb;

        z-index: 1;
    }

    .dayDivider .dayDividerLabel .dayDividerLabelContent {
        position: relative;
        *display: inline-block;
        color: #555459;
        font-family: 'Lato', san-serif;
        font-weight: 900;
        font-size: 1.0em;
        margin: 0 auto;
        padding: 0 2px;
        background: white;
        z-index: 2;
    }

    .time {
        font-size: 90%;
    }

    .time,
    .event-title {
        margin: 0;
        border: 0;
        padding-left: 6px;
        border-left: 4px solid transparent;
    }
    .event-title {
        font-size: 1.0em;
        font-family: Lato, san-serif;
        padding-bottom: 6px;
    }

    .block:hover .time,
    .block:hover .event-title {
        padding-left: 6px;
        border-left: 4px solid {{g.theme.mainBgColor}};
        *background-color: {{g.theme.thirdBgColor}};
        *transition: opacity ease-in 0.2s
    }

    .message {
        text-align: center;
        color: rgba(0, 0, 0, .8);
        font-size: 24px;
        font-weight: 600;
        margin-top: 10%;

        font-family: 'Open Sans';
    }

    @media screen and (min-width: 960px) {
        .event {
            position: absolute;
            left: 50%;
            margin-left: -20px;
        }

        .listitem::before,
        .dayDivider::before {
            left: 50%;
            margin-left: -2px;
        }

          
        .dayDivider .dayDividerLabel.left {
            width: 50%;
            text-align: right;
            margin-left: 0;
            padding-right: 78px;
        }

        .dayDivider .dayDividerLabel.right {
            width: 50%;
            text-align: left;
            margin-left: 50%;
            padding-left: 78px;
        }

        .dayDivider .dayDividerLabel hr {
            left: 0;
        }

        .block .content {
            display: inline-block;
            width: 50%;
        }

        .block .content.left {
            margin-left: 0px;
            padding-right: 78px;
            text-align: right;
        }

        .block .content.right {
            margin-left: 50%;
            padding-left: 78px;
            text-align: left;
        }

        .block .content.left > .time,
        .block .content.left > .event-title {
            margin:0;
            border: 0;
            padding-right: 6px;
            border-right: 4px solid transparent;
        }

        .block:hover .content.left > .time,
        .block:hover .content.left > .event-title {
            padding-right: 6px;
            border-right: 4px solid {{g.theme.mainBgColor}};
            *background-color: {{g.theme.thirdBgColor}};
        }
    }
</core-style>

<polymer-element name="schedule-list" attributes="eventId">
    <template>
        <core-style ref="theme"></core-style>
        <core-style ref="calendar"></core-style>
        <div layout vertical fit>
            <div class="mainColor wrapper">
                <template if="{{mode=='list' && eventId == null}}">
                    <paper-fab mini icon="add" class="accentColor" on-tap="{{jumpToAdd}}"></paper-fab>
                </template>
                <template if="{{mode=='edit'}}">
                    <paper-fab mini icon="done" class="accentColor" on-tap="{{saveEvent}}"></paper-fab>
                </template>
                <template if="{{mode=='view' && selected.creator_id == $.globals.values.currentUser.id}}">
                    <paper-fab mini icon="remove" class="accentColor" on-tap="{{deleteEvent}}"></paper-fab>
                </template>
                <span class="subTitle">Schedule</span>
            </div>
            <div flex vertical layout class="list">
                <core-animated-pages selected="0" transitions="cross-fade-all" id="pages" flex>
                    <section>
                        <core-scroll-threshold id="threshold" 
                            scrolltarget="{{$.container}}" 
                            lowerthreshold="40" 
                            on-lower-trigger="{{ loadMoreNewerEvents }}"
                            upperThreshold="40" 
                            on-upper-trigger="{{ loadMoreOlderEvents }}">
                        </core-scroll-threshold>
                        <template if="{{loadingMoreOlderEvents}}">
                            <div class="loading top-loading">{{loadingOlderText}}</div>
                        </template>
                        <div class="container" id="container" fit>
                            
                            <div class="timeline" vertical layout>
                                <core-list data="{{events}}" groups="{{eventGroups}}" flex style="overflow-y:visible !important;">
                                    <template>
                                        <div divider class="dayDivider">
                                            <div class="dayDividerLabel {{model.position}}">
                                                <hr/>
                                                <div class="dayDividerLabelContent">{{groupModel.date}}</div>
                                            </div>
                                        </div>
                                        <div class="listitem">
                                            <div layout horizontal class="block" center on-tap="{{select}}">
                                                <div class="event mainColor">
                                                    <core-icon icon="event"></core-icon>
                                                </div>
                                                <div hero hero-id="{{event.id}}" vertical layout class="content {{model.position}}">
                                                    <div class="event-title">{{model.title}}</div>
                                                    <div class="time iconColor">
                                                        <smart-time-display from="{{model.fromTime}}" to="{{model.toTime}}"
                                                                            period="{{model.period}}"
                                                                            full_day="{{model.full_day}}"></smart-time-display>
                                                    </div>
                                                </div>
                                                <!--
                                                <div class="info">
                                                    <core-icon icon="info" class="iconColor"></core-icon>
                                                </div>
                                                <paper-ripple fit></paper-ripple>
                                                -->
                                            </div>
                                        </div>
                                    </template>
                                </core-list>


                                
                            </div>
                        </div>

                        <template if="{{loadingMoreNewerEvents}}">
                                <div class="loading bottom-loading">{{loadingNewerText}}</div>
                        </template>
                    </section>
                    <section>
                        <div hero hero-id="{{selected.id}}" class="detail" vertical layout fit center slide-up>
                            <paper-icon-button icon="arrow-back" class="main-button"
                                               on-tap="{{main}}"></paper-icon-button>
                            <div class="detail-content" vertical layout center>
                                <div>
                                    <paper-input-decorator label="Title" floatingLabel id="title"
                                                           disabled="{{modeDisabled}}" placeholder="">
                                        <template if="{{!modeDisabled}}">
                                            <input is="core-input" value="{{selected.title}}">
                                        </template>
                                        <template if="{{modeDisabled}}">
                                            <span>{{selected.title}}</span>
                                        </template>
                                    </paper-input-decorator>

                                    <paper-input-decorator label="Description" floatingLabel id="decorator"
                                                           disabled="{{modeDisabled}}" placeholder="">
                                        <paper-autogrow-textarea id="autogrowArea">
                                        <textarea id="textArea" wrap="virtual" value="{{selected.description}}"
                                                  disabled?="{{modeDisabled}}"></textarea>
                                        </paper-autogrow-textarea>
                                    </paper-input-decorator>
                                    <template if="{{!modeDisabled}}">
                                        <div center horizontal layout class="fullday">
                                            <div flex>Full Day</div>
                                            <paper-toggle-button checked="{{selected.full_day}}"
                                                                 disabled="{{modeDisabled}}"></paper-toggle-button>
                                        </div>
                                        <paper-tabs selected="{{tabSelected}}" class="tabs">
                                            <paper-tab>Period</paper-tab>
                                            <paper-tab>Point</paper-tab>
                                        </paper-tabs>
                                    </template>
                                    <core-pages selected="{{tabSelected}}" class="pages">
                                        <div class="page">
                                            <div layout horizontal justified end>
                                                <div layout vertical>
                                                    <date-input label="From" disabled="{{modeDisabled}}"
                                                                date="{{selected.fromTime}}"></date-input>
                                                    <template if="{{!selected.full_day}}">
                                                        <time-input class="upper"
                                                                    disabled="{{modeDisabled}}"
                                                                    time="{{selected.fromTime}}"></time-input>
                                                    </template>
                                                </div>
                                                <div layout vertical>
                                                    <date-input label="To" disabled="{{modeDisabled}}"
                                                                date="{{selected.toTime}}"></date-input>
                                                    <template if="{{!selected.full_day}}">
                                                        <time-input class="upper"
                                                                    disabled="{{modeDisabled}}"
                                                                    time="{{selected.toTime}}"></time-input>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="page">
                                            <div layout horizontal justified end>
                                                <date-input label="Date" disabled="{{modeDisabled}}"
                                                            date="{{selected.fromTime}}"></date-input>
                                                <template if="{{!selected.full_day}}">
                                                    <time-input label="Time" disabled="{{modeDisabled}}"
                                                                time="{{selected.fromTime}}"></time-input>
                                                </template>
                                            </div>
                                        </div>
                                    </core-pages>
                                    <member-select teamsUrl="/platform/teams_users"
                                                   disabled="{{modeDisabled}}"
                                                   selected="{{selected.participants}}"
                                                   label="Participants"></member-select>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section>
                        <div class="message">Event not found, back to <a href="#/calendar">calendar</a>.</div>
                    </section>
                </core-animated-pages>
            </div>
        </div>
        <app-globals id="globals"></app-globals>
        <template if="{{$.globals.values.currentUser && eventId == null}}">
            <core-ajax
                auto
                id="getEvents"
                url="/platform/events"
                handleAs="json"
                on-core-response="{{handleEvents}}"></core-ajax>
        </template>
        <template if="{{$.globals.values.currentUser && eventId != null}}">
            <core-ajax
                    auto
                    url="/platform/events/{{eventId}}"
                    handleAs="json"
                    on-core-error="{{handleSingleEventError}}"
                    on-core-response="{{handleSingleEvent}}"></core-ajax>
        </template>
        <core-ajax
                id="getMoreNewerEvents"
                url="/platform/events/after/{{range.max}}"
                handleAs="json"
                on-core-response="{{handleLoadNewerEvents}}"></core-ajax>
        <core-ajax
                id="getMoreOlderEvents"
                url="/platform/events/before/{{range.min}}"
                handleAs="json"
                on-core-response="{{handleLoadOlderEvents}}"></core-ajax>

        <core-ajax id="postEvent"
                   url="/platform/events"
                   method="POST"
                   body="{{eventBody}}"
                   contentType="application/json"
                   on-core-response="{{eventSaved}}"
                >
        </core-ajax>
        <core-ajax id="deleteEvent"
                   url="/platform/events/{{selected.id}}"
                   method="DELETE"
                   on-core-response="{{eventDeleted}}"
                >
        </core-ajax>

        <paper-toast id="eventSavedToast" text="Event has been saved!"></paper-toast>
        <paper-toast id="eventDeletedToast" text="Event has been deleted!"></paper-toast>
    </template>
    <script src="../../bower_components/moment/moment.js"></script>
    <script>
        Polymer({
            mode: "list",
            isListLoaded: false,
            computed:{
                modeDisabled: 'mode=="view"'
            },
            tabSelectedChanged: function (oldV, newV) {
                this.selected.period = newV == 0;
            },
            selected: {},
            observe: {
                'selected.period': 'changeTab'
            },
            
            ready: function() {
                this.loadingMoreOlderEvents = false;
                this.loadingMoreNewerEvents = false;
                this.loadingNewerText = 'Please Wait...';
                this.loadingOlderText = 'Please Wait...';
                this.noMoreNewerEvents = false;
                this.noMoreOlderEvents = false;
            },

            refresh: function() {
                this.events.sort(function(o1, o2) {
                    if (o1.fromTime < o2.fromTime) return -1;
                    else if (o1.fromTime > o2.fromTime) return 1;
                    else return 0;
                });

                this.eventGroups = [];
                

                var position = "right";

                for (var i = 0; i < this.events.length; i++) {
                    var event = this.events[i];
                    var len = this.eventGroups.length;
                    var fromDate = new Date(event.fromTime);
                    if (len == 0 || this.eventGroups[len - 1].data.date != fromDate.toDateString()) {
                        var newDayGroup = {};
                        newDayGroup.data = {date: fromDate.toDateString()};
                        newDayGroup.length = 1;
                        this.eventGroups.push(newDayGroup);
                        if (position == "left") position = "right";
                        else position = "left";
                    } else {
                        var oldDayGroup = this.eventGroups[len - 1];
                        oldDayGroup.length++;
                    }

                    event.position = position;
                }
            },
            handleEvents: function (event, detail) {
                this.events = detail.response;
                this.events.forEach(function (event) {
                    event.participants = event.participants.map(function (p) {
                        return p.id;
                    });
                });
                this.refresh();
                this.isListLoaded = true;
                
                if (this.events.length > 0)
                    this.range = {min: this.events[0].fromTime, max: this.events[this.events.length - 1].fromTime};

            },
            handleSingleEvent: function(event, detail) {
                this.selected = detail.response;
                this.parseEvent(this.selected);
                console.log(this.selected.creator_id)
                var self = this;
                setTimeout(function () {
                    self.$.autogrowArea.update(self.$.textArea);
                    self.$.decorator.updateLabelVisibility(self.$.textArea.value);
                    self.$.pages.selected = 1;
                }, 100);
                this.mode = 'view';
            },
            handleSingleEventError: function(event, detail) {
                console.log(detail)
                if (detail.xhr.status == 404) {
                    console.log('not found');
                    this.mode = 'view';
                    this.$.pages.selected = 2;
                }
            },
            changeTab: function (oldV, newV) {
                this.tabSelected = newV ? 0 : 1;
                if (newV && !this.selected.toTime) {
                    this.selected.toTime = new Date();
                }
            },
            parseEvent: function(event) {
                event.participants = event.participants.map(function (p) {
                    return p.id;
                });
            },
            copyEvent: function(event) {
                var newEvent = {};
                newEvent.fromTime = event.fromTime.toISOString();
                newEvent.toTime = event.toTime.toISOString();
                newEvent.participants = [];
                for (participant in event.participants)
                    newEvent.participants.push(participant);
                newEvent.full_day = event.full_day;
                newEvent.period = event.period;
                newEvent.title = event.title;
                return newEvent;
            },
            toTime: function (date) {
                return moment(date).format('HH:mm');
            },
            select: function (event, detail, target) {
                this.selected = target.templateInstance.model.model;
                //console.log(this.selected);
                var self = this;
                setTimeout(function () {
                    self.$.autogrowArea.update(self.$.textArea);
                    self.$.decorator.updateLabelVisibility(self.$.textArea.value);
                    self.$.pages.selected = 1;
                }, 100);
                this.mode = 'view';
            },
            main: function () {
                this.$.pages.selected = 0;
                this.mode = 'list';
                if (!this.isListLoaded) {
                    //console.log("hahah")
                    //var router = document.querySelector("app-router");
                    //router.go("/calendar");
                    this.$.getEvents.go();
                }
                this.eventId = null;
            },
            jumpToAdd: function () {
                this.selected = {fromTime: new Date(), toTime: new Date(), participants: [], full_day: false, period: true};
                var self = this;
                setTimeout(function () {
                    self.$.autogrowArea.update(self.$.textArea);
                    self.$.decorator.updateLabelVisibility(self.$.textArea.value);
                    self.$.pages.selected = 1;
                }, 100);
                this.mode = 'edit';
            },
            saveEvent: function(){
                this.eventBody = JSON.stringify(this.selected);
                this.$.postEvent.go();
            },
            eventSaved: function(event, detail) {
                this.mode = 'view';

                var newEvent = JSON.parse(detail.response);

                this.parseEvent(newEvent);
                this.events.push(newEvent);
                this.main();
                this.$.eventSavedToast.show();
                this.refresh();

            },
            deleteEvent: function() {
                this.$.deleteEvent.go();
            },
            eventDeleted: function(event, detail) {
                console.log(this.selected);
                for (var i = 0; i < this.events.length; i++) {
                    var e = this.events[i];
                    console.log(e);
                    if (e.id == this.selected.id) {
                        this.events.splice(i, 1);
                        break;
                    }
                }
                this.main();
                this.$.eventDeletedToast.show();
                this.refresh();
            },
            loadMoreNewerEvents: function() {
                this.loadingMoreNewerEvents = true;
                this.$.getMoreNewerEvents.go();

                /*
                if (!this.noMoreNewerEvents) {
                } else {
                    var self = this;
                    setTimeout(function() {
                        self.loadingMoreNewerEvents = false;
                    }, 1000);
                }*/
            },
            loadMoreOlderEvents: function() {
                this.loadingMoreOlderEvents = true;
                this.$.getMoreOlderEvents.go();
                /*
                if (!this.noMoreOlderEvents) {
                } else {
                    var self = this;
                    setTimeout(function() {
                        self.loadingMoreOlderEvents = false;
                    }, 1000);
                }*/
            },
            handleLoadEvents: function(type, event, detail) {

                var events = detail.response;
                console.log(events.length);
                if (events.length > 0) {
                    events.forEach(function (event) {
                        event.participants = event.participants.map(function (p) {
                            return p.id;
                        });
                    });
                    for (var i = 0; i < events.length; i++) {
                        var contain = false;
                        for (var j = 0; j < this.events.length; j++) {
                            if (events[i].id == this.events[j].id) {
                                contain = true;
                                break;
                            }
                        }
                        if (!contain)
                           this.events.push(events[i]);
                    }

                    if (type == 1)
                        this.range.max = events[events.length - 1].fromTime;
                    else if (type == 2)
                        this.range.min = events[0].fromTime;
                    this.refresh();
                } else {
                    /*if (type == 1) {
                        this.noMoreNewerEvents = true;
                        this.loadingNewerText = 'No more newer events.';
                    } else if (type == 2) {
                        this.noMoreOlderEvents = true;
                        this.loadingOlderText = 'No more older events.';
                    }*/
                }

                if (type == 1)
                    this.loadingMoreNewerEvents = false;
                else if (type == 2)
                    this.loadingMoreOlderEvents = false;

                if (type == 1)
                    this.$.threshold.clearLower();
                else if (type == 2)
                    this.$.threshold.clearUpper();
                    
            },
            handleLoadNewerEvents: function(event, detail) {
                this.handleLoadEvents(1, event, detail);
            },
            handleLoadOlderEvents: function(event, detail) {
                this.handleLoadEvents(2, event, detail);
            }
        });
    </script>
</polymer-element>

<polymer-element name="calendar-plugin" attributes="eventId">
    <template>
        <core-style ref="theme"></core-style>
        <style>

        </style>
        <home-container>
            <schedule-list eventId="{{eventId}}"></schedule-list>
        </home-container>
    </template>
    <script>
        Polymer({
        });
    </script>
</polymer-element>