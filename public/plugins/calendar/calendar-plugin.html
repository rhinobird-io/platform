<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-autogrow-textarea.html">
<link rel="import" href="../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../bower_components/polymer-filters/polymer-filters.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../home-container.html">
<link rel="import" href="../../elements/member-select/member-select.html">
<link rel="import" href="../../elements/datetime-input/datetime-input.html">
<link rel="import" href="../../elements/smart-editor/smart-display.html">
<link rel="import" href="../../elements/smart-editor/smart-editor.html">
<link rel="import" href="../../elements/smart-time-display/smart-time-display.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/core-selector/core-selector.html">
<link rel="import" href="../../bower_components/core-pages/core-pages.html">
<link rel="import" href="../../bower_components/core-style/core-style.html">
<link rel="import" href="../../bower_components/core-scroll-threshold/core-scroll-threshold.html">
<link rel="import" href="../../bower_components/core-animated-pages/transitions/slide-up.html">
<link rel="import" href="../../bower_components/core-list/core-list.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="/comment/elements/thread-element.html">

<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>

<core-style id="calendar">
    paper-tabs::shadow #selectionBar{
        background-color: {{g.theme.accentBgColor}};
    }

    paper-tabs paper-tab::shadow #ink {
        color: {{g.theme.accentBgColor}};
    }

    paper-toggle-button::shadow [checked] .toggle{
        background-color: {{g.theme.accentBgColor}};
    }

    paper-toggle-button::shadow [checked] .toggle-ink {
        color: {{g.theme.accentBgColor}};
    }

    :host {
        background-color: white;
        font-family: 'Open Sans', sans-serif;
    }

    div#emptyNotification {
        color: #555;
        text-align: center;
        font-family: 'Open Sans', san-serif;
        font-size: 2em;
    }

    div.container {
        display: block;
        padding: 50px 0;     
        width: 100%;
        height: 100%;  
        overflow-y: hidden;
        overflow-x: hidden;
    }
    
    .loading {
        position: absolute;
        text-align: center;
        padding: 10px 0px;
        font-family: 'Open Sans', san-serif;
        font-size: 16px;
        color: #666;
        left: 0;
        right: 0;
    }

    .top-loading {
        top: 0;
    }

    .bottom-loading {
        bottom: 0;
    }

    core-list {
        overflow-x: hidden;
    }
    
    .content {
        margin-left: 40px;
    }

    .block {
        position: relative;
        cursor: pointer;
    }

    .listitem {
        *position: relative !important;
        padding: 2em 0;
    }

    .time {
        margin-top: 4px;
    }

    time-input {
        margin-left: 12px;
    }

    p.description {
        margin-bottom: 0;
    }

    div.detail {
        padding: 60px 80px;
        overflow-y: auto;
    }

    .main-button {
        position: absolute;
        top: 64px;
        left: 16px;
        z-index: 10;
    }

    .tabs, .pages, .fullday {
        max-width: 320px;
    }

    .pages {
        margin-top: 0.75em;
    }

    .fullday {
        margin: 1em 0;
    }

    .block {
        z-index: 4;
    }

    .event-wrapper {
        position: absolute;
        border-radius: 50%;
        padding: 5px;
        margin-top: -5px;
        margin-left: -5px;
        background-color: {{g.theme.thirdBgColor}};
    }

    .event {    
        border-radius: 50%;
        padding: 8px;
        color: {{g.theme.mainColor}};
    }

    .event-wrapper:hover {
        padding: 0px;
    }

    .event-wrapper:hover .event {
        padding: 13px;
    }

    .event:hover {
        padding: 13px;
    }

    .event.normal {
        background-color: {{g.theme.mainBgColor}};
    }

    .event.expired {
        background-color: grey;
    }

    .event.active {
        background-color: {{g.theme.accentBgColor}};
    }

    date-input {
        z-index: 1;
    }

    #title {
        font-size: 25px;
    }

    .page.core-selected {
        position: relative;
        display: block;
    }

    paper-fab {
        position: absolute;
        left: 16px;
        top: -20px;
        z-index: 1;
    }

    .subTitle {
        font-size: 21px;
        margin-left: 90px;
        padding-bottom: 10px;
    }

    paper-fab {
        position: absolute;
        top: 24px;
    }

    .wrapper {
        padding-bottom: 20px;
    }

    * {
        -webkit-box-sizing: border-box;
                box-sizing: border-box;
    }

    .listitem::before,
    .dayDivider::before {
        content: '';
        position: absolute;
        top: 0;
        left: 18px;
        height: 100%;
        width: 6px;
        z-index: 3;
        background-color: {{g.theme.thirdBgColor}};
    }

    .dayDivider::first-child {
        background: black;
    }

    .dayDivider {
        position: relative;
        clear: both;
        width: 100%;
        margin: 0em auto;
        margin-bottom: 2em;
        line-height: 1.2em;
    }

    .dayDivider .dayDividerLabel {
        position: relative;
        margin-left: 78px;
        display: inline-block;
    }

    .dayDivider .dayDividerLabel.today {
        color: rgba(240, 10, 10, .8);
    }

    .dayDivider .dayDividerLabel hr {
        position: absolute;
        *top: 2px;   
        top: 50%;
        left: -60px;
        right: 0px;
        border: 0;
        margin: 0;
        margin-top: -2px;
        border-top: 2px solid #bbb;

        z-index: 1;
    }

    .dayDivider .dayDividerLabel .dayDividerLabelContent {
        position: relative;
        *display: inline-block;
        color: #555459;
        font-family: 'Lato', san-serif;
        font-weight: 900;
        font-size: 1.0em;
        margin: 0 auto;
        padding: 0 2px;
        background: white;
        z-index: 2;
    }

    .time {
        font-size: 90%;
    }

    .time,
    .event-title {
        margin: 0;
        border: 0;
        margin-left: 22px;
        padding-left: 16px;
        border-left: 4px solid transparent;
        overflow: hidden;
        text-overflow: ellipse;
    }

    .event-title {
        font-size: 1.0em;
        font-family: Lato, san-serif;
        padding-bottom: 6px;
    }

    .block:hover .time,
    .block:hover .event-title {
        *border-left: 4px solid {{g.theme.mainBgColor}};
        *background-color: {{g.theme.thirdBgColor}};
        *transition: opacity ease-in 0.2s
    }

    .message {
        text-align: center;
        color: rgba(0, 0, 0, .8);
        font-size: 24px;
        font-weight: 600;
        margin-top: 10%;
        font-family: 'Open Sans';
    }

    
    core-list {
        padding-left: 16px;
    }

    .badge {
        background-color: {{g.theme.accentBgColor}};
        color: white;
        border-radius: 2px;
        font-size: 11px;
        padding: 2px 6px;
        margin: 0 6px;
        box-sizing: border-box;
    }

    smart-editor /deep/ paper-input-decorator {
        padding: 0;
    }

    .floated-label {
        font-size: 0.75em;
        white-space: no-wrap;
        background: transparent;
    }

    .label-text {
        color: #757575;
    }

    .floated-content {
        margin: 0.5em 0 0.5em;
        padding: 0.25em 0;
        border-bottom: 1px dashed #757575;
    }

    #repeatEventDialog {
        font-size: 0.8em;
        max-width: 90%;
        width: 500px;
        height: 60%;
        min-height: 460px;
    }

    #repeatEventDialogContent > div{
        padding: 12px 8px;
    }

    #repeatEventDialogContent core-label {
        font-weight: bold;
    }

    paper-input#repeatedTimes /deep/ paper-input-decorator,
    paper-input#repeatedFrequency /deep/ paper-input-decorator,
    date-input /deep/ paper-input-decorator,
    time-input /deep/ paper-input-decorator {
        margin: 0;
        padding: 0;
    }

    paper-input#repeatedTimes /deep/ paper-input-decorator input,
    paper-input#repeatedFrequency /deep/ paper-input-decorator input,
    date-input /deep/ paper-input-decorator *,
    time-input /deep/ paper-input-decorator * {
        margin: 0;
        padding: 0;
    }

    paper-input#repeatedTimes /deep/ paper-input-decorator input,
    paper-input#repeatedFrequency /deep/ paper-input-decorator input {
        width: 48px;
        text-align: center;
    }

    .item {
        cursor: pointer;
        padding: 6px 8px;
        *font-size: 0.8em;
        vertical-align: middle;
        box-sizing: border-box;
        background: {{g.theme.thirdBgColor}};
    }

    .item.core-selected {
        color: white;
        *padding: 8px;
        background: {{g.theme.mainBgColor}};

    }

    @media screen and (min-width: 960px) {
        core-list {
            padding-left: 0px;
        }

        .event-wrapper {
            position: absolute;
            left: 50%;
            margin-left: -25px;
            margin-top: -5px;
        }

        .listitem::before,
        .dayDivider::before {
            left: 50%;
            margin-left: -3px;
        }

          
        .dayDivider .dayDividerLabel.left {
            width: 50%;
            text-align: right;
            margin-left: 0;
            padding-right: 78px;
        }

        .dayDivider .dayDividerLabel.right {
            width: 50%;
            text-align: left;
            margin-left: 50%;
            padding-left: 78px;
        }

        .dayDivider .dayDividerLabel hr {
            left: 0;
        }

        .block .content {
            display: inline-block;
            width: 50%;
        }

        .block .content.left {
            margin-left: 0px;
            padding-right: 78px;
            text-align: right;
        }

        .block .content.right {
            margin-left: 50%;
            padding-left: 78px;
            text-align: left;
        }

        .block .content.left > .time,
        .block .content.left > .event-title {
            margin:0;
            border: 0;
            padding-right: 6px;
            border-right: 4px solid transparent;
        }

        .time,
        .event-title {
            margin-left: 0px;
            padding-left: 0px;
        }

    }
</core-style>

<polymer-element name="schedule-list" attributes="eventId">
    <template>
        <core-style ref="theme"></core-style>
        <core-style ref="calendar"></core-style>

        <style>
            .spinner {
                z-index: 1;
                position: absolute;
                border-radius: 50%;
                background-color: white;
                left: 50%;
                margin-left: -{{25 + spinnerXOffset}}px;
                width: 50px;
                height: 50px;
            }

            .bottom-spinner {
                top: {{bottomSpinnerTop}}px;
                -webkit-transition: top 0.3s linear;
            }

            .top-spinner {
                top: {{topSpinnerTop}}px;
                -webkit-transition: top 0.3s linear;
            }

            div.timeline {
                position: relative;
                *padding: 10px 0px;
                height: 100%;
                display: block;
            }

        </style>

        <div layout vertical fit>
            <div class="mainColor wrapper">
                <template if="{{mode=='list' && eventId == null}}">
                    <paper-fab mini icon="add" class="accentColor" on-tap="{{jumpToAdd}}"></paper-fab>
                </template>
                <template if="{{mode=='edit'}}">
                    <paper-fab mini icon="done" class="accentColor" on-tap="{{saveEvent}}"></paper-fab>
                </template>
                <template if="{{mode=='view' && selected.creator_id == $.globals.values.currentUser.id}}">
                    <paper-fab mini icon="remove" class="accentColor" on-tap="{{deleteEvent}}"></paper-fab>
                </template>
                <span class="subTitle">Schedule</span>
            </div>
            <div flex vertical layout class="list">
                <core-animated-pages selected="0" transitions="cross-fade-all" id="pages" flex>
                    <section>
                        
                        
                        <div class="container" id="container">
                            <div id="emptyNotification" hidden?="{{events == null || events.length != 0}}">Empty Calendar</div>
                            <div class="timeline" vertical layout hidden?="{{events == null || events.length == 0}}">
                                
                                <paper-shadow layered id="topSpinner" class="spinner top-spinner" layout center-center horizontal hidden?="{{!loadingMoreOlderEvents}}">
                                    <paper-spinner active></paper-spinner>
                                </paper-shadow>
                                <div class="loading top-spinner" hidden?="{{!noMoreOlderEvents}}">No more events.</div>
                                <core-list id="eventList" data="{{events}}" groups="{{eventGroups}}" flex>
                                    <core-scroll-threshold id="threshold" 
                                        scrolltarget="{{$.container}}" 
                                        lowerthreshold="30" 
                                        on-lower-trigger="{{ loadMoreNewerEvents }}"
                                        upperThreshold="30" 
                                        on-upper-trigger="{{ loadMoreOlderEvents }}">
                                    </core-scroll-threshold>
                                    <template>
                                        <div divider class="dayDivider">
                                            <div class="dayDividerLabel {{model.position}} {{model.today}}">
                                                <hr/>
                                                <div class="dayDividerLabelContent">
                                                    <span>{{groupModel.date}}</span>
                                                    <template if="{{model.isToday}}">
                                                        <span class="badge">Today</span>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="listitem">
                                            <div layout horizontal class="block" center on-tap="{{select}}">
                                                
                                                <div class="event-wrapper">
                                                
                                                <div class="event {{model.eventStatus}}">
                                                    <core-icon icon="event"></core-icon>
                                                </div>
                                                </div>
                                                <div hero hero-id="{{event.id}}" vertical layout class="content {{model.position}}">
                                                    <div class="event-title">{{model.title}}</div>
                                                    <div class="time iconColor">
                                                        <smart-time-display 
                                                            from="{{model.from_time}}" 
                                                            to="{{model.to_time}}"
                                                            period="{{model.period}}"
                                                            full_day="{{model.full_day}}"
                                                            with_message="{{true}}"
                                                            threshold="{{86400000}}">
                                                        </smart-time-display>
                                                    </div>
                                                </div>
                                                <!--
                                                <div class="info">
                                                    <core-icon icon="info" class="iconColor"></core-icon>
                                                </div>
                                                <paper-ripple fit></paper-ripple>
                                                -->
                                            </div>
                                        </div>
                                    </template>
                                </core-list>

                                <paper-shadow layered id="bottomSpinner" class="spinner bottom-spinner" layout center-center horizontal hidden?="{{!loadingMoreNewerEvents}}">
                                    <paper-spinner active></paper-spinner>
                                </paper-shadow>
                                
                                <div class="loading bottom-spinner" hidden?="{{!noMoreNewerEvents}}">No more events.</div>
                            </div>
                            
                        </div>

                    </section>
                    <section>
                        <!-- Confirmation dialog for event deletion. -->
                        <paper-action-dialog backdrop autoCloseDisabled heading="Sure to delete this event?" layered="false" id="confirmDeleteDialog">
                            <paper-button dismissive>Cancel</paper-button>
                            <paper-button affirmative on-tap="{{doDelete}}">Delete</paper-button>
                        </paper-action-dialog>

                        <!-- Repeated event dialog-->
                        <paper-action-dialog backdrop autoCloseDisabled heading="Repeat" layered="false" id="repeatEventDialog">
                            <div vertical layout id="repeatEventDialogContent">
                                <div horizontal auto-vertical layout>
                                    <core-label flex>Repeats:</core-label>
                                    <core-selector 
                                        selected="{{selected.repeated_type}}"
                                        on-core-select="{{repeatedTypeChange}}"
                                        valueattr="label" end-justified>
                                        <span class="item" label="Daily">Daily</span>
                                        <span class="item" label="Weekly">Weekly</span>
                                        <span class="item" label="Monthly">Monthly</span>
                                        <span class="item" label="Yearly">Yearly</span>
                                    </core-selector>
                                </div>
                                
                                <div horizontal auto-vertical layout>
                                    <core-label flex>Repeated Every:</core-label>
                                    <span>
                                        <paper-input label="frequency" 
                                            id="repeatedFrequency" 
                                            value="{{selected.repeated_frequency}}"
                                            on-input="{{repeatedFrequencyChange}}">
                                        </paper-input> 

                                        <template if="{{selected.repeated_type == 'Daily'}}">
                                            <span>days</span>
                                        </template>

                                        <template if="{{selected.repeated_type == 'Weekly'}}">
                                            <span>weeks</span>
                                        </template>

                                        <template if="{{selected.repeated_type == 'Monthly'}}">
                                            <span>months</span>
                                        </template>

                                        <template if="{{selected.repeated_type == 'Yearly'}}">
                                            <span>years</span>
                                        </template>
                                    </span>
                                </div>

                                <div horizontal layout hidden?="{{selected.repeated_type != 'Monthly'}}">
                                    <core-label flex>Repeat By:</core-label>
                                    <span end-justified>
                                        Day of 
                                        <core-selector 
                                            selected="{{selected.repeated_by}}" 
                                            on-core-select="{{repeatedDayOfMonthChange}}" 
                                            valueattr="label">
                                            <span class="item" label="Month">Month</span>
                                            <span class="item" label="Week">Week</span>
                                        </core-selector>
                                    </span>
                                </div>

                                <div horizontal layout hidden?="{{selected.repeated_type != 'Weekly'}}">
                                    <core-label flex>Repeat On:</core-label>
                                    <core-selector 
                                        selected="{{selected.repeated_on}}" 
                                        on-core-select="{{repeatedDaysOfWeekChange}}" 
                                        valueattr="label" multi end-justified>
                                        <span class="item" label="Sun">Sun</span>
                                        <span class="item" label="Mon">Mon</span>
                                        <span class="item" label="Tue">Tue</span>
                                        <span class="item" label="Wed">Wed</span>
                                        <span class="item" label="Thu">Thu</span>
                                        <span class="item" label="Fri">Fri</span>
                                        <span class="item" label="Sat">Sat</span>
                                    </core-selector>
                                </div>

                                <div horizontal layout>
                                    <core-label flex center>Ends Way:</core-label>
                                    <core-selector
                                        selected="{{selected.repeated_end_type}}"
                                        on-core-select="{{repeatedEndTypeChange}}"
                                        valueattr="label" end-justified center>
                                        <span class="item" label="Never">Never</span>
                                        <span class="item" label="Occurence">Occurence</span>
                                        <span class="item" label="Date">Date</span>
                                    </core-selector>
                                </div>

                                <div horizontal layout hidden?="{{selected.repeated_end_type != 'Occurence'}}">
                                    <core-label flex></core-label>
                                    <span style="">
                                        After 
                                        <paper-input id="repeatedTimes" label="times" 
                                            on-input="{{repeatedTimesChange}}"
                                            value="{{selected.repeated_times}}">
                                        </paper-input> 
                                        times
                                    </span>
                                </div>
                                
                                <div horizontal layout hidden?="{{selected.repeated_end_type != 'Date'}}">
                                    <core-label flex></core-label>
                                    <span horizontal layout>
                                        <span style="padding-right:10px;">Ends On:</span> 
                                        <date-input
                                            id="repeatedEndDate" 
                                            date="{{selected.repeated_end_date}}">
                                        </date-input>
                                    </span>
                                </div>

                                <div horizontal layout>
                                    <core-label flex>Repeat Summary:</core-label>
                                    <core-label flex two end-justified style="text-align:right;">{{selected.summary}}</core-label>
                                </div>
                            </div>
                            <paper-button affirmative on-tap="{{confirmRepeatEvent}}">Done</paper-button>
                            <paper-button dismissive on-tap="{{cancelRepeatEvent}}">Cancel</paper-button>
                        </paper-action-dialog>

                        <!-- Back button from edit/view to list -->
                        <paper-icon-button icon="arrow-back" class="main-button"
                                           on-tap="{{main}}">
                        </paper-icon-button>

                        <div hero hero-id="{{selected.id}}" class="detail" vertical layout fit slide-up>
                            <div class="detail-content" vertical layout>
                                <div>
                                    <paper-input-decorator label="Title" floatingLabel id="title"
                                                           disabled="{{modeDisabled}}" placeholder="">
                                        <template if="{{!modeDisabled}}">
                                            <input is="core-input" id="titleInput" value="{{selected.title}}">
                                        </template>
                                        <template if="{{modeDisabled}}">
                                            <span>{{selected.title}}</span>
                                        </template>
                                    </paper-input-decorator>

                                    <template if="{{mode == 'edit'}}">
                                        <smart-editor id="textArea" label="Description" value="{{selected.description}}" floatingLabel underline>
                                        </smart-editor>
                                    </template>

                                    <template if="{{mode == 'view'}}">
                                        <div class="floated-label">
                                            <span class="label-text">Description</span>
                                        </div>  
                                        <div class="floated-content">
                                            <smart-display value="{{selected.description}}"></smart-display>
                                        </div>
                                    </template>

                                    <template if="{{!modeDisabled}}">
                                        <div center horizontal layout class="fullday">
                                            <div flex>Full Day</div>
                                            <paper-toggle-button 
                                                checked="{{selected.full_day}}"
                                                disabled="{{modeDisabled}}">
                                            </paper-toggle-button>
                                        </div>
                                        <paper-tabs selected="{{tabSelected}}" class="tabs">
                                            <paper-tab>Period</paper-tab>
                                            <paper-tab>Point</paper-tab>
                                        </paper-tabs>
                                    </template>

                                    <!-- Select from_time and to_time -->
                                    <core-pages selected="{{tabSelected}}" class="pages">
                                        <div class="page">
                                            <div layout horizontal justified>
                                                <div layout vertical>
                                                    <div class="floated-label">
                                                        <span class="label-text">From</span>
                                                    </div>
                                                    <div layout horizontal>
                                                        <!-- from_date -->
                                                        <date-input 
                                                            label="From" 
                                                            disabled="{{modeDisabled}}"
                                                            date="{{selected.from_time}}">
                                                        </date-input>

                                                        <!-- from_time -->
                                                        <template if="{{!selected.full_day}}">
                                                            <time-input 
                                                                class="upper"
                                                                disabled="{{modeDisabled}}"
                                                                time="{{selected.from_time}}">
                                                            </time-input>
                                                        </template>
                                                    </div>
                                                </div>
                                                <div layout vertical>
                                                    <div class="floated-label">
                                                        <span class="label-text">To</span>
                                                    </div>
                                                    <div layout horizontal flex end-justified>
                                                        <!-- to_date -->
                                                        <date-input label="To" disabled="{{modeDisabled}}"
                                                                    date="{{selected.to_time}}">
                                                        </date-input>

                                                        <!-- to_time -->
                                                        <template if="{{!selected.full_day}}">
                                                            <time-input 
                                                                class="upper"
                                                                disabled="{{modeDisabled}}"
                                                                time="{{selected.to_time}}">
                                                            </time-input>
                                                        </template>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="page">
                                            <div layout horizontal justified end>
                                                <date-input label="Date" disabled="{{modeDisabled}}"
                                                            date="{{selected.from_time}}"></date-input>
                                                <template if="{{!selected.full_day}}">
                                                    <time-input label="Time" disabled="{{modeDisabled}}"
                                                                time="{{selected.from_time}}">
                                                    </time-input>
                                                </template>
                                            </div>
                                        </div>
                                    </core-pages>

                                    <template if="{{modeDisabled && selected.repeated}}">
                                        <div style="margin-top:0.75em;">
                                            <div class="floated-label">
                                                <span class="label-text">Repeat</span>
                                            </div>  
                                            <div class="floated-content">
                                                <span>{{selected.summary}}</span>
                                            </div>
                                        </div>
                                    </template>

                                    <!-- Repeat event toggle button -->
                                    <template if="{{!modeDisabled}}">
                                        <div center horizontal layout class="fullday">
                                            <div flex>
                                                Repeat 
                                                <template if="{{selected.repeated}}">
                                                    : {{selected.summary}}
                                                </template>
                                            </div>
                                            <paper-toggle-button 
                                                id="repeatToggle"
                                                checked="{{selected.repeated}}"
                                                on-change="{{repeatToggled}}"
                                                disabled="{{modeDisabled}}">
                                            </paper-toggle-button>
                                        </div>
                                    </template>
                                    
                                    <member-select 
                                        teamsUrl="/platform/teams_users"
                                        disabled="{{modeDisabled}}"
                                        selected="{{selected.participants}}"
                                        label="Participants"
                                        adaptive>
                                    </member-select>
                                    <template if="{{mode == 'view'}}">
                                        <div class="floated-label">
                                            <span class="label-text">Comments</span>
                                        </div>  
                                        <br>
                                        <thread-element key="calendar/{{selected.id}}/{{selected.repeated_number}}"></thread-element>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section>
                        <div class="message">Event not found, back to <a href="#/calendar">calendar</a>.</div>
                    </section>
                </core-animated-pages>
            </div>
        </div>
        <app-globals id="globals"></app-globals>
        <template if="{{eventId == null}}">
            <core-ajax
                auto
                id="getEvents"
                url="/platform/events"
                handleAs="json"
                on-core-response="{{handleEvents}}">
            </core-ajax>
        </template>
        
        <template if="{{eventId != null}}">
            <core-ajax
                    auto
                    url="/platform/events/{{eventId}}"
                    handleAs="json"
                    on-core-error="{{handleSingleEventError}}"
                    on-core-response="{{handleSingleEvent}}">
            </core-ajax>
        </template>

        <core-ajax
                id="getMoreNewerEvents"
                url="/platform/events/after/{{range.max}}"
                handleAs="json"
                on-core-response="{{handleLoadNewerEvents}}"></core-ajax>
        <core-ajax
                id="getMoreOlderEvents"
                url="/platform/events/before/{{range.min}}"
                handleAs="json"
                on-core-response="{{handleLoadOlderEvents}}"></core-ajax>

        <core-ajax id="postEvent"
                   url="/platform/events"
                   method="POST"
                   body="{{eventBody}}"
                   contentType="application/json"
                   on-core-response="{{eventSaved}}"
                >
        </core-ajax>
        <core-ajax id="deleteEvent"
                   url="/platform/events/{{selected.id}}"
                   method="DELETE"
                   on-core-response="{{eventDeleted}}"
                >
        </core-ajax>

        <paper-toast id="titleCannotBeEmpty" text="Please enter the event's title."></paper-toast>
        <paper-toast id="eventSavedToast" text="Event has been saved!"></paper-toast>
        <paper-toast id="eventDeletedToast" text="Event has been deleted!"></paper-toast>
    </template>
    <script src="../../bower_components/moment/moment.js"></script>
    <script>
        // Return the number of week days of a month
        // Eg: 2015/2/1 is the first sunday of February, it will return 1.
        Date.prototype.weekOfMonth = function() {
            var date = this.getDate();
            var result = 1;
            while (date - 7 >= 0) {
                result++;
                date -= 7;
            }
            return result;
        }

        Polymer({
            mode: "list",
            isListLoaded: false,
            daysInWeek: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
            months: ['January', 'February', 'March', 'April', 'May', 'June', 
                     'July', 'Augest', 'September', 'October', 'November', 'December'],
            daysInWeekMap: {
                'Sun': 'Sunday',
                'Mon': 'Monday',
                'Tue': 'Tuesday',
                'Wed': 'Wednesday',
                'Thu': 'Thursday',
                'Fri': 'Friday',
                'Sat': 'Saturday'
            },
            computed:{
                modeDisabled: 'mode=="view"'
            },
            tabSelectedChanged: function (oldV, newV) {
                this.selected.period = newV == 0;
            },
            selected: {},
            observe: {
                'selected.period': 'changeTab',
                'selected.from_time': 'fromTimeUpdated',
                'selected.to_time': 'toTimeUpdated',
            },

            ready: function() {
                this.loadingMoreOlderEvents = false;
                this.loadingMoreNewerEvents = false;
                this.loadingNewerText = 'Please Wait...';
                this.loadingOlderText = 'Please Wait...';
                this.noMoreNewerEvents = false;
                this.noMoreOlderEvents = false;
                this.initialPosition = "right";
                
                var self = this;
                window.onresize = function(event) {
                    self.refresh();
                }

                window.onmousewheel = function(event) {
                    if (self.$.eventList.scrollTop == 0 && event.wheelDelta > 0 && !self.noMoreOlderEvents && !self.loadingMoreOlderEvents) {
                        self.loadMoreOlderEvents();
                    } else if (self.$.eventList.scrollTop + self.$.eventList.clientHeight == self.$.eventList.scrollHeight &&
                        event.wheelDelta < 0 && !self.noMoreNewerEvents && !self.loadingMoreNewerEvents) {
                        self.loadMoreNewerEvents();
                    }
                }
            },

            refresh: function() {
                if (this.mode != 'list' || this.events == null) return;

                this.bottomSpinnerTop = this.$.eventList.clientHeight;// + 55;
                //this.spinnerXOffset = (this.$.container.clientWidth - this.$.eventList.clientWidth) / 2;
                this.events.sort(function(o1, o2) {
                    if (o1.from_time < o2.from_time) return -1;
                    else if (o1.from_time > o2.from_time) return 1;
                    else return 0;
                });

                this.eventGroups = [];

                var position = this.initialPosition;
                for (var i = 0; i < this.events.length; i++) {
                    var event = this.events[i];
                    var len = this.eventGroups.length;
                    var fromDate = new Date(event.from_time);
                    if (len == 0 || this.eventGroups[len - 1].data.date != fromDate.toDateString()) {
                        var newDayGroup = {};
                        newDayGroup.data = {date: fromDate.toDateString()};
                        newDayGroup.length = 1;
                        this.eventGroups.push(newDayGroup);
                        if (position == "left") position = "right";
                        else position = "left";
                    } else {
                        var oldDayGroup = this.eventGroups[len - 1];
                        oldDayGroup.length++;
                    }

                    event.position = position;
                    
                    var now = new Date();
                    var from_time = new Date(event.from_time);
                    var to_time = new Date(event.to_time)

                    if (now < from_time) event.eventStatus = 'normal';
                    else if (now >= from_time && now <= to_time) event.eventStatus = 'active';
                    else if (now > to_time) event.eventStatus = 'expired';

                    if (now.getYear() == from_time.getYear() && now.getMonth() == from_time.getMonth() && now.getDate() == from_time.getDate()) {
                        event.isToday = true;
                    }
                }


                var self = this;
                setTimeout(function() {
                    self.bottomSpinnerTop = self.$.eventList.clientHeight;// + 55;
                }, 100);
            },

            handleEvents: function (event, detail) {
                var self = this;
                this.events = detail.response;
                this.events.forEach(function (event) {
                    self.parseEvent(event);
                });
                this.refresh();
                this.isListLoaded = true;
                
                if (this.events.length > 0)
                    this.range = {min: this.events[0].from_time, max: this.events[this.events.length - 1].from_time};
            },

            handleSingleEvent: function(event, detail) {
                this.selected = detail.response;
                this.parseEvent(this.selected);  
                
                this.$.pages.selected = 1;
                this.mode = 'view';
            },

            handleSingleEventError: function(event, detail) {
                console.log(detail)
                if (detail.xhr.status == 404) {
                    console.log('not found');
                    this.mode = 'view';
                    this.$.pages.selected = 2;
                }
            },

            changeTab: function (oldV, newV) {
                this.tabSelected = newV ? 0 : 1;
                if (newV && !this.selected.to_time) {
                    this.selected.to_time = new Date();
                }
            },

            parseEvent: function(event) {
                var members = {};
                members.users = [];
                members.teams = [];
                event.participants.map(function (p) {
                    members.users.push(p.id);
                });
                event.team_participants.map(function (p) {
                    members.teams.push(p.id);
                });
                event.participants = members;
                if (event.full_day) {
                    var from_date = new Date(event.from_time);
                    var to_date = new Date(event.to_time);

                    from_date.setHours(0);
                    from_date.setMinutes(0);
                    from_date.setSeconds(0);
                    to_date.setHours(23);
                    to_date.setMinutes(59);
                    to_date.setSeconds(59);

                    event.from_time = from_date.toISOString();
                    event.to_time = to_date.toISOString();
                }
                if (event.description == undefined || event.description.length == 0)
                    event.description = ' ';
                if (event.repeated) {
                    if (event.repeated_type == 'Weekly' && event.repeated_on != undefined && event.repeated_on != null) {
                        event.repeated_on = JSON.parse(event.repeated_on);
                    }
                    this.updateSummary(event);
                }
            },

            copyEvent: function(event) {
                var newEvent = {};
                newEvent.from_time = event.from_time.toISOString();
                newEvent.to_time = event.to_time.toISOString();
                newEvent.participants = {};
                newEvent.participants.teams = [];
                newEvent.participants.users = [];
                for (var i = 0; i < event.participants.teams.length; i++)
                    newEvent.participants.teams.push(event.participants.teams[i]);
                for (var i = 0; i < event.participants.users.length; i++)
                    newEvent.participants.users.push(event.participants.users[i]);
                newEvent.full_day = event.full_day;
                newEvent.period = event.period;
                newEvent.title = event.title;
                newEvent.description = event.description;
                newEvent.repeated = event.repeated;
                
                if (newEvent.repeated) {
                    newEvent.repeated_type = event.repeated_type;
                    newEvent.repeated_on = event.repeated_on;
                    newEvent.repeated_by = event.repeated_by;
                    newEvent.repeated_frequency = event.repeated_frequency;
                    newEvent.repeated_end_type = event.repeated_end_type;
                    newEvent.repeated_times = event.repeated_times;
                    newEvent.repeated_end_date = event.repeated_end_date;
                }
                return newEvent;
            },

            to_time: function (date) {
                return moment(date).format('HH:mm');
            },

            select: function (event, detail, target) {
                this.selected = target.templateInstance.model.model;
                
                if (this.selected.description == undefined || this.selected.description.length == 0)
                    this.selected.description = ' ';

                console.log(this.selected)
                var self = this;
                self.$.pages.selected = 1;
                this.mode = 'view';
            },

            main: function () {
                this.$.pages.selected = 0;
                this.mode = 'list';
                if (!this.isListLoaded) {
                    //console.log("hahah")
                    //var router = document.querySelector("app-router");
                    //router.go("/calendar");
                    if (this.eventId != null) this.eventId = null;
                }
            },

            jumpToAdd: function () {
                this.selected = {from_time: new Date(), to_time: new Date(), participants: {}, full_day: false, period: true};
                this.selected.participants.teams = [];
                this.selected.participants.users = [];

                var self = this;
                self.$.pages.selected = 1;
                self.async(
                    function() {
                        self.$.titleInput.focus();
                    }, 
                    null, 200
                );
                this.mode = 'edit';
            },

            saveEvent: function(){
                if (this.selected.title == null || this.selected.title.length == 0) {
                    this.$.titleCannotBeEmpty.show();
                    var self = this;
                    this.async(function() {self.$.titleInput.focus();}, null, 100);
                    return;
                }
                this.eventBody = JSON.stringify(this.copyEvent(this.selected));
                this.$.postEvent.go();
            },

            eventSaved: function(event, detail) {
                this.mode = 'view';

                var newEvent = JSON.parse(detail.response);

                this.parseEvent(newEvent);
                this.events.push(newEvent);
                this.main();
                this.$.eventSavedToast.show();
                this.refresh();

            },

            deleteEvent: function() {
                this.$.confirmDeleteDialog.toggle();
                //this.$.deleteEvent.go();
            },

            doDelete: function() {
                this.$.deleteEvent.go();
            },

            eventDeleted: function(event, detail) {
                console.log(this.selected);
                if (this.events != null) {
                    for (var i = 0; i < this.events.length; i++) {
                        var e = this.events[i];
                        console.log(e);
                        if (e.id == this.selected.id) {
                            this.events.splice(i, 1);
                            break;
                        }
                    }
                }
                
                this.main();
                this.$.eventDeletedToast.show();
                this.refresh();
            },

            loadMoreNewerEvents: function() {
                if (!this.noMoreNewerEvents && 
                    !this.loadingMoreNewerEvents && 
                    !this.loadingMoreOlderEvents && 
                    this.range != undefined) {
                    
                    this.spinnerXOffset = (this.$.container.clientWidth - this.$.eventList.clientWidth) / 2;

                    this.loadingMoreNewerEvents = true;

                    var self = this;
                    self.bottomSpinnerTop = self.$.eventList.clientHeight + 100;
                    setTimeout(function() {
                        self.bottomSpinnerTop = self.$.eventList.clientHeight;
                    }, 0);
                    setTimeout(function() {
                        self.$.getMoreNewerEvents.go();
                    }, 500);
                }
            },

            loadMoreOlderEvents: function() {
                if (!this.noMoreOlderEvents &&
                    !this.loadingMoreNewerEvents && 
                    !this.loadingMoreOlderEvents &&
                    this.range != undefined) {
                    
                    this.spinnerXOffset = (this.$.container.clientWidth - this.$.eventList.clientWidth) / 2;
                    this.loadingMoreOlderEvents = true;

                    var self = this;
                    self.topSpinnerTop = -100;
                    setTimeout(function() {
                        self.topSpinnerTop = -50;
                    }, 0);
                    setTimeout(function() {
                        self.$.getMoreOlderEvents.go();
                    }, 500);
                }
            },

            handleLoadEvents: function(type, event, detail) {
                var self = this;
                var events = detail.response;

                console.log('loaded: ' + events.length)
                if (events.length > 0) {
                    events.forEach(function (event) {
                        self.parseEvent(event);
                    });
                    var newLoadedDates = [];
                    for (var i = 0; i < events.length; i++) {
                        var contain = false;
                        for (var j = 0; j < this.events.length; j++) {
                            if (events[i].id == this.events[j].id) {
                                if (!events[i].repeated || events[i].repeated_number == this.events[j].repeated_number)
                                    contain = true;
                                break;
                            }
                        }
                        if (!contain) {

                            if (events[i].from_time < this.events[0].from_time) {
                                var newFromTime = new Date(events[i].from_time);
                                if (newLoadedDates.indexOf(newFromTime.toDateString()) == -1)
                                    newLoadedDates.push(newFromTime.toDateString());
                            }
                            this.events.push(events[i]);
                        }
                    }

                    if (type == 1) {
                        this.range.max = events[events.length - 1].from_time;
                    } else if (type == 2) {
                        this.range.min = events[0].from_time;
                        if (newLoadedDates.length % 2 != 0) {
                            this.initialPosition = "left";
                        }
                    }

                    this.refresh();
                } else {
                    if (type == 1) {
                        this.noMoreNewerEvents = true;
                    } else if (type == 2) {
                        this.noMoreOlderEvents = true;
                    }
                }


                console.log('after loaded: ' + this.events.length)
                if (type == 1)
                    this.loadingMoreNewerEvents = false;
                else if (type == 2)
                    this.loadingMoreOlderEvents = false;

                if (type == 1)
                    this.$.threshold.clearLower();
                else if (type == 2)
                    this.$.threshold.clearUpper();
                    
            },

            handleLoadNewerEvents: function(event, detail) {
                this.handleLoadEvents(1, event, detail);
            },

            handleLoadOlderEvents: function(event, detail) {
                this.handleLoadEvents(2, event, detail);
            },
            
            /*
             * On add event page, when from time is changed, 
             * to time should be restricted to be larger or equal to from time.
             */
            fromTimeUpdated: function(oldValue, newValue) {
                if (this.mode == 'edit') {
                    if (newValue > this.selected.to_time) {
                        this.selected.to_time = newValue;
                    }
                }
                this.updateSummary(this.selected)
            },

            /*
             * On add event page, when to time is changed, 
             * from time should be restricted to be smaller or equal to to time.
             */
            toTimeUpdated: function(oldValue, newValue) {
                if (this.mode == 'edit') {
                    if (newValue < this.selected.from_time) {
                        this.selected.from_time = newValue;
                    }
                    this.updateSummary(this.selected)
                }
            },

            // Event method for repeat paper-toggle-button
            repeatToggled: function(event, detail, target) {
                if (target.checked) {
                    this.$.repeatEventDialog.toggle();
                    this.selected.repeated = true;

                    // Default repeated type: Daily.
                    if (this.selected.repeated_type == undefined) {
                        this.selected.repeated_type = 'Daily';
                    }

                    // Default repeated end type: Never.
                    if (this.selected.repeated_end_type == undefined) {
                        this.selected.repeated_end_type = 'Never';
                    }

                    // Default repeated times: 10.
                    if (this.selected.repeated_times == undefined) {
                        this.selected.repeated_times = 10;
                    }

                    // Default repeated frequency: 1.
                    if (this.selected.repeated_frequency == undefined) {
                        this.selected.repeated_frequency = 1;
                    }

                    // Default repeated days of a week: 1.
                    if (this.selected.repeated_on == undefined) {
                        this.selected.repeated_on = new Array;
                        var from = new Date(this.selected.from_time);
                        this.selected.repeated_on.push(this.daysInWeek[from.getDay()]); 
                    }

                    // When repeated type is Monthly, event can be repeated by day of month of day of week
                    if (this.selected.repeated_by == undefined) {
                        this.selected.repeated_by = 'Month';
                    }
                }
            },

            //
            cancelRepeatEvent: function(event, detail, target) {
                this.$.repeatToggle.checked = false;
                this.selected.repeated = false;
            },

            // Triggered when repeated type is changed.
            repeatedTypeChange: function(event, detail, target) {
                this.$.repeatedFrequency.focus();
                console.log('Repeated type changed.');
                this.updateSummary(this.selected);
            },

            // Triggered when repeated days of week are changed.
            repeatedDaysOfWeekChange: function(event, detail, target) {
                if (this.selected.repeated_on == undefined || 
                    !(this.selected.repeated_on instanceof Array) || 
                    this.selected.repeated_on.length == 0) {
                    this.selected.repeated_on = new Array;
                    var from = new Date(this.selected.from_time);
                    this.selected.repeated_on.push(this.daysInWeek[from.getDay()]); 
                }

                console.log('Repeated days of week changed.');
                this.updateSummary(this.selected);
            },

            repeatedFrequencyChange: function(event, detail, target) {
                console.log('Repeated frequency changed.');
                this.updateSummary(this.selected);
            },

            // Triggered when repeated day of month changed.
            // When repeated type is monthly, users can decide to repeat by day of month of day of week.
            repeatedDayOfMonthChange: function(event, detail, target) {
                console.log('Repeated day of month changed.');
                this.updateSummary(this.selected);
            },

            repeatedTimesChange: function(event, detail, target) {
                console.log('Repeated times changed.');
                this.updateSummary(this.selected);
            },

            // Event method for repeated end type change
            repeatedEndTypeChange: function(event, detail, target) {
                if (target.selected == 'Occurence') {
                    this.$.repeatedTimes.focus();
                } else if (target.selected == 'Date') {
                    if (this.selected.repeated_end_date == undefined) {
                        var from = new Date(this.selected.from_time);
                        var endDate = new Date(from.getTime() + 2592000000);
                        this.selected.repeated_end_date = endDate;
                    }
                }
                this.updateSummary(this.selected);
            }, 

            updateSummary: function(event) {
                if (!event.repeated) return 'None';
                var summary = "", frequencyOne, frequencyMultiple;
                frequencyOne = event.repeated_type;

                if (event.repeated_type == 'Daily') {
                    frequencyMultiple = 'days';
                } else if (event.repeated_type == 'Weekly') {
                    frequencyMultiple = 'weeks';
                } else if (event.repeated_type == 'Monthly') {
                    frequencyMultiple = 'months'
                } else if (event.repeated_type == 'Yearly') {
                    frequencyMultiple = 'years';
                }

                // Repeat event frequency summary
                if (event.repeated_frequency == 1) {
                    summary += frequencyOne;
                } else if (event.repeated_frequency > 1) {
                    summary += ("Every " + event.repeated_frequency + " " + frequencyMultiple);
                } else {
                    summary += frequencyOne;
                }

                var from = new Date(event.from_time);

                // Repeat event days summary
                if (event.repeated_type == 'Weekly') {
                    summary += ' on ';
                    for (var i = 0; i < event.repeated_on.length; i++) {
                        summary += this.daysInWeekMap[event.repeated_on[i]];
                        if (i != event.repeated_on.length - 1)
                            summary += ', ';
                    }
                } else if (event.repeated_type == 'Monthly') {
                    summary += ' on ';
                    if (event.repeated_by == 'Month') {
                        summary += ' day ' + from.getDate();
                    } else if (event.repeated_by == 'Week') {
                        summary += ' the ';
                        var weekOfMonth = from.weekOfMonth();

                        if (weekOfMonth == 1) {
                            summary += ' first ';
                        } else if (weekOfMonth == 2) {
                            summary += ' second ';
                        } else if (weekOfMonth == 3) {
                            summary += ' third ';
                        } else if (weekOfMonth == 4) {
                            summary += ' fourth ';
                        } else if (weekOfMonth == 5) {
                            summary += ' fifth ';
                        }

                        summary += this.daysInWeekMap[this.daysInWeek[from.getDay()]];
                    }
                } else if (event.repeated_type == 'Yearly') {
                    summary += ' on ' + this.months[from.getMonth()] + ' ' + from.getDate();
                }

                // Repeat event ends way summary
                if (event.repeated_end_type == 'Occurence') {
                    if (isNaN(event.repeated_times)) event.repeated_times = 1;
                    else event.repeated_times = Math.floor(event.repeated_times);

                    summary += ", " + event.repeated_times + " times";
                } else if (event.repeated_end_type == 'Date') {
                    summary += ", until " + event.repeated_end_date.toDateString();
                }
                event.summary = summary;
            }
            
        });
    </script>
</polymer-element>

<polymer-element name="calendar-plugin" attributes="eventId">
    <template>
        <core-style ref="theme"></core-style>
        <style>

        </style>
        <home-container>
            <schedule-list eventId="{{eventId}}"></schedule-list>
        </home-container>
    </template>
    <script>
        Polymer({
        });
    </script>
</polymer-element>