<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-autogrow-textarea.html">
<link rel="import" href="../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../bower_components/polymer-filters/polymer-filters.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../home-container.html">
<link rel="import" href="../../elements/member-select/member-select.html">
<link rel="import" href="../../elements/datetime-input/datetime-input.html">
<link rel="import" href="../../elements/smart-editor/smart-display.html">
<link rel="import" href="../../elements/smart-editor/smart-editor.html">
<link rel="import" href="../../elements/smart-time-display/smart-time-display.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/core-pages/core-pages.html">
<link rel="import" href="../../bower_components/core-style/core-style.html">
<link rel="import" href="../../bower_components/core-scroll-threshold/core-scroll-threshold.html">
<link rel="import" href="../../bower_components/core-animated-pages/transitions/slide-up.html">
<link rel="import" href="../../bower_components/core-list/core-list.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">

<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>

<core-style id="calendar">
    paper-tabs::shadow #selectionBar{
        background-color: {{g.theme.accentBgColor}};
    }

    paper-tabs paper-tab::shadow #ink {
        color: {{g.theme.accentBgColor}};
    }

    paper-toggle-button::shadow [checked] .toggle{
        background-color: {{g.theme.accentBgColor}};
    }

    paper-toggle-button::shadow [checked] .toggle-ink {
        color: {{g.theme.accentBgColor}};
    }

    :host {
        background-color: white;
    }

    div#emptyNotification {
        color: #555;
        text-align: center;
        font-family: 'Open Sans', san-serif;
        font-size: 2em;
    }

    div.container {
        display: block;
        padding: 45px 0;      
        width: 100%;
        height: 100%;  
        overflow-y: auto;
        overflow-x: hidden;
    }
    
    .loading {
        position: absolute;
        text-align: center;
        padding: 10px 0px;
        font-family: 'Open Sans', san-serif;
        font-size: 16px;
        color: #666;
        left: 0;
        right: 0;
    }

    .top-loading {
        top: 0;
    }

    .bottom-loading {
        bottom: 0;
    }

    core-list {
        overflow-y: visible;
    }
    
    .content {
        margin-left: 40px;
    }

    .block {
        position: relative;
        cursor: pointer;
    }

    .listitem {
        *position: relative !important;
        padding: 2em 0;
    }

    .time {
        margin-top: 4px;
    }

    p.description {
        margin-bottom: 0;
    }

    div.detail {
        padding: 60px 80px;
        overflow-y: auto;
    }

    .main-button {
        position: absolute;
        top: 64px;
        left: 16px;
        z-index: 10;
    }

    .tabs, .pages, .fullday {
        max-width: 320px;
    }

    .fullday {
        margin: 1em 0;
    }

    .block {
        z-index: 4;
    }

    .event-wrapper {
        position: absolute;
        border-radius: 50%;
        padding: 5px;
        margin-top: -5px;
        margin-left: -5px;
        background-color: {{g.theme.thirdBgColor}};
    }

    .event {    
        border-radius: 50%;
        padding: 8px;
        color: {{g.theme.mainColor}};
    }

    .block:hover .event-wrapper {
        padding: 0px;
    }

    .block:hover .event {
        padding: 13px;
    }

    .event.normal {
        background-color: {{g.theme.mainBgColor}};
    }

    .event.expired {
        background-color: grey;
    }

    .event.active {
        background-color: {{g.theme.accentBgColor}};
    }

    time-input.upper {
        margin-top: -35px;
    }

    date-input {
        z-index: 1;
    }

    #title {
        font-size: 25px;
    }

    .page.core-selected {
        position: relative;
        display: block;
    }

    paper-fab {
        position: absolute;
        left: 16px;
        top: -20px;
        z-index: 1;
    }

    .list {
        *margin-top: 20px;
    }

    .subTitle {
        font-size: 21px;
        margin-left: 90px;
        padding-bottom: 10px;
    }

    paper-fab {
        position: absolute;
        top: 24px;
    }

    .wrapper {
        padding-bottom: 20px;
    }

    * {
        -webkit-box-sizing: border-box;
                box-sizing: border-box;
    }

    .listitem::before,
    .dayDivider::before {
        content: '';
        position: absolute;
        top: 0;
        left: 18px;
        height: 100%;
        width: 6px;
        z-index: 3;
        background-color: {{g.theme.thirdBgColor}};
    }

    .dayDivider::first-child {
        background: black;
    }

    .dayDivider {
        position: relative;
        clear: both;
        width: 100%;
        margin: 0em auto;
        margin-bottom: 2em;
        line-height: 1.2em;
    }

    .dayDivider .dayDividerLabel {
        position: relative;
        margin-left: 78px;
        display: inline-block;
    }

    .dayDivider .dayDividerLabel.today {
        color: rgba(240, 10, 10, .8);
    }

    .dayDivider .dayDividerLabel hr {
        position: absolute;
        *top: 2px;   
        top: 50%;
        left: -60px;
        right: 0px;
        border: 0;
        margin: 0;
        margin-top: -2px;
        border-top: 2px solid #bbb;

        z-index: 1;
    }

    .dayDivider .dayDividerLabel .dayDividerLabelContent {
        position: relative;
        *display: inline-block;
        color: #555459;
        font-family: 'Lato', san-serif;
        font-weight: 900;
        font-size: 1.0em;
        margin: 0 auto;
        padding: 0 2px;
        background: white;
        z-index: 2;
    }

    .time {
        font-size: 90%;
    }

    .time,
    .event-title {
        margin: 0;
        border: 0;
        margin-left: 22px;
        padding-left: 16px;
        border-left: 4px solid transparent;
    }

    .event-title {
        font-size: 1.0em;
        font-family: Lato, san-serif;
        padding-bottom: 6px;
    }

    .block:hover .time,
    .block:hover .event-title {
        *border-left: 4px solid {{g.theme.mainBgColor}};
        *background-color: {{g.theme.thirdBgColor}};
        *transition: opacity ease-in 0.2s
    }

    .message {
        text-align: center;
        color: rgba(0, 0, 0, .8);
        font-size: 24px;
        font-weight: 600;
        margin-top: 10%;

        font-family: 'Open Sans';
    }

    .spinner {
        z-index: 1;
        position: absolute;
        border-radius: 50%;
        background-color: white;
        left: 50%;
        margin-left: -25px;
        width: 50px;
        height: 50px;
    }
    
    core-list {
        padding-left: 16px;
    }

    .badge {
        background-color: {{g.theme.accentBgColor}};
        color: white;
        border-radius: 2px;
        font-size: 11px;
        padding: 2px 6px;
        margin: 0 6px;
        box-sizing: border-box;
    }

    smart-editor /deep/ paper-input-decorator {
        padding: 0;
    }

    .floated-label {
        font-size: 0.75em;
        white-space: no-wrap;
        background: transparent;
    }

    .label-text {
        color: #757575;
    }

    .floated-content {
        margin: 0.5em 0 0.25em;
        padding: 0.25em 0;
        border-bottom: 1px dashed #757575;
    }

    @media screen and (min-width: 960px) {
        core-list {
            padding-left: 0px;
        }

        .event-wrapper {
            position: absolute;
            left: 50%;
            margin-left: -25px;
            margin-top: -5px;
        }

        .listitem::before,
        .dayDivider::before {
            left: 50%;
            margin-left: -3px;
        }

          
        .dayDivider .dayDividerLabel.left {
            width: 50%;
            text-align: right;
            margin-left: 0;
            padding-right: 78px;
        }

        .dayDivider .dayDividerLabel.right {
            width: 50%;
            text-align: left;
            margin-left: 50%;
            padding-left: 78px;
        }

        .dayDivider .dayDividerLabel hr {
            left: 0;
        }

        .block .content {
            display: inline-block;
            width: 50%;
        }

        .block .content.left {
            margin-left: 0px;
            padding-right: 78px;
            text-align: right;
        }

        .block .content.right {
            margin-left: 50%;
            padding-left: 78px;
            text-align: left;
        }

        .block .content.left > .time,
        .block .content.left > .event-title {
            margin:0;
            border: 0;
            padding-right: 6px;
            border-right: 4px solid transparent;
        }

        .time,
        .event-title {
            margin-left: 0px;
            padding-left: 0px;
        }

    }
</core-style>

<polymer-element name="schedule-list" attributes="eventId">
    <template>
        <core-style ref="theme"></core-style>
        <core-style ref="calendar"></core-style>

        <style>
            div.timeline {
                position: relative;
                padding: 10px 0px;
                min-height: {{(events == null || events.length == 0) ? 100 : 120}}%;
                display: block;
            }

            .bottom-spinner {
                top: {{bottomSpinnerTop}}px;
                -webkit-transition: top 0.3s linear;
            }

            .top-spinner {
                top: -45px;
                -webkit-transition: top 0.3s linear;
            }

        </style>

        <div layout vertical fit>
            <div class="mainColor wrapper">
                <template if="{{mode=='list' && eventId == null}}">
                    <paper-fab mini icon="add" class="accentColor" on-tap="{{jumpToAdd}}"></paper-fab>
                </template>
                <template if="{{mode=='edit'}}">
                    <paper-fab mini icon="done" class="accentColor" on-tap="{{saveEvent}}"></paper-fab>
                </template>
                <template if="{{mode=='view' && selected.creator_id == $.globals.values.currentUser.id}}">
                    <paper-fab mini icon="remove" class="accentColor" on-tap="{{deleteEvent}}"></paper-fab>
                </template>
                <span class="subTitle">Schedule</span>
            </div>
            <div flex vertical layout class="list">
                <core-animated-pages selected="0" transitions="cross-fade-all" id="pages" flex>
                    <section>
                        <core-scroll-threshold id="threshold" 
                            scrolltarget="{{$.container}}" 
                            lowerthreshold="30" 
                            on-lower-trigger="{{ loadMoreNewerEvents }}"
                            upperThreshold="30" 
                            on-upper-trigger="{{ loadMoreOlderEvents }}">
                        </core-scroll-threshold>
                        
                        <div class="container" id="container">
                            <div id="emptyNotification" hidden?="{{events == null || events.length != 0}}">Empty Calendar</div>
                            <div class="timeline" vertical layout hidden?="{{events == null || events.length == 0}}">
                                <paper-shadow layered class="spinner top-spinner" layout center-center horizontal hidden?="{{!loadingMoreOlderEvents}}">
                                    <paper-spinner active></paper-spinner>
                                </paper-shadow>
                                <div class="loading top-spinner" hidden?="{{!noMoreOlderEvents}}">No more events.</div>
                                
                                <core-list id="eventList" data="{{events}}" groups="{{eventGroups}}" flex style="overflow-y:visible !important;">
                                    <template>
                                        <div divider class="dayDivider">
                                            <div class="dayDividerLabel {{model.position}} {{model.today}}">
                                                <hr/>
                                                <div class="dayDividerLabelContent">
                                                    <span>{{groupModel.date}}</span>
                                                    <template if="{{model.isToday}}">
                                                        <span class="badge">Today</span>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="listitem">
                                            <div layout horizontal class="block" center on-tap="{{select}}">
                                                
                                                <div class="event-wrapper">
                                                
                                                <div class="event {{model.eventStatus}}">
                                                    <core-icon icon="event"></core-icon>
                                                </div>
                                                </div>
                                                <div hero hero-id="{{event.id}}" vertical layout class="content {{model.position}}">
                                                    <div class="event-title">{{model.title}}</div>
                                                    <div class="time iconColor">
                                                        <smart-time-display 
                                                            from="{{model.from_time}}" 
                                                            to="{{model.to_time}}"
                                                            period="{{model.period}}"
                                                            full_day="{{model.full_day}}"
                                                            with_message="{{true}}"
                                                            threshold="{{86400000}}">
                                                        </smart-time-display>
                                                    </div>
                                                </div>
                                                <!--
                                                <div class="info">
                                                    <core-icon icon="info" class="iconColor"></core-icon>
                                                </div>
                                                <paper-ripple fit></paper-ripple>
                                                -->
                                            </div>
                                        </div>
                                    </template>
                                </core-list>

                                <paper-shadow layered class="spinner bottom-spinner" layout center-center horizontal hidden?="{{!loadingMoreNewerEvents}}">
                                    <paper-spinner active></paper-spinner>
                                </paper-shadow>
                                
                                <div class="loading bottom-spinner" hidden?="{{!noMoreNewerEvents}}">No more events.</div>
                            </div>
                            
                        </div>

                    </section>
                    <section>

                        <!-- Confirmation dialog for event deletion. -->
                        <paper-action-dialog backdrop autoCloseDisabled heading="Sure to delete this event?" layered="false" id="confirmDeleteDialog">
                            <paper-button dismissive>Cancel</paper-button>
                            <paper-button affirmative on-tap="{{doDelete}}">Delete</paper-button>
                        </paper-action-dialog>

                        <paper-icon-button icon="arrow-back" class="main-button"
                                           on-tap="{{main}}"></paper-icon-button>
                        <div hero hero-id="{{selected.id}}" class="detail" vertical layout fit slide-up>
                            <div class="detail-content" vertical layout>
                                <div>
                                    <paper-input-decorator label="Title" floatingLabel id="title"
                                                           disabled="{{modeDisabled}}" placeholder="">
                                        <template if="{{!modeDisabled}}">
                                            <input is="core-input" id="titleInput" value="{{selected.title}}">
                                        </template>
                                        <template if="{{modeDisabled}}">
                                            <span>{{selected.title}}</span>
                                        </template>
                                    </paper-input-decorator>

                                    <template if="{{mode == 'edit'}}">
                                        <smart-editor id="textArea" label="Description" value="{{selected.description}}" floatingLabel underline disabled>
                                        </smart-editor>
                                    </template>
                                    <template if="{{mode == 'view'}}">
                                        <div class="floated-label">
                                            <span class="label-text">Description</span>
                                        </div>  
                                        <div class="floated-content">
                                            <smart-display value="{{selected.description}}"></smart-display>
                                        </div>
                                    </template>

                                    <template if="{{!modeDisabled}}">
                                        <div center horizontal layout class="fullday">
                                            <div flex>Full Day</div>
                                            <paper-toggle-button checked="{{selected.full_day}}"
                                                                 disabled="{{modeDisabled}}"></paper-toggle-button>
                                        </div>
                                        <paper-tabs selected="{{tabSelected}}" class="tabs">
                                            <paper-tab>Period</paper-tab>
                                            <paper-tab>Point</paper-tab>
                                        </paper-tabs>
                                    </template>
                                    <core-pages selected="{{tabSelected}}" class="pages">
                                        <div class="page">
                                            <div layout horizontal justified end>
                                                <div layout vertical>
                                                    <date-input label="From" disabled="{{modeDisabled}}"
                                                                date="{{selected.from_time}}"></date-input>
                                                    <template if="{{!selected.full_day}}">
                                                        <time-input class="upper"
                                                                    disabled="{{modeDisabled}}"
                                                                    time="{{selected.from_time}}"></time-input>
                                                    </template>
                                                </div>
                                                <div layout vertical>
                                                    <date-input label="To" disabled="{{modeDisabled}}"
                                                                date="{{selected.to_time}}"></date-input>
                                                    <template if="{{!selected.full_day}}">
                                                        <time-input class="upper"
                                                                    disabled="{{modeDisabled}}"
                                                                    time="{{selected.to_time}}"></time-input>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="page">
                                            <div layout horizontal justified end>
                                                <date-input label="Date" disabled="{{modeDisabled}}"
                                                            date="{{selected.from_time}}"></date-input>
                                                <template if="{{!selected.full_day}}">
                                                    <time-input label="Time" disabled="{{modeDisabled}}"
                                                                time="{{selected.from_time}}"></time-input>
                                                </template>
                                            </div>
                                        </div>
                                    </core-pages>
                                    <member-select teamsUrl="/platform/teams_users"
                                                   disabled="{{modeDisabled}}"
                                                   selected="{{selected.participants}}"
                                                   label="Participants"
                                                   adaptive></member-select>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section>
                        <div class="message">Event not found, back to <a href="#/calendar">calendar</a>.</div>
                    </section>
                </core-animated-pages>
            </div>
        </div>
        <app-globals id="globals"></app-globals>
        <template if="{{eventId == null}}">
            <core-ajax
                auto
                id="getEvents"
                url="/platform/events"
                handleAs="json"
                on-core-response="{{handleEvents}}">
            </core-ajax>
        </template>
        
        <template if="{{eventId != null}}">
            <core-ajax
                    auto
                    url="/platform/events/{{eventId}}"
                    handleAs="json"
                    on-core-error="{{handleSingleEventError}}"
                    on-core-response="{{handleSingleEvent}}">
            </core-ajax>
        </template>

        <core-ajax
                id="getMoreNewerEvents"
                url="/platform/events/after/{{range.max}}"
                handleAs="json"
                on-core-response="{{handleLoadNewerEvents}}"></core-ajax>
        <core-ajax
                id="getMoreOlderEvents"
                url="/platform/events/before/{{range.min}}"
                handleAs="json"
                on-core-response="{{handleLoadOlderEvents}}"></core-ajax>

        <core-ajax id="postEvent"
                   url="/platform/events"
                   method="POST"
                   body="{{eventBody}}"
                   contentType="application/json"
                   on-core-response="{{eventSaved}}"
                >
        </core-ajax>
        <core-ajax id="deleteEvent"
                   url="/platform/events/{{selected.id}}"
                   method="DELETE"
                   on-core-response="{{eventDeleted}}"
                >
        </core-ajax>

        <paper-toast id="titleCannotBeEmpty" text="Please enter the event's title."></paper-toast>
        <paper-toast id="eventSavedToast" text="Event has been saved!"></paper-toast>
        <paper-toast id="eventDeletedToast" text="Event has been deleted!"></paper-toast>
    </template>
    <script src="../../bower_components/moment/moment.js"></script>
    <script>
        Polymer({
            mode: "list",
            isListLoaded: false,
            computed:{
                modeDisabled: 'mode=="view"'
            },
            tabSelectedChanged: function (oldV, newV) {
                this.selected.period = newV == 0;
            },
            selected: {},
            observe: {
                'selected.period': 'changeTab',
                'selected.from_time': 'fromTimeUpdated',
                'selected.to_time': 'toTimeUpdated',
            },
            ready: function() {
                this.loadingMoreOlderEvents = false;
                this.loadingMoreNewerEvents = false;
                this.loadingNewerText = 'Please Wait...';
                this.loadingOlderText = 'Please Wait...';
                this.noMoreNewerEvents = false;
                this.noMoreOlderEvents = false;
                var self = this;
                window.onresize = function(event) {
                    self.refresh();
                }

                window.onmousewheel = function(event) {
                    if (self.$.container.scrollTop == 0 && event.wheelDelta > 0 && !self.noMoreOlderEvents && !self.loadingMoreOlderEvents) {
                        self.loadMoreOlderEvents();
                    }
                }
            },

            refresh: function() {
                if (this.mode != 'list' || this.events == null) return;

                this.bottomSpinnerTop = -45 + this.$.eventList.scrollHeight + 55;
                this.events.sort(function(o1, o2) {
                    if (o1.from_time < o2.from_time) return -1;
                    else if (o1.from_time > o2.from_time) return 1;
                    else return 0;
                });

                this.eventGroups = [];

                var position = "right";
                for (var i = 0; i < this.events.length; i++) {
                    var event = this.events[i];
                    var len = this.eventGroups.length;
                    var fromDate = new Date(event.from_time);
                    if (len == 0 || this.eventGroups[len - 1].data.date != fromDate.toDateString()) {
                        var newDayGroup = {};
                        newDayGroup.data = {date: fromDate.toDateString()};
                        newDayGroup.length = 1;
                        this.eventGroups.push(newDayGroup);
                        if (position == "left") position = "right";
                        else position = "left";
                    } else {
                        var oldDayGroup = this.eventGroups[len - 1];
                        oldDayGroup.length++;
                    }

                    event.position = position;
                    
                    var now = new Date();
                    var from_time = new Date(event.from_time);
                    var to_time = new Date(event.to_time)

                    if (now < from_time) event.eventStatus = 'normal';
                    else if (now >= from_time && now <= to_time) event.eventStatus = 'active';
                    else if (now > to_time) event.eventStatus = 'expired';

                    if (now.getYear() == from_time.getYear() && now.getMonth() == from_time.getMonth() && now.getDate() == from_time.getDate()) {
                        event.isToday = true;
                    }
                }


                var self = this;
                setTimeout(function() {
                    self.bottomSpinnerTop = -45 + self.$.eventList.scrollHeight + 55;
                }, 100);
            },
            handleEvents: function (event, detail) {
                var self = this;
                this.events = detail.response;
                this.events.forEach(function (event) {
                    self.parseEvent(event);
                });
                this.refresh();
                this.isListLoaded = true;
                
                if (this.events.length > 0)
                    this.range = {min: this.events[0].from_time, max: this.events[this.events.length - 1].from_time};
            },
            handleSingleEvent: function(event, detail) {
                this.selected = detail.response;
                this.parseEvent(this.selected);  
                var self = this;
                setTimeout(function () {
                    // self.$.autogrowArea.update(self.$.textArea);
                    // self.$.decorator.updateLabelVisibility(self.$.textArea.value);
                    self.$.pages.selected = 1;
                }, 100);
                this.mode = 'view';
            },
            handleSingleEventError: function(event, detail) {
                console.log(detail)
                if (detail.xhr.status == 404) {
                    console.log('not found');
                    this.mode = 'view';
                    this.$.pages.selected = 2;
                }
            },
            changeTab: function (oldV, newV) {
                this.tabSelected = newV ? 0 : 1;
                if (newV && !this.selected.to_time) {
                    this.selected.to_time = new Date();
                }
            },
            parseEvent: function(event) {
                var members = {};
                members.users = [];
                members.teams = [];
                event.participants.map(function (p) {
                    members.users.push(p.id);
                });
                event.team_participants.map(function (p) {
                    members.teams.push(p.id);
                });
                event.participants = members;
                if (event.full_day) {
                    var from_date = new Date(event.from_time);
                    var to_date = new Date(event.to_time);

                    from_date.setHours(0);
                    from_date.setMinutes(0);
                    from_date.setSeconds(0);
                    to_date.setHours(23);
                    to_date.setMinutes(59);
                    to_date.setSeconds(59);

                    event.from_time = from_date.toISOString();
                    event.to_time = to_date.toISOString();
                }
            },
            copyEvent: function(event) {
                var newEvent = {};
                newEvent.from_time = event.from_time.toISOString();
                newEvent.to_time = event.to_time.toISOString();
                newEvent.participants = {};
                newEvent.participants.teams = [];
                newEvent.participants.users = [];
                for (var i = 0; i < event.participants.teams.length; i++)
                    newEvent.participants.teams.push(event.participants.teams[i]);
                for (var i = 0; i < event.participants.users.length; i++)
                    newEvent.participants.users.push(event.participants.users[i]);
                newEvent.full_day = event.full_day;
                newEvent.period = event.period;
                newEvent.title = event.title;
                newEvent.description = event.description;
                return newEvent;
            },
            to_time: function (date) {
                return moment(date).format('HH:mm');
            },
            select: function (event, detail, target) {
                this.selected = target.templateInstance.model.model;
                //this.selected.selected = {};
                //this.selected.selected.users = this.selected.participants;
                //this.selected.selected.teams = [];
                //console.log(this.selected);
                var self = this;
                setTimeout(function () {
                    // self.$.autogrowArea.update(self.$.textArea);
                    // self.$.decorator.updateLabelVisibility(self.$.textArea.value);
                    self.$.pages.selected = 1;
                }, 100);
                this.mode = 'view';
            },
            main: function () {
                this.$.pages.selected = 0;
                this.mode = 'list';
                if (!this.isListLoaded) {
                    //console.log("hahah")
                    //var router = document.querySelector("app-router");
                    //router.go("/calendar");
                    if (this.eventId != null) this.eventId = null;
                }
            },
            jumpToAdd: function () {
                this.selected = {from_time: new Date(), to_time: new Date(), participants: {}, full_day: false, period: true};
                this.selected.participants.teams = [];
                this.selected.participants.users = [];
                //this.selected.selected = {};
                //this.selected.selected.teams = [];
                //this.selected.selected.users = [];
                var self = this;
                setTimeout(function () {
                    //self.$.autogrowArea.update(self.$.textArea);
                    //self.$.decorator.updateLabelVisibility(self.$.textArea.value);
                    self.$.pages.selected = 1;
                }, 100);
                this.mode = 'edit';
            },
            saveEvent: function(){
                if (this.selected.title == null || this.selected.title.length == 0) {
                    this.$.titleCannotBeEmpty.show();
                    var self = this;
                    setTimeout(function() {self.$.titleInput.focus();}, 100);
                    return;
                }
                this.eventBody = JSON.stringify(this.copyEvent(this.selected));
                this.$.postEvent.go();
            },
            eventSaved: function(event, detail) {
                this.mode = 'view';

                var newEvent = JSON.parse(detail.response);

                this.parseEvent(newEvent);
                this.events.push(newEvent);
                this.main();
                this.$.eventSavedToast.show();
                this.refresh();

            },
            deleteEvent: function() {
                this.$.confirmDeleteDialog.toggle();
                //this.$.deleteEvent.go();
            },
            doDelete: function() {
                this.$.deleteEvent.go();
            },
            eventDeleted: function(event, detail) {
                console.log(this.selected);
                if (this.events != null) {
                    for (var i = 0; i < this.events.length; i++) {
                        var e = this.events[i];
                        console.log(e);
                        if (e.id == this.selected.id) {
                            this.events.splice(i, 1);
                            break;
                        }
                    }
                }
                
                this.main();
                this.$.eventDeletedToast.show();
                this.refresh();
            },
            loadMoreNewerEvents: function() {
                if (!this.noMoreNewerEvents && this.range != undefined) {
                    this.loadingMoreNewerEvents = true;
                    this.$.getMoreNewerEvents.go();
                }

                /*
                if (!this.noMoreNewerEvents) {
                } else {
                    var self = this;
                    setTimeout(function() {
                        self.loadingMoreNewerEvents = false;
                    }, 1000);
                }*/
            },
            loadMoreOlderEvents: function() {
                if (!this.noMoreOlderEvents && this.range != undefined) {
                    this.loadingMoreOlderEvents = true;
                    this.$.getMoreOlderEvents.go();
                }
                /*
                if (!this.noMoreOlderEvents) {
                } else {
                    var self = this;
                    setTimeout(function() {
                        self.loadingMoreOlderEvents = false;
                    }, 1000);
                }*/
            },
            handleLoadEvents: function(type, event, detail) {
                var self = this;
                var events = detail.response;
                console.log(events);
                if (events.length > 0) {
                    events.forEach(function (event) {
                        self.parseEvent(event);
                    });
                    for (var i = 0; i < events.length; i++) {
                        var contain = false;
                        for (var j = 0; j < this.events.length; j++) {
                            if (events[i].id == this.events[j].id) {
                                contain = true;
                                break;
                            }
                        }
                        if (!contain)
                           this.events.push(events[i]);
                    }

                    if (type == 1)
                        this.range.max = events[events.length - 1].from_time;
                    else if (type == 2)
                        this.range.min = events[0].from_time;
                    console.log(this.range)
                    this.refresh();
                } else {
                    if (type == 1) {
                        this.noMoreNewerEvents = true;
                    } else if (type == 2) {
                        this.noMoreOlderEvents = true;
                    }
                }

                if (type == 1)
                    this.loadingMoreNewerEvents = false;
                else if (type == 2)
                    this.loadingMoreOlderEvents = false;

                if (type == 1)
                    this.$.threshold.clearLower();
                else if (type == 2)
                    this.$.threshold.clearUpper();
                    
            },
            handleLoadNewerEvents: function(event, detail) {
                this.handleLoadEvents(1, event, detail);
            },
            handleLoadOlderEvents: function(event, detail) {
                this.handleLoadEvents(2, event, detail);
            },
            fromTimeUpdated: function(oldValue, newValue) {
                if (this.mode == 'edit') {
                    if (newValue > this.selected.to_time) {
                        this.selected.to_time = newValue;
                    }
                }
            },
            toTimeUpdated: function(oldValue, newValue) {
                if (this.mode == 'edit') {
                    if (newValue < this.selected.from_time) {
                        this.selected.from_time = newValue;
                    }
                }
            }
        });
    </script>
</polymer-element>

<polymer-element name="calendar-plugin" attributes="eventId">
    <template>
        <core-style ref="theme"></core-style>
        <style>

        </style>
        <home-container>
            <schedule-list eventId="{{eventId}}"></schedule-list>
        </home-container>
    </template>
    <script>
        Polymer({
        });
    </script>
</polymer-element>