<link rel="import" href="vote-content.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">

<polymer-element name="vote-launcher" attributes="vote_id">
    <template>
        <core-ajax
                id="ajaxAns"
                url="/platform/votes/{{vote_id}}/questions"
                handleAs="json"
                on-core-response="{{questionResponse}}"></core-ajax>
        <core-ajax
                id="ajaxAnsUsers"
                url="/platform/votes/{{vote_id}}/users"
                handleAs="json"
                on-core-response="{{userResponse}}"></core-ajax>
        <a on-click="{{showVote}}"><content></content></a>


        <vote-content id="voteContent" votes="{{votes}}" users="{{users}}" vote_id="{{vote_id}}"></vote-content>


    </template>
    <script>
        Polymer("vote-launcher", {

            showVote : function(e) {
                var ajax = this.$.ajaxAns;
                ajax.go();
                var ajaxUser = this.$.ajaxAnsUsers;
                ajaxUser.go();
                var content = this.$.voteContent;
                var dialog = content.shadowRoot.querySelector("#voteAnsDialog");
                if (!dialog) {
                    return;
                }
                dialog.toggle();
            },

            questionResponse: function(event, response) {
                this.votes = [];
                for (item in response.response) {
                    var vote = {};
                    vote.description = response.response[item].description;
                    vote.options = JSON.parse(response.response[item].options);
                    this.votes.push(vote);
                }
            },

            userResponse: function(event, response) {
                this.users = {};
                this.users.voted = [];
                this.users.notVoted = [];
                for (item in response.response) {
                    var element = response.response[item];
                    if (element.finished) {
                        this.users.voted.push(element.user);
                    } else {
                        this.users.notVoted.push(element.user);
                    }
                }
                console.log(JSON.stringify(this.users));
            }
        })
    </script>
</polymer-element>