<link rel="import" href="vote-element.html">
<link rel="import" href="vote-launcher.html">
<link rel="import" href="../../home-container.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-action-dialog.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">

<polymer-element name="vote-plugin">
    <template>
        <style type="text/css">
            paper-fab.blue {
                background: #5677fc;
            }

            paper-action-dialog::shadow #scroller {
                width : 800;
                height : 600
            }
            #voteCreateDialog {
                width: 600px;
            }

            paper-input {
                width: 100%;
            }
        </style>
        <home-container>
            <core-ajax
                    auto
                    url="/platform/votes"
                    handleAs="json"
                    response="{{records}}"></core-ajax>
            <div class="title">Vote Manager</div>
            <paper-fab mini icon="add" class="blue" on-tap="{{createNew}}"></paper-fab>

            <div>
                <h3>You are invited to following votes</h3>
                <div>
                    <ul>
                        <template repeat="{{record in records}}">
                            <li><vote-launcher vote_id="{{record.id}}">{{record.title}}</vote-launcher></li>
                        </template>
                    </ul>
                </div>
            </div>

            <paper-action-dialog id="voteCreateDialog" heading="New Vote" class="scrolling" role="dialog" backdrop="" autoclosedisabled="" layered="false" layout="" vertical="" aria-label="Title" tabindex="-1" style="position: fixed; outline: none; display: none;">

                <core-ajax
                        id="ajaxCreate"
                        method="post"
                        url="/platform/votes"
                        contentType="application/json"
                        body="{{voteJson}}"
                        handleAs="json"
                        on-core-response="{{createResponse}}"></core-ajax>
                <core-ajax
                        id="ajaxDashboard"
                        method="post"
                        contentType="application/json"
                        body="{{dashboard_content}}"
                        url="/platform/users/{{target_user}}/dashboard_records"></core-ajax>
                <div><paper-input floatingLabel label="Title" value="{{newVote.title}}"></paper-input></div>
                <div><paper-input floatingLabel label="Description" value="{{newVote.description}}"></paper-input></div>

                <div horizontal layout center><div><strong style="font-size: larger">Options</strong></div><div><paper-icon-button on-click="{{addOption}}" icon="add-circle" style="color: #32cd32;"></paper-icon-button></div></div>
                <template repeat="{{option, index in newVote.options}}">
                    <div horizontal layout center><div><paper-icon-button on-click="{{removeOption}}" icon="remove-circle" style="color: red;"></paper-icon-button></div><div flex><paper-input value="{{option.value}}"></paper-input></div></div>
                </template>

                <paper-button id="cancelButton" affirmative="" role="button" tabindex="0">Cancel</paper-button>
                <paper-button affirmative="" autofocus="" role="button" tabindex="0" on-tap="{{saveVote}}" style="color: dodgerblue">Create</paper-button>

            </paper-action-dialog>

        </home-container>
    </template>
    <script>

        Polymer('vote-plugin', {
            ready : function() {
                // TODO user real user id
                this.user_id = 1;
                this.selectedUser = [1,2,3];
            },
            addOption: function(){
                this.newVote.options.push({value: ''});
            },
            removeOption: function(event, detail, target){
                this.newVote.options.splice(target.templateInstance.model.index, 1);
            },
            createNew : function() {
                this.newVote = {};
                this.newVote.options = [];
                this.newVote.options.push({value: ''});
                this.newVote.options.push({value: ''});
                var dialog = this.$.voteCreateDialog;
                if (!dialog) {
                    return;
                }
                dialog.toggle();
            },

            newOption : function() {
                var br =  document.createElement('br');
                var option = document.createElement('paper-input');
                option.setAttribute('label', 'Option');
                option.setAttribute('class', 'voteOption');
                option.setAttribute('floatinglabel', '');
                var dialog = this.$.voteCreateDialog;
                var cancelButton = this.$.cancelButton;
                dialog.insertBefore(option, cancelButton);
                dialog.insertBefore(br, option);
            },

            saveVote : function() {
                var options = [];
                for (option in this.newVote.options) {
                    options.push(this.newVote.options[option]["value"]);
                }
                this.newVote.options = JSON.stringify(options);
                this.newVote.user = JSON.stringify(this.selectedUser);
                console.log(JSON.stringify(this.newVote));
                this.voteJson = JSON.stringify(this.newVote);
                var ajax = this.$.ajaxCreate;
                ajax.go();
            },

            createResponse: function(event, response) {
                var res = response.response;
                this.target_user = 1;
                this.dashboard_content = "{\"content\":\"<vote-launcher vote_id=\\\"" + res["id"] + "\\\">" + res["title"] + "</vote-launcher>\"}";
                var ajaxDashboard = this.$.ajaxDashboard;
                ajaxDashboard.go();
            }
        });

    </script>
</polymer-element>